webpackJsonpH5PlayerLib([2],{156:function(e,t,r){"use strict";(function(r){var n,i,a,o,s,l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};s=function(){return function e(t,r,n){function i(s,l){if(!r[s]){if(!t[s]){if(!l&&("function"==typeof o&&o))return o(s,!0);if(a)return a(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var u=r[s]={exports:{}};t[s][0].call(u.exports,function(e){return i(t[s][1][e]||e)},u,u.exports,e,t,r,n)}return r[s].exports}for(var a="function"==typeof o&&o,s=0;s<n.length;s++)i(n[s]);return i}({1:[function(e,t,r){var n;n=function(){var e,t,r,n,i,a,o,s,l,c,u,d,p=p||(e=Math,t=Object.create||function(){function e(){}return function(t){var r;return e.prototype=t,r=new e,e.prototype=null,r}}(),n=(r={}).lib={},i=n.Base={extend:function(e){var r=t(this);return e&&r.mixIn(e),r.hasOwnProperty("init")&&this.init!==r.init||(r.init=function(){r.$super.init.apply(this,arguments)}),(r.init.prototype=r).$super=this,r},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},a=n.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||s).stringify(this)},concat:function(e){var t=this.words,r=e.words,n=this.sigBytes,i=e.sigBytes;if(this.clamp(),n%4)for(var a=0;a<i;a++){var o=r[a>>>2]>>>24-a%4*8&255;t[n+a>>>2]|=o<<24-(n+a)%4*8}else for(a=0;a<i;a+=4)t[n+a>>>2]=r[a>>>2];return this.sigBytes+=i,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=i.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var r,n=[],i=function(t){t=t;var r=987654321;return function(){var n=((r=36969*(65535&r)+(r>>16)&4294967295)<<16)+(t=18e3*(65535&t)+(t>>16)&4294967295)&4294967295;return n/=4294967296,(n+=.5)*(.5<e.random()?1:-1)}},o=0;o<t;o+=4){var s=i(4294967296*(r||e.random()));r=987654071*s(),n.push(4294967296*s()|0)}return new a.init(n,t)}}),o=r.enc={},s=o.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i++){var a=t[i>>>2]>>>24-i%4*8&255;n.push((a>>>4).toString(16)),n.push((15&a).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new a.init(r,t/2)}},l=o.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i++){var a=t[i>>>2]>>>24-i%4*8&255;n.push(String.fromCharCode(a))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new a.init(r,t)}},c=o.Utf8={stringify:function(e){try{return decodeURIComponent(escape(l.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return l.parse(unescape(encodeURIComponent(e)))}},u=n.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new a.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=c.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r=this._data,n=r.words,i=r.sigBytes,o=this.blockSize,s=i/(4*o),l=(s=t?e.ceil(s):e.max((0|s)-this._minBufferSize,0))*o,c=e.min(4*l,i);if(l){for(var u=0;u<l;u+=o)this._doProcessBlock(n,u);var d=n.splice(0,l);r.sigBytes-=c}return new a.init(d,c)},clone:function(){var e=i.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),n.Hasher=u.extend({cfg:i.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){u.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new d.HMAC.init(e,r).finalize(t)}}}),d=r.algo={},r);return p},"object"==(void 0===r?"undefined":l(r))?t.exports=r=n():this.CryptoJS=n()},{}],2:[function(e,t,r){var n;n=function(e){return e.enc.Hex},"object"==(void 0===r?"undefined":l(r))?t.exports=r=n(e(1)):n(this.CryptoJS)},{1:1}],3:[function(e,t,r){var n;n=function(e){return e.HmacMD5},"object"==(void 0===r?"undefined":l(r))?t.exports=r=n(e(1),e(5),e(4)):n(this.CryptoJS)},{1:1,4:4,5:5}],4:[function(e,t,r){var n;n=function(e){var t,r,n;r=(t=e).lib.Base,n=t.enc.Utf8,t.algo.HMAC=r.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=n.parse(t));var r=e.blockSize,i=4*r;t.sigBytes>i&&(t=e.finalize(t)),t.clamp();for(var a=this._oKey=t.clone(),o=this._iKey=t.clone(),s=a.words,l=o.words,c=0;c<r;c++)s[c]^=1549556828,l[c]^=909522486;a.sigBytes=o.sigBytes=i,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,r=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(r))}})},"object"==(void 0===r?"undefined":l(r))?t.exports=r=n(e(1)):n(this.CryptoJS)},{1:1}],5:[function(e,t,r){var n;n=function(e){return function(t){var r=e,n=r.lib,i=n.WordArray,a=n.Hasher,o=r.algo,s=[];!function(){for(var e=0;e<64;e++)s[e]=4294967296*t.abs(t.sin(e+1))|0}();var l=o.MD5=a.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var n=t+r,i=e[n];e[n]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8)}var a=this._hash.words,o=e[t+0],l=e[t+1],f=e[t+2],h=e[t+3],_=e[t+4],v=e[t+5],m=e[t+6],y=e[t+7],g=e[t+8],b=e[t+9],S=e[t+10],T=e[t+11],R=e[t+12],C=e[t+13],E=e[t+14],k=e[t+15],I=a[0],O=a[1],P=a[2],w=a[3];O=p(O=p(O=p(O=p(O=d(O=d(O=d(O=d(O=u(O=u(O=u(O=u(O=c(O=c(O=c(O=c(O,P=c(P,w=c(w,I=c(I,O,P,w,o,7,s[0]),O,P,l,12,s[1]),I,O,f,17,s[2]),w,I,h,22,s[3]),P=c(P,w=c(w,I=c(I,O,P,w,_,7,s[4]),O,P,v,12,s[5]),I,O,m,17,s[6]),w,I,y,22,s[7]),P=c(P,w=c(w,I=c(I,O,P,w,g,7,s[8]),O,P,b,12,s[9]),I,O,S,17,s[10]),w,I,T,22,s[11]),P=c(P,w=c(w,I=c(I,O,P,w,R,7,s[12]),O,P,C,12,s[13]),I,O,E,17,s[14]),w,I,k,22,s[15]),P=u(P,w=u(w,I=u(I,O,P,w,l,5,s[16]),O,P,m,9,s[17]),I,O,T,14,s[18]),w,I,o,20,s[19]),P=u(P,w=u(w,I=u(I,O,P,w,v,5,s[20]),O,P,S,9,s[21]),I,O,k,14,s[22]),w,I,_,20,s[23]),P=u(P,w=u(w,I=u(I,O,P,w,b,5,s[24]),O,P,E,9,s[25]),I,O,h,14,s[26]),w,I,g,20,s[27]),P=u(P,w=u(w,I=u(I,O,P,w,C,5,s[28]),O,P,f,9,s[29]),I,O,y,14,s[30]),w,I,R,20,s[31]),P=d(P,w=d(w,I=d(I,O,P,w,v,4,s[32]),O,P,g,11,s[33]),I,O,T,16,s[34]),w,I,E,23,s[35]),P=d(P,w=d(w,I=d(I,O,P,w,l,4,s[36]),O,P,_,11,s[37]),I,O,y,16,s[38]),w,I,S,23,s[39]),P=d(P,w=d(w,I=d(I,O,P,w,C,4,s[40]),O,P,o,11,s[41]),I,O,h,16,s[42]),w,I,m,23,s[43]),P=d(P,w=d(w,I=d(I,O,P,w,b,4,s[44]),O,P,R,11,s[45]),I,O,k,16,s[46]),w,I,f,23,s[47]),P=p(P,w=p(w,I=p(I,O,P,w,o,6,s[48]),O,P,y,10,s[49]),I,O,E,15,s[50]),w,I,v,21,s[51]),P=p(P,w=p(w,I=p(I,O,P,w,R,6,s[52]),O,P,h,10,s[53]),I,O,S,15,s[54]),w,I,l,21,s[55]),P=p(P,w=p(w,I=p(I,O,P,w,g,6,s[56]),O,P,k,10,s[57]),I,O,m,15,s[58]),w,I,C,21,s[59]),P=p(P,w=p(w,I=p(I,O,P,w,_,6,s[60]),O,P,T,10,s[61]),I,O,f,15,s[62]),w,I,b,21,s[63]),a[0]=a[0]+I|0,a[1]=a[1]+O|0,a[2]=a[2]+P|0,a[3]=a[3]+w|0},_doFinalize:function(){var e=this._data,r=e.words,n=8*this._nDataBytes,i=8*e.sigBytes;r[i>>>5]|=128<<24-i%32;var a=t.floor(n/4294967296),o=n;r[15+(i+64>>>9<<4)]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),r[14+(i+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),e.sigBytes=4*(r.length+1),this._process();for(var s=this._hash,l=s.words,c=0;c<4;c++){var u=l[c];l[c]=16711935&(u<<8|u>>>24)|4278255360&(u<<24|u>>>8)}return s},clone:function(){var e=a.clone.call(this);return e._hash=this._hash.clone(),e}});function c(e,t,r,n,i,a,o){var s=e+(t&r|~t&n)+i+o;return(s<<a|s>>>32-a)+t}function u(e,t,r,n,i,a,o){var s=e+(t&n|r&~n)+i+o;return(s<<a|s>>>32-a)+t}function d(e,t,r,n,i,a,o){var s=e+(t^r^n)+i+o;return(s<<a|s>>>32-a)+t}function p(e,t,r,n,i,a,o){var s=e+(r^(t|~n))+i+o;return(s<<a|s>>>32-a)+t}r.MD5=a._createHelper(l),r.HmacMD5=a._createHmacHelper(l)}(Math),e.MD5},"object"==(void 0===r?"undefined":l(r))?t.exports=r=n(e(1)):n(this.CryptoJS)},{1:1}],6:[function(e,t,r){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(e){return"function"==typeof e}function a(e){return"object"==(void 0===e?"undefined":l(e))&&null!==e}function o(e){return void 0===e}((t.exports=n).EventEmitter=n).prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},n.prototype.emit=function(e){var t,r,n,s,l,c;if(this._events||(this._events={}),"error"===e&&(!this._events.error||a(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var u=new Error('Uncaught, unspecified "error" event. ('+t+")");throw u.context=t,u}if(o(r=this._events[e]))return!1;if(i(r))switch(arguments.length){case 1:r.call(this);break;case 2:r.call(this,arguments[1]);break;case 3:r.call(this,arguments[1],arguments[2]);break;default:s=Array.prototype.slice.call(arguments,1),r.apply(this,s)}else if(a(r))for(s=Array.prototype.slice.call(arguments,1),n=(c=r.slice()).length,l=0;l<n;l++)c[l].apply(this,s);return!0},n.prototype.on=n.prototype.addListener=function(e,t){var r;if(!i(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,i(t.listener)?t.listener:t),this._events[e]?a(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,a(this._events[e])&&!this._events[e].warned&&(r=o(this._maxListeners)?n.defaultMaxListeners:this._maxListeners)&&0<r&&this._events[e].length>r&&(this._events[e].warned=!0,console.trace),this},n.prototype.once=function(e,t){if(!i(t))throw TypeError("listener must be a function");var r=!1;function n(){this.removeListener(e,n),r||(r=!0,t.apply(this,arguments))}return n.listener=t,this.on(e,n),this},n.prototype.removeListener=function(e,t){var r,n,o,s;if(!i(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(o=(r=this._events[e]).length,n=-1,r===t||i(r.listener)&&r.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(a(r)){for(s=o;0<s--;)if(r[s]===t||r[s].listener&&r[s].listener===t){n=s;break}if(n<0)return this;1===r.length?(r.length=0,delete this._events[e]):r.splice(n,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},n.prototype.removeAllListeners=function(e){var t,r;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(i(r=this._events[e]))this.removeListener(e,r);else if(r)for(;r.length;)this.removeListener(e,r[r.length-1]);return delete this._events[e],this},n.prototype.listeners=function(e){return this._events&&this._events[e]?i(this._events[e])?[this._events[e]]:this._events[e].slice():[]},n.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(i(t))return 1;if(t)return t.length}return 0},n.listenerCount=function(e,t){return e.listenerCount(t)}},{}],7:[function(e,t,r){!function(e,n){var i="vendor",a="version",o="architecture",s="mobile",c="tablet",u={extend:function(e,t){var r={};for(var n in e)t[n]&&t[n].length%2==0?r[n]=t[n].concat(e[n]):r[n]=e[n];return r},has:function(e,t){return"string"==typeof e&&-1!==t.toLowerCase().indexOf(e.toLowerCase())},lowerize:function(e){return e.toLowerCase()},major:function(e){return"string"==typeof e?e.replace(/[^\d\.]/g,"").split(".")[0]:void 0},trim:function(e){return e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}},d={rgx:function(e,t){for(var r,n,i,a,o,s,c=0;c<t.length&&!o;){var u=t[c],d=t[c+1];for(r=n=0;r<u.length&&!o;)if(o=u[r++].exec(e))for(i=0;i<d.length;i++)s=o[++n],"object"==l(a=d[i])&&0<a.length?2==a.length?"function"==l(a[1])?this[a[0]]=a[1].call(this,s):this[a[0]]=a[1]:3==a.length?"function"!==l(a[1])||a[1].exec&&a[1].test?this[a[0]]=s?s.replace(a[1],a[2]):void 0:this[a[0]]=s?a[1].call(this,s,a[2]):void 0:4==a.length&&(this[a[0]]=s?a[3].call(this,s.replace(a[1],a[2])):void 0):this[a]=s||void 0;c+=2}},str:function(e,t){for(var r in t)if("object"==l(t[r])&&0<t[r].length){for(var n=0;n<t[r].length;n++)if(u.has(t[r][n],e))return"?"===r?void 0:r}else if(u.has(t[r],e))return"?"===r?void 0:r;return e}},p={browser:{oldsafari:{version:{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}}},device:{amazon:{model:{"Fire Phone":["SD","KF"]}},sprint:{model:{"Evo Shift 4G":"7373KT"},vendor:{HTC:"APA",Sprint:"Sprint"}}},os:{windows:{version:{ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2000:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"}}}},f={browser:[[/(opera\smini)\/([\w\.-]+)/i,/(opera\s[mobiletab]+).+version\/([\w\.-]+)/i,/(opera).+version\/([\w\.]+)/i,/(opera)[\/\s]+([\w\.]+)/i],["name",a],[/(opios)[\/\s]+([\w\.]+)/i],[["name","Opera Mini"],a],[/\s(opr)\/([\w\.]+)/i],[["name","Opera"],a],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/\s]?([\w\.]*)/i,/(avant\s|iemobile|slim|baidu)(?:browser)?[\/\s]?([\w\.]*)/i,/(?:ms|\()(ie)\s([\w\.]+)/i,/(rekonq)\/([\w\.]*)/i,/(chromium|flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark)\/([\w\.-]+)/i],["name",a],[/(trident).+rv[:\s]([\w\.]+).+like\sgecko/i],[["name","IE"],a],[/(edge|edgios|edga)\/((\d+)?[\w\.]+)/i],[["name","Edge"],a],[/(yabrowser)\/([\w\.]+)/i],[["name","Yandex"],a],[/(puffin)\/([\w\.]+)/i],[["name","Puffin"],a],[/(focus)\/([\w\.]+)/i],[["name","Firefox Focus"],a],[/(opt)\/([\w\.]+)/i],[["name","Opera Touch"],a],[/((?:[\s\/])uc?\s?browser|(?:juc.+)ucweb)[\/\s]?([\w\.]+)/i],[["name","UCBrowser"],a],[/(comodo_dragon)\/([\w\.]+)/i],[["name",/_/g," "],a],[/(micromessenger)\/([\w\.]+)/i],[["name","WeChat"],a],[/(brave)\/([\w\.]+)/i],[["name","Brave"],a],[/(qqbrowserlite)\/([\w\.]+)/i],["name",a],[/(QQ)\/([\d\.]+)/i],["name",a],[/m?(qqbrowser)[\/\s]?([\w\.]+)/i],["name",a],[/(BIDUBrowser)[\/\s]?([\w\.]+)/i],["name",a],[/(2345Explorer)[\/\s]?([\w\.]+)/i],["name",a],[/(MetaSr)[\/\s]?([\w\.]+)/i],["name"],[/(LBBROWSER)/i],["name"],[/xiaomi\/miuibrowser\/([\w\.]+)/i],[a,["name","MIUI Browser"]],[/;fbav\/([\w\.]+);/i],[a,["name","Facebook"]],[/safari\s(line)\/([\w\.]+)/i,/android.+(line)\/([\w\.]+)\/iab/i],["name",a],[/headlesschrome(?:\/([\w\.]+)|\s)/i],[a,["name","Chrome Headless"]],[/\swv\).+(chrome)\/([\w\.]+)/i],[["name",/(.+)/,"$1 WebView"],a],[/((?:oculus|samsung)browser)\/([\w\.]+)/i],[["name",/(.+(?:g|us))(.+)/,"$1 $2"],a],[/android.+version\/([\w\.]+)\s+(?:mobile\s?safari|safari)*/i],[a,["name","Android Browser"]],[/(chrome|omniweb|arora|[tizenoka]{5}\s?browser)\/v?([\w\.]+)/i],["name",a],[/(dolfin)\/([\w\.]+)/i],[["name","Dolphin"],a],[/((?:android.+)crmo|crios)\/([\w\.]+)/i],[["name","Chrome"],a],[/(coast)\/([\w\.]+)/i],[["name","Opera Coast"],a],[/fxios\/([\w\.-]+)/i],[a,["name","Firefox"]],[/version\/([\w\.]+).+?mobile\/\w+\s(safari)/i],[a,["name","Mobile Safari"]],[/version\/([\w\.]+).+?(mobile\s?safari|safari)/i],[a,"name"],[/webkit.+?(gsa)\/([\w\.]+).+?(mobile\s?safari|safari)(\/[\w\.]+)/i],[["name","GSA"],a],[/webkit.+?(mobile\s?safari|safari)(\/[\w\.]+)/i],["name",[a,d.str,p.browser.oldsafari.version]],[/(konqueror)\/([\w\.]+)/i,/(webkit|khtml)\/([\w\.]+)/i],["name",a],[/(navigator|netscape)\/([\w\.-]+)/i],[["name","Netscape"],a],[/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo\sbrowser|minimo|conkeror)[\/\s]?([\w\.\+]+)/i,/(firefox|seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([\w\.-]+)$/i,/(mozilla)\/([\w\.]+).+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir)[\/\s]?([\w\.]+)/i,/(links)\s\(([\w\.]+)/i,/(gobrowser)\/?([\w\.]*)/i,/(ice\s?browser)\/v?([\w\._]+)/i,/(mosaic)[\/\s]([\w\.]+)/i],["name",a]],cpu:[[/(?:(amd|x(?:(?:86|64)[_-])?|wow|win)64)[;\)]/i],[[o,"amd64"]],[/(ia32(?=;))/i],[[o,u.lowerize]],[/((?:i[346]|x)86)[;\)]/i],[[o,"ia32"]],[/windows\s(ce|mobile);\sppc;/i],[[o,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?:\smac|;|\))/i],[[o,/ower/,"",u.lowerize]],[/(sun4\w)[;\)]/i],[[o,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|arm(?:64|(?=v\d+[;l]))|(?=atmel\s)avr|(?:irix|mips|sparc)(?:64)?(?=;)|pa-risc)/i],[[o,u.lowerize]]],device:[[/\((ipad|playbook);[\w\s\);-]+(rim|apple)/i],["model",i,["type",c]],[/applecoremedia\/[\w\.]+ \((ipad)/],["model",[i,"Apple"],["type",c]],[/(apple\s{0,1}tv)/i],[["model","Apple TV"],[i,"Apple"]],[/(archos)\s(gamepad2?)/i,/(hp).+(touchpad)/i,/(hp).+(tablet)/i,/(kindle)\/([\w\.]+)/i,/\s(nook)[\w\s]+build\/(\w+)/i,/(dell)\s(strea[kpr\s\d]*[\dko])/i],[i,"model",["type",c]],[/(kf[A-z]+)\sbuild\/.+silk\//i],["model",[i,"Amazon"],["type",c]],[/(sd|kf)[0349hijorstuw]+\sbuild\/.+silk\//i],[["model",d.str,p.device.amazon.model],[i,"Amazon"],["type",s]],[/android.+aft([bms])\sbuild/i],["model",[i,"Amazon"],["type","smarttv"]],[/\((ip[honed|\s\w*]+);.+(apple)/i],["model",i,["type",s]],[/\((ip[honed|\s\w*]+);/i],["model",[i,"Apple"],["type",s]],[/(blackberry)[\s-]?(\w+)/i,/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[\s_-]?([\w-]*)/i,/(hp)\s([\w\s]+\w)/i,/(asus)-?(\w+)/i],[i,"model",["type",s]],[/\(bb10;\s(\w+)/i],["model",[i,"BlackBerry"],["type",s]],[/android.+(transfo[prime\s]{4,10}\s\w+|eeepc|slider\s\w+|nexus 7|padfone)/i],["model",[i,"Asus"],["type",c]],[/(sony)\s(tablet\s[ps])\sbuild\//i,/(sony)?(?:sgp.+)\sbuild\//i],[[i,"Sony"],["model","Xperia Tablet"],["type",c]],[/android.+\s([c-g]\d{4}|so[-l]\w+)\sbuild\//i],["model",[i,"Sony"],["type",s]],[/\s(ouya)\s/i,/(nintendo)\s([wids3u]+)/i],[i,"model",["type","console"]],[/android.+;\s(shield)\sbuild/i],["model",[i,"Nvidia"],["type","console"]],[/(playstation\s[34portablevi]+)/i],["model",[i,"Sony"],["type","console"]],[/(sprint\s(\w+))/i],[[i,d.str,p.device.sprint.vendor],["model",d.str,p.device.sprint.model],["type",s]],[/(lenovo)\s?(S(?:5000|6000)+(?:[-][\w+]))/i],[i,"model",["type",c]],[/(htc)[;_\s-]+([\w\s]+(?=\))|\w+)*/i,/(zte)-(\w*)/i,/(alcatel|geeksphone|lenovo|nexian|panasonic|(?=;\s)sony)[_\s-]?([\w-]*)/i],[i,["model",/_/g," "],["type",s]],[/(nexus\s9)/i],["model",[i,"HTC"],["type",c]],[/d\/huawei([\w\s-]+)[;\)]/i,/(nexus\s6p)/i],["model",[i,"Huawei"],["type",s]],[/(microsoft);\s(lumia[\s\w]+)/i],[i,"model",["type",s]],[/[\s\(;](xbox(?:\sone)?)[\s\);]/i],["model",[i,"Microsoft"],["type","console"]],[/(kin\.[onetw]{3})/i],[["model",/\./g," "],[i,"Microsoft"],["type",s]],[/\s(milestone|droid(?:[2-4x]|\s(?:bionic|x2|pro|razr))?:?(\s4g)?)[\w\s]+build\//i,/mot[\s-]?(\w*)/i,/(XT\d{3,4}) build\//i,/(nexus\s6)/i],["model",[i,"Motorola"],["type",s]],[/android.+\s(mz60\d|xoom[\s2]{0,2})\sbuild\//i],["model",[i,"Motorola"],["type",c]],[/hbbtv\/\d+\.\d+\.\d+\s+\([\w\s]*;\s*(\w[^;]*);([^;]*)/i],[[i,u.trim],["model",u.trim],["type","smarttv"]],[/hbbtv.+maple;(\d+)/i],[["model",/^/,"SmartTV"],[i,"Samsung"],["type","smarttv"]],[/\(dtv[\);].+(aquos)/i],["model",[i,"Sharp"],["type","smarttv"]],[/android.+((sch-i[89]0\d|shw-m380s|gt-p\d{4}|gt-n\d+|sgh-t8[56]9|nexus 10))/i,/((SM-T\w+))/i],[[i,"Samsung"],"model",["type",c]],[/smart-tv.+(samsung)/i],[i,["type","smarttv"],"model"],[/((s[cgp]h-\w+|gt-\w+|galaxy\snexus|sm-\w[\w\d]+))/i,/(sam[sung]*)[\s-]*(\w+-?[\w-]*)/i,/sec-((sgh\w+))/i],[[i,"Samsung"],"model",["type",s]],[/sie-(\w*)/i],["model",[i,"Siemens"],["type",s]],[/(maemo|nokia).*(n900|lumia\s\d+)/i,/(nokia)[\s_-]?([\w-]*)/i],[[i,"Nokia"],"model",["type",s]],[/android\s3\.[\s\w;-]{10}(a\d{3})/i],["model",[i,"Acer"],["type",c]],[/android.+([vl]k\-?\d{3})\s+build/i],["model",[i,"LG"],["type",c]],[/android\s3\.[\s\w;-]{10}(lg?)-([06cv9]{3,4})/i],[[i,"LG"],"model",["type",c]],[/(lg) netcast\.tv/i],[i,"model",["type","smarttv"]],[/(nexus\s[45])/i,/lg[e;\s\/-]+(\w*)/i,/android.+lg(\-?[\d\w]+)\s+build/i],["model",[i,"LG"],["type",s]],[/android.+(ideatab[a-z0-9\-\s]+)/i],["model",[i,"Lenovo"],["type",c]],[/linux;.+((jolla));/i],[i,"model",["type",s]],[/((pebble))app\/[\d\.]+\s/i],[i,"model",["type","wearable"]],[/android.+;\s(oppo)\s?([\w\s]+)\sbuild/i],[i,"model",["type",s]],[/crkey/i],[["model","Chromecast"],[i,"Google"]],[/android.+;\s(glass)\s\d/i],["model",[i,"Google"],["type","wearable"]],[/android.+;\s(pixel c)[\s)]/i],["model",[i,"Google"],["type",c]],[/android.+;\s(pixel( [23])?( xl)?)\s/i],["model",[i,"Google"],["type",s]],[/android.+;\s(\w+)\s+build\/hm\1/i,/android.+(hm[\s\-_]*note?[\s_]*(?:\d\w)?)\s+build/i,/android.+(mi[\s\-_]*(?:one|one[\s_]plus|note lte)?[\s_]*(?:\d?\w?)[\s_]*(?:plus)?)\s+build/i,/android.+(redmi[\s\-_]*(?:note)?(?:[\s_]*[\w\s]+))\s+build/i],[["model",/_/g," "],[i,"Xiaomi"],["type",s]],[/android.+(mi[\s\-_]*(?:pad)(?:[\s_]*[\w\s]+))\s+build/i],[["model",/_/g," "],[i,"Xiaomi"],["type",c]],[/android.+;\s(m[1-5]\snote)\sbuild/i],["model",[i,"Meizu"],["type",c]],[/(mz)-([\w-]{2,})/i],[[i,"Meizu"],"model",["type",s]],[/android.+a000(1)\s+build/i,/android.+oneplus\s(a\d{4})\s+build/i],["model",[i,"OnePlus"],["type",s]],[/android.+[;\/]\s*(RCT[\d\w]+)\s+build/i],["model",[i,"RCA"],["type",c]],[/android.+[;\/\s]+(Venue[\d\s]{2,7})\s+build/i],["model",[i,"Dell"],["type",c]],[/android.+[;\/]\s*(Q[T|M][\d\w]+)\s+build/i],["model",[i,"Verizon"],["type",c]],[/android.+[;\/]\s+(Barnes[&\s]+Noble\s+|BN[RT])(V?.*)\s+build/i],[[i,"Barnes & Noble"],"model",["type",c]],[/android.+[;\/]\s+(TM\d{3}.*\b)\s+build/i],["model",[i,"NuVision"],["type",c]],[/android.+;\s(k88)\sbuild/i],["model",[i,"ZTE"],["type",c]],[/android.+[;\/]\s*(gen\d{3})\s+build.*49h/i],["model",[i,"Swiss"],["type",s]],[/android.+[;\/]\s*(zur\d{3})\s+build/i],["model",[i,"Swiss"],["type",c]],[/android.+[;\/]\s*((Zeki)?TB.*\b)\s+build/i],["model",[i,"Zeki"],["type",c]],[/(android).+[;\/]\s+([YR]\d{2})\s+build/i,/android.+[;\/]\s+(Dragon[\-\s]+Touch\s+|DT)(\w{5})\sbuild/i],[[i,"Dragon Touch"],"model",["type",c]],[/android.+[;\/]\s*(NS-?\w{0,9})\sbuild/i],["model",[i,"Insignia"],["type",c]],[/android.+[;\/]\s*((NX|Next)-?\w{0,9})\s+build/i],["model",[i,"NextBook"],["type",c]],[/android.+[;\/]\s*(Xtreme\_)?(V(1[045]|2[015]|30|40|60|7[05]|90))\s+build/i],[[i,"Voice"],"model",["type",s]],[/android.+[;\/]\s*(LVTEL\-)?(V1[12])\s+build/i],[[i,"LvTel"],"model",["type",s]],[/android.+;\s(PH-1)\s/i],["model",[i,"Essential"],["type",s]],[/android.+[;\/]\s*(V(100MD|700NA|7011|917G).*\b)\s+build/i],["model",[i,"Envizen"],["type",c]],[/android.+[;\/]\s*(Le[\s\-]+Pan)[\s\-]+(\w{1,9})\s+build/i],[i,"model",["type",c]],[/android.+[;\/]\s*(Trio[\s\-]*.*)\s+build/i],["model",[i,"MachSpeed"],["type",c]],[/android.+[;\/]\s*(Trinity)[\-\s]*(T\d{3})\s+build/i],[i,"model",["type",c]],[/android.+[;\/]\s*TU_(1491)\s+build/i],["model",[i,"Rotor"],["type",c]],[/android.+(KS(.+))\s+build/i],["model",[i,"Amazon"],["type",c]],[/android.+(Gigaset)[\s\-]+(Q\w{1,9})\s+build/i],[i,"model",["type",c]],[/\s(tablet|tab)[;\/]/i,/\s(mobile)(?:[;\/]|\ssafari)/i],[["type",u.lowerize],i,"model"],[/(android[\w\.\s\-]{0,9});.+build/i],["model",[i,"Generic"]]],engine:[[/windows.+\sedge\/([\w\.]+)/i],[a,["name","EdgeHTML"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m)\/([\w\.]+)/i,/(khtml|tasman|links)[\/\s]\(?([\w\.]+)/i,/(icab)[\/\s]([23]\.[\d\.]+)/i],["name",a],[/rv\:([\w\.]{1,9}).+(gecko)/i],[a,"name"]],os:[[/microsoft\s(windows)\s(vista|xp)/i],["name",a],[/(windows)\snt\s6\.2;\s(arm)/i,/(windows\sphone(?:\sos)*)[\s\/]?([\d\.\s\w]*)/i,/(windows\smobile|windows)[\s\/]?([ntce\d\.\s]+\w)/i],["name",[a,d.str,p.os.windows.version]],[/(win(?=3|9|n)|win\s9x\s)([nt\d\.]+)/i],[["name","Windows"],[a,d.str,p.os.windows.version]],[/\((bb)(10);/i],[["name","BlackBerry"],a],[/(blackberry)\w*\/?([\w\.]*)/i,/(tizen)[\/\s]([\w\.]+)/i,/(android|webos|palm\sos|qnx|bada|rim\stablet\sos|meego|contiki)[\/\s-]?([\w\.]*)/i,/linux;.+(sailfish);/i],["name",a],[/(symbian\s?os|symbos|s60(?=;))[\/\s-]?([\w\.]*)/i],[["name","Symbian"],a],[/\((series40);/i],["name"],[/mozilla.+\(mobile;.+gecko.+firefox/i],[["name","Firefox OS"],a],[/(nintendo|playstation)\s([wids34portablevu]+)/i,/(mint)[\/\s\(]?(\w*)/i,/(mageia|vectorlinux)[;\s]/i,/(joli|[kxln]?ubuntu|debian|suse|opensuse|gentoo|(?=\s)arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk|linpus)[\/\s-]?(?!chrom)([\w\.-]*)/i,/(hurd|linux)\s?([\w\.]*)/i,/(gnu)\s?([\w\.]*)/i],["name",a],[/(cros)\s[\w]+\s([\w\.]+\w)/i],[["name","Chromium OS"],a],[/(sunos)\s?([\w\.\d]*)/i],[["name","Solaris"],a],[/\s([frentopc-]{0,4}bsd|dragonfly)\s?([\w\.]*)/i],["name",a],[/(haiku)\s(\w+)/i],["name",a],[/cfnetwork\/.+darwin/i,/ip[honead]{2,4}(?:.*os\s([\w]+)\slike\smac|;\sopera)/i],[[a,/_/g,"."],["name","iOS"]],[/(mac\sos\sx)\s?([\w\s\.]*)/i,/(macintosh|mac(?=_powerpc)\s)/i],[["name","Mac OS"],[a,/_/g,"."]],[/((?:open)?solaris)[\/\s-]?([\w\.]*)/i,/(aix)\s((\d)(?=\.|\)|\s)[\w\.])*/i,/(plan\s9|minix|beos|os\/2|amigaos|morphos|risc\sos|openvms|fuchsia)/i,/(unix)\s?([\w\.]*)/i],["name",a]]},h=function t(r,n){if("object"==(void 0===r?"undefined":l(r))&&(n=r,r=void 0),!(this instanceof t))return new t(r,n).getResult();var i=r||(e&&e.navigator&&e.navigator.userAgent?e.navigator.userAgent:""),a=n?u.extend(f,n):f;return this.getBrowser=function(){var e={name:void 0,version:void 0};return d.rgx.call(e,i,a.browser),e.major=u.major(e.version),e},this.getCPU=function(){var e={architecture:void 0};return d.rgx.call(e,i,a.cpu),e},this.getDevice=function(){var e={vendor:void 0,model:void 0,type:void 0};return d.rgx.call(e,i,a.device),e},this.getEngine=function(){var e={name:void 0,version:void 0};return d.rgx.call(e,i,a.engine),e},this.getOS=function(){var e={name:void 0,version:void 0};return d.rgx.call(e,i,a.os),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return i},this.setUA=function(e){return i=e,this},this};h.VERSION="0.7.19",h.BROWSER={NAME:"name",MAJOR:"major",VERSION:a},h.CPU={ARCHITECTURE:o},h.DEVICE={MODEL:"model",VENDOR:i,TYPE:"type",CONSOLE:"console",MOBILE:s,SMARTTV:"smarttv",TABLET:c,WEARABLE:"wearable",EMBEDDED:"embedded"},h.ENGINE={NAME:"name",VERSION:a},h.OS={NAME:"name",VERSION:a},"undefined"!==(void 0===r?"undefined":l(r))?("undefined"!==(void 0===t?"undefined":l(t))&&t.exports&&(r=t.exports=h),r.UAParser=h):e&&(e.UAParser=h);var _=e&&(e.jQuery||e.Zepto);if("undefined"!==(void 0===_?"undefined":l(_))&&!_.ua){var v=new h;_.ua=v.getResult(),_.ua.get=function(){return v.getUA()},_.ua.set=function(e){v.setUA(e);var t=v.getResult();for(var r in t)_.ua[r]=t[r]}}}("object"==("undefined"==typeof window?"undefined":l(window))?window:this)},{}],8:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,[{key:"destroy",value:function(){throw"InitiatorBase:destroy 此处需要实现"}},{key:"start",value:function(){}},{key:"stop",value:function(){}},{key:"startLazyComponents",value:function(){}},{key:"stopLazyComponents",value:function(){}},{key:"load",value:function(){throw"InitiatorBase:load 此处需要实现"}},{key:"setMediaElement",value:function(){throw"InitiatorBase:setMediaElement 此处需要实现"}},{key:"localPeerId",get:function(){}},{key:"xStreamId",get:function(){}}]),e}();r.default=i},{}],9:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.ComCode={ROLLBACK:-2,HTTP_STATUS_CODE_INVALID:-1,RECEIVE_BUFFER:1,BUFFER_EOF:2,END_OF_STREAM:3},r.ComEvent={STATE_CHANGE:"tp2pStateChange",RECEIVE_STATE:"tp2pReceiveState"},r.RollbackReasons={STREAM_NOT_FOUND:"stream_not_found",PLAY_TIMEOUT:"play_timeout",SPLIT_STARTING:"split_starting",OTHER_REASON:"other_reason"}},{}],10:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.tp2pDefaultConfig={debug:!1,randomPlayId:"",startTime:Date.now(),loadTime:0,roomId:"",partnerId:"",sourceUrl:"",channelId:"",isUrl:!0,confBaseUrl:"https://conf.qvb.qcloud.com/api/v1/live/h5/",stunServer:"",signalServer:"signal.qvb.qcloud.com",reportServer:"https://log.qvb.qcloud.com/reporter/vlive",trackerUrl:"",trackerVersion:"v1",liveDelayPreset:0,syncInterval:6e4,protectWin:10,reporteInterval:6e4,useP2p:!0,initRollback:!1,p2p:1,monitorStart:5,bFix:1,bpFix:1,confVersion:0,mainMaxRetryCount:3,retryMainDelay:1500,pcdnDomainMain:"tx2play1.douyucdn.cn",pcdnDomainSub:"tx2play2.douyucdn.cn",confPCDNBaseUrl:"https://conf.qvb.qcloud.com/api/v3/live/h5/",uselessSliceCount:300,pcdnStreams:4,enableBakOC:!1,pcdnProtectWindow:5,subStreamLoadInterval:3e3,p2pWindow:5,pcdnMaxTaskSize:6,ztcTimeout:2e3,useP2PWindow:!0,playStartTimeout:4500,rollback404:!0,eos404Limit:2,testOCRoom:"",syncConf:!1,enableWriteAll:!1,enableSpeedUp:!0,accelerationRate:1.05,targetBufferLen:4,delayCheckInterval:15e3,pcdnLiveDelay:7,assignDelayRooms:[],assignDelay:6e3,enableRollbackOther:!1,rollbackWhileList:["tc-tct.douyucdn2.cn","9699.liveplay.myqcloud.com"],initStuckThreshold:1e3,mainStuckThreshold:1e4,disableTrigger:!1,restartP2PDelay:0,maxSkipRetryTimes:5,enableStuckReload:!1,stuckCauseReload:12e3,enableStuckWaitBuffer:!1,resumePlayDelay:9,resumePlayBuffer:3,enableP2PFill:!1,p2pFillOffset:0,p2pCheckInterval:300,fillTimeoutWithP2P:!1,fill404WitP2P:!1,forceFillCnt:6,fillTimeout:2e3,fillMinBuf:2,fillRatio:1,parseHeader:!1,fillMaxTaskSize:2,enableAbortController:!0,enableSubFill:!1,judgeAliveDelay:3e3,judgeAliveCount:5,p2pUsefulRatio:.75,sampleDuration:6,PCKeepTimeout:2e3,sampleUsefulJudge:!1,clearPeerOnPauseP2P:!0,pcdnConfTimeout:5e3,pcdnConfMaxRetry:5,pcdnConfRetryDelay:2e3,pcdnConfMaxRetryDelay:4e3,liveDelay:10,minDelay:8,maxDelay:12,enableFastStartUp:!1,adjustPlayDelayInterval:18e4,adjustPlayDelayIntervalSlowDown:6e4,enableAdjustDelay:!0,adjustPlayDelayTimerInterval:10,delayTolerateMax:2,delayTolerateMin:2,fastForwardLimit:2,playerMaxBuffer:10,pushBoundary:0,fastForwardMaxDuration:60,fastForwardMaxBufferLength:10,skipStartValidity:60,enableFastWardRate:!0,enableSlowDownRate:!1,fastForwardRate:1.05,appendCheck:!0,bufferCount:30,trackerCustomVersion:"p6",streams:0,maxSubscribePCUsefulCount:2,maxConnectRequestEachPeriod:2,maxConnecting:8,maxConnectedPC:4,maxSubscribedPC:2,maxConnectedPCHigh:3,maxSubscribedPCHigh:1,enableExtraPeer:!1,extraPeerStreamNo:-1,extraPeerCount:1,PCHeartTimeout:1e4,PCHeartInterval:3e3,PCCheckAliveInterval:1e3,bufferedAmountLimit:5242880,DCChunkSize:64512,enableDCClosing:!1,checkPeerInterval:8e3,initEstimate:2,peerCacheSize:100,peerConnWaWeight:.75,highBitRate:4e3,peersChannelSendDelay:300,localStreamShare:!1,maxSubLevel:3,ssmResGap2PR:300,ssmCheckInterval:300,ssmContinuousCount:3,ssmEmitInterval:3e4,primaryRes:"",lastKeyFrameId:-1,updateTime:-1,syncThresh:2,backupTaskLen:4,maxTaskLen:4,xpieceTaskLimit:3,xpieceBackup:!1,primeXpieceWithBackup:!1,maxRequestEachTime:2,cdnSuffix:"m4s",backupCdnDelay:3100,CDNList:[],failCauseFallback:5,skipXPieceFail:2,startFastDownload:!0,codeEqual404:0,stuckCauseRollback:1e4,stuckCauseSkip:5e3,fixStuck:!1,stuckFilter:800,stuckThreshold:1,stuckPerformance:!0,maxFillCount:15,confTimeout:3e3,confMaxRetry:0,confRetryDelay:1e3,confMaxRetryDelay:3e3,trackerInterval:16e3,trackerTimeout:5e3,trackerMaxRetry:2,trackerRetryDelay:2e3,trackerMaxRetryDelay:1e4,cdnBaseUrl:"",backupCdnLoadingTimeout:3e3,backupCdnLoadingMaxRetry:0,backupCdnLoadingRetryDelay:500,backupCdnLoadingMaxRetryDelay:1e3,cdnLoadingTimeout:3e3,cdnLoadingMaxRetry:1,cdnLoadingRetryDelay:500,cdnLoadingMaxRetryDelay:1e3,reportLoadingTimeout:5e3,reportLoadingMaxRetry:1,reportLoadingRetryDelay:500,reportLoadingMaxRetryDelay:1e3,plrEnable:0,plrThreshold:.02,plrCacheLength:2048,plrCheckDelay:2,confirmLossEnable:!0,startPlayWaitSliceLen:0,service:1,platform:31,moduleId:1080,command:81e4,domain:"h5.douyutv.com",appId:1,bizId:"3000",partner:"59bb7e657a00f701632e9213"}},{}],11:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=u(e(19)),a=u(e(18)),o=e(9),s=e(86),c=e(77);function u(e){return e&&e.__esModule?e:{default:e}}var d=function(e){function t(e){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i.default.ERROR));return r.TAG="ErrorController",r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),n(t,[{key:"destroy",value:function(){a.default.prototype.destroy.call(this),this.tp2p=null}},{key:"onError",value:function(e){if(e.fatal){var t=e.extendReportData;this._report(e.rollbackCode,t);var r=this.tp2p;switch(r._stopLazyComponents(),r.initiator.stopLazyComponents(),r.supportLoader=!1,e.rollbackCode){case c.ReportCode.ROLLBACK:this._triggerRollback(t);break;case c.ReportCode.END_OF_STREAM:this._triggerEndOfStream()}}}},{key:"_triggerEndOfStream",value:function(){s.logger.warn("触发流结束. 触发loader中onStateChange"),this.tp2p.status.closeReason="eos",this.tp2p.trigger(i.default.STATE_CHANGE,{code:o.ComCode.END_OF_STREAM})}},{key:"_triggerRollback",value:function(e){var t=this.tp2p;t.status.closeReason="rollback";var r=this._rollbackReason(e),n=t.rollback;n?(s.logger.warn("触发回退. 调用外部绑定的rollback"),setTimeout(function(){n({code:o.ComCode.ROLLBACK,player:t.player,rollbackReason:r})},0)):(s.logger.warn("触发回退. 触发loader中onStateChange"),t.trigger(i.default.STATE_CHANGE,{code:o.ComCode.ROLLBACK,player:t.player,rollbackReason:r}))}},{key:"_rollbackReason",value:function(e){if(!e)return o.RollbackReasons.OTHER_REASON;switch(e[c.ReportField.ROLLBACK_REASON]){case c.ReportField.ROLLBACK_STUCK:case c.ReportField.ROLLBACK_EMPTY_BUFFER:return o.RollbackReasons.PLAY_TIMEOUT;case c.ReportField.ROLLBACK_CDN_ERR:case c.ReportField.ROLLBACK_NONEXISTENT:return o.RollbackReasons.STREAM_NOT_FOUND;case c.ReportField.ROLLBACK_SPLIT_STARTING:case c.ReportField.ROLLBACK_NOT_ENOUGH_SPLIT:return o.RollbackReasons.SPLIT_STARTING;case c.ReportField.ROLLBACK_CONF_ERROR:case c.ReportField.ROLLBACK_APPEND_EXCEPTION:case c.ReportField.ROLLBACK_CONF_CONFIG:case c.ReportField.ROLLBACK_CONF_TIMEOUT:default:return o.RollbackReasons.OTHER_REASON}}},{key:"_report",value:function(e,t){var r,n,a,o={};if(o[c.ReportField.EVENT_CODE]=e,o[c.ReportField.CODE]=c.ReportCode.PHASE_DATA,t){var l=t[c.ReportField.ROLLBACK_REASON];l&&(this.tp2p.status.rollbackReason=l,s.logger.warn("回退原因: "+l),t.i=(r={},a=1,(n=c.ReportField.PLAY_ORIGIN)in r?Object.defineProperty(r,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):r[n]=a,r),-1<[c.ReportField.ROLLBACK_CONF_CONFIG,c.ReportField.ROLLBACK_NONEXISTENT,c.ReportField.ROLLBACK_STREAM_404].indexOf(l)&&(t.i[c.ReportField.ABNORMAL_REQUEST]=1),Object.assign(o,t)),this.tp2p.trigger(i.default.REPORT_ONCE,o)}}}]),t}();r.default=d},{18:18,19:19,77:77,86:86,9:9}],12:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=p(e(19)),a=p(e(18)),o=p(e(89)),s=p(e(79)),c=p(e(85)),u=e(77),d=p(e(82));function p(e){return e&&e.__esModule?e:{default:e}}var f=function(e){function t(e){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i.default.REPORTER_STOPPING,i.default.REPORT_ONCE));return r.TAG="ReporterController",r._callbacks=[],r.onCollectAndReport=r.collectAndReport.bind(r),r.onBeforeUnload=r.beforeUnload.bind(r),window.addEventListener("beforeunload",r.onBeforeUnload),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),n(t,[{key:"onStarting",value:function(){this._timer=setInterval(this.onCollectAndReport,this.tp2p.config.reporteInterval)}},{key:"onStopping",value:function(){this._timer&&(clearInterval(this._timer),this.timer=null)}},{key:"onReporterStopping",value:function(){this.onStopping()}},{key:"beforeUnload",value:function(){this.collectAndReport("close")}},{key:"destroy",value:function(){window.removeEventListener("beforeunload",this.onBeforeUnload),this.collectAndReport("destroy"),this.onStopping(),this.onCollectAndReport=null,a.default.prototype.destroy.call(this),this.tp2p=null}},{key:"registerModule",value:function(e,t){this._callbacks.push(t)}},{key:"collectAndReport",value:function(){var e=this,t=0<arguments.length&&void 0!==arguments[0]&&arguments[0],r=this.template,n=this.tp2p.config,i=this.tp2p.status;this._callbacks.forEach(function(t){var n=t();e._combineData(r.i,n)}),t&&(r.i[u.ReportField.IS_FIRST_PIECE_DOWNLOAD]=i.isFirstPieceDownloaded,r.i[u.ReportField.EXIT_REASON]=i.closeReason||t,r.i[u.ReportField.PLAY_TIME]=o.default.timestamp()-n.loadTime,i.rollbackReason&&(r.i[u.ReportField.ROLLBACK_REASON]=i.rollbackReason)),this.report(r,t)}},{key:"onReportOnce",value:function(e){e.data_type=1;var t=this.template;Object.keys(e).forEach(function(r){t[r]=e[r]}),this.report(t)}},{key:"report",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];this.tp2p.trigger(i.default.REPORTING_DATA,{data:e,lastReport:t})}},{key:"_combineData",value:function(e,t){Object.keys(t).forEach(function(r){e[r]=t[r]})}},{key:"template",get:function(){var e=this.tp2p.config,t=this.tp2p.status;return{service:e.service,platform:e.platform,appid:e.appId,bizid:e.bizId,stream_id:e.channelId,module_id:e.moduleId,command:e.command,data_time:Math.round(o.default.timestamp()/1e3),version:s.default.version,video_type:"live",data_type:2,channel:e.channelId,partner:e.partner,uuid:c.default.myUUID().UUID,code:"000",str_video_type:"live",src_type:"auto",host:window.location.host,life:Math.round(o.default.timestamp()-e.startTime),cur_play_duration:Math.round(o.default.timestamp()-e.loadTime),url:e.originalUrl,referer:window.location.href,pro:"h5",browser_name:e.browser.name,browser_major:e.browser.major,browser_version:e.browser.version,user_agent:window.navigator.userAgent,roomid:e.roomId,str_user_id:c.default.myUUID().UUID,str_play_id:e.randomPlayId,page_visibility:d.default.pageVisibility().pageVisible,memory_usage:d.default.memory(),full_screen:d.default.isFullScreen(),open_visible:t.openVisible,arch:e.arch,log_version:"pcdn"===e.arch?1:0,conf_version:e.confVersion,cur_time:Date.now(),i:{}}}}]),t}();r.default=f},{18:18,19:19,77:77,79:79,82:82,85:85,89:89}],13:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=u(e(19)),a=u(e(18)),o=u(e(92)),s=u(e(89)),c=u(e(93));function u(e){return e&&e.__esModule?e:{default:e}}var d=function(e){function t(e){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i.default.REPORTING_DATA));return r.TAG="ReporterLoader",r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),n(t,[{key:"destroy",value:function(){a.default.prototype.destroy.call(this),this.tp2p=null}},{key:"onReportingData",value:function(e){var t,r,n,i=this.tp2p.config,a=new c.default,l=o.default.encrypt(JSON.stringify(e.data)),u="close"===e.lastReport;t={tag:s.default.timestamp(),url:i.reportServer,method:"POST",headers:[{header:"Content-Type",value:"application/octet-stream"}],data:l},r={timeout:i.reportLoadingTimeout,maxRetry:i.reportLoadingMaxRetry,retryDelay:i.reportLoadingRetryDelay,maxRetryDelay:i.reportLoadingMaxRetryDelay,sync:u},n={onSuccess:function(){},onError:function(){},onTimeout:function(){}},a.load(t,r,n)}}]),t}();r.default=d},{18:18,19:19,89:89,92:92,93:93}],14:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=c(e(19)),a=c(e(18)),o=c(e(21)),s=e(77);function c(e){return e&&e.__esModule?e:{default:e}}var u=function(e){function t(e){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i.default.TRACKER_LOADED,i.default.TRACKER_STARTING,i.default.TRACKER_STOPPING));return r.TAG="TrackerController",r.onRequestTracker=r._requestTracker.bind(r),r.peerCache=new o.default({maxCacheSize:e.config.peerCacheSize}),r._initReporterData(),r.tp2p.registerReportCallback(r.TAG,r.reportCallback.bind(r)),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),n(t,[{key:"destroy",value:function(){this._clearTimer(),a.default.prototype.destroy.call(this),this.tp2p=null}},{key:"onTrackerLoaded",value:function(e){var t=this;try{var r=JSON.parse(e.response);if(0===r.ret||"0"===r.ret){var n=r.peers;n.forEach(function(e){t.peerCache.add(e.pid,{streamId:e.stream})}),this._reportData[s.ReportField.T_PEER]+=n.length}}catch(e){}}},{key:"onTrackerStarting",value:function(){var e=this.tp2p.config;this._timer=setInterval(this.onRequestTracker,e.trackerInterval)}},{key:"onTrackerStopping",value:function(){this.stop()}},{key:"stop",value:function(){this.peerCache.clear(),this._clearTimer()}},{key:"nextStreamPeer",value:function(e){return this.peerCache.nextStreamPeer(e)}},{key:"_requestTracker",value:function(){var e=this.tp2p.config,t=this.tp2p.initiator,r=t.xStreamId,n=t.localPeerId;if(n&&e.useP2p){var a="";if(e.stunServer){var o=e.stunServer.split(":");a=this._ipToNumber(o[0])}var s=e.trackerServer+"/htbt?channel=h5_"+a+"_"+e.streams+"_"+e.channelId+"_"+e.trackerCustomVersion+"-"+e.trackerVersion+e.streams+"&resolution=UHD&pid="+n+"&streamId="+r+(e.localStreamShare?"&mode=bat":"");this.tp2p.trigger(i.default.TRACKER_LOADING,{url:s})}}},{key:"_ipToNumber",value:function(e){var t=0;if(""===e)return t;var r=e.split(".");return 4!==r.length?t:(t+=parseInt(r[0])<<24,t+=parseInt(r[1])<<16,t+=parseInt(r[2])<<8,t+=parseInt(r[3])<<0,t>>>=0)}},{key:"_clearTimer",value:function(){this._timer&&(clearInterval(this._timer),this._timer=null)}},{key:"_initReporterData",value:function(){this._reportData={},this._reportData[s.ReportField.T_PEER]=0}},{key:"reportCallback",value:function(){var e=this._reportData;return this._initReporterData(),e}},{key:"nextPeer",get:function(){return this.peerCache.nextPeer}}]),t}();r.default=u},{18:18,19:19,21:21,77:77}],15:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=c(e(19)),a=e(17),o=c(e(18)),s=c(e(93));function c(e){return e&&e.__esModule?e:{default:e}}var u=function(e){function t(e){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i.default.TRACKER_LOADING));return r.TAG="TrackerLoader",r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o.default),n(t,[{key:"destroy",value:function(){o.default.prototype.destroy.call(this),this._loader&&(this._loader.destroy(),this._loader=null),this.tp2p=null}},{key:"onTrackerLoading",value:function(e){this._loader&&this._loader.destroy();var t,r,n,i=this.tp2p.config;this._loader=new s.default,t={tag:"tracker_"+Date.now(),url:e.url,method:"GET",responseType:"text"},r={timeout:i.trackerTimeout,maxRetry:i.trackerMaxRetry,retryDelay:i.trackerRetryDelay,maxRetryDelay:i.trackerMaxRetryDelay},n={onSuccess:this.loadSuccess.bind(this),onError:this.loadError.bind(this),onTimeout:this.loadTimeout.bind(this)},this._loader.load(t,r,n)}},{key:"loadSuccess",value:function(e,t,r){3<arguments.length&&void 0!==arguments[3]&&arguments[3];var n=e.data;this.tp2p.trigger(i.default.TRACKER_LOADED,{response:n})}},{key:"loadError",value:function(e,t,r){3<arguments.length&&void 0!==arguments[3]&&arguments[3],this.tp2p.trigger(i.default.ERROR,{type:a.ErrorTypes.NETWORK_ERROR,details:a.ErrorDetails.REPORTER_LOAD_ERROR,fatal:!1,context:r})}},{key:"loadTimeout",value:function(e,t){2<arguments.length&&void 0!==arguments[2]&&arguments[2],this.tp2p.trigger(i.default.ERROR,{type:a.ErrorTypes.NETWORK_ERROR,details:a.ErrorDetails.REPORTER_LOAD_TIMEOUT,fatal:!1,context:t})}}]),t}();r.default=u},{17:17,18:18,19:19,93:93}],16:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=o(e(85)),a=o(e(90));function o(e){return e&&e.__esModule?e:{default:e}}var s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,null,[{key:"Url",value:function(e,t){var r=this.BasicHandleUrl(e);switch(t){case"h5.huya.com":var n=e.match(/&ratio=([^&]+)/);if(n){var i=r.channelId,a=r.sourceUrl,o=r.originalUrl;r.channelId+="_"+n[1],r.sourceUrl=a.replace(i,r.channelId),r.originalUrl=o.replace(i,r.channelId)}break;case"h5.panda.tv":-1!==e.indexOf("pl29")?(r.pcdnDomainMain="pl-pcdn29.live.panda.tv",r.pcdnDomainSub="pl-pcdn29-ztc.live.panda.tv"):-1!==e.indexOf("pl28")&&(r.pcdnDomainMain="pl-pcdn28.live.panda.tv",r.pcdnDomainSub="pl-pcdn28-ztc.live.panda.tv");break;case"h5.douyutv.com":-1!==e.indexOf("9699.liveplay.myqcloud.com")&&(r.pcdnDomainMain="mobilep1.douyucdn2.cn",r.pcdnDomainSub="mobilep2.douyucdn2.cn")}return r}},{key:"BasicHandleUrl",value:function(e){var t=this.createUrlObj();if(/rtmp:|http:|https:/.test(e)){t.sourceUrl=e.split("?")[0];var r=t.sourceUrl;0<r.lastIndexOf(".flv")?t.channelId=r.substring(r.lastIndexOf("/")+1,r.lastIndexOf(".flv")):t.channelId=r.substring(r.lastIndexOf("/")+1,r.length)}else t.sourceUrl=null,t.channelId=e;return t.originalUrl=e,t.isUrl=i.default.generateCid(e).isUrl,t.roomId=a.default.GetRoomIdFromUrl(e),t}},{key:"createUrlObj",value:function(){return{sourceUrl:"",originalUrl:"",channelId:"",isUrl:"",roomId:""}}},{key:"checkConfig",value:function(e,t){var r="",n="",i="";return t||(r="请传入p2pConfig"),t.videoId||(n='p2pConfig中参数中未检测到 video id,请传入videoId.\n 或者自行传入 meida element.\n let media = document.getElementById("your video id");\n qvbp2p.setMediaElement(media)\n'),t.src||(r="请在p2pConfig中填写src"),e._rollback||(i+="* 没有检测到回退函数 rollback, 如果不绑定rollback, 请确保在loader的onStateChange中处理了回退. \n"),{error:r,warn:n,log:i}}}]),e}();r.default=s},{85:85,90:90}],17:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.ErrorTypes={NETWORK_ERROR:"networkError",MEDIA_ERROR:"mediaError",MUX_ERROR:"muxError",OTHER_ERROR:"otherError"},r.ErrorDetails={CDN_LOAD_ERROR:"cdnLoadError",CDN_LOAD_TIMEOUT:"cdnLoadTimeout",CONF_LOAD_ERROR:"confLoadError",CONF_LOAD_TIMEOUT:"confLoadTimeout",CONF_DECRYPT_ERROR:"confDecryptError",REPORTER_LOAD_TIMEOUT:"reporterLoadTimeout",REPORTER_LOAD_ERROR:"reporterLoadError",PIECE_DEMUX_ERROR:"pieceDemuxError",STREAM_STOP:"streamStop",STUCK_ROLLBACK:"stuckRollback"}},{}],18:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==l(Symbol.iterator)?function(e){return void 0===e?"undefined":l(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":l(e)},i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=e(86),o=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.tp2p=t,this.onEvent=this.onEvent.bind(this);for(var r=arguments.length,n=Array(1<r?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];this.handledEvents=n,this.useGenericHandler=!0,this.registerListeners(),this.TAG="EventHandler"}return i(e,[{key:"destroy",value:function(){this.unregisterListeners()}},{key:"isEventHandler",value:function(){return"object"===n(this.handledEvents)&&this.handledEvents.length&&"function"==typeof this.onEvent}},{key:"registerListeners",value:function(){this.isEventHandler()&&this.handledEvents.forEach(function(e){if("tp2pEventGeneric"===e)throw new Error("Forbidden event name: "+e);this.tp2p.on(e,this.onEvent)}.bind(this))}},{key:"unregisterListeners",value:function(){this.isEventHandler()&&this.handledEvents.forEach(function(e){this.tp2p.off(e,this.onEvent)}.bind(this))}},{key:"onEvent",value:function(e,t){this.onEventGeneric(e,t)}},{key:"onEventGeneric",value:function(e,t){try{(function(e,t){var r="on"+e.replace("tp2p","");if("function"!=typeof this[r])throw new Error("Event "+e+" has no generic handler in this "+this.constructor.name+" class (tried "+r+")");return this[r].bind(this,t)}).call(this,e,t).call()}catch(t){a.logger.error("error happened while processing "+e+":"+t.message)}}},{key:"_logTitle",value:function(){return this.TAG+" ### "}}]),e}();r.default=o},{86:86}],19:[function(e,t,r){t.exports={CDN_DOWNLOAD_STARTING:"tp2pCdnDownloadStarting",CDN_DOWNLOAD_STOP:"tp2pCdnDownloadStop",CDN_LOADING:"tp2pCdnLoading",CDN_LOADED:"tp2pCdnLoaded",P2P_LOADED:"tp2pP2pLoaded",FRAG_LOADED:"tp2pFragLoaded",CDN_DOWNLOAD_RESET:"tp2pCdnDownloadReset",CDN_DOWNLOAD_PAUSE:"tp2pCdnDownloadPause",BUFFER_STASHING:"tp2pBufferStashing",BUFFER_REQUESTING:"tp2pBufferRequesting",CONF_LOADING:"tp2pConfLoading",CONF_LOADED:"tp2pConfLoaded",CONF_PARSING:"tp2pConfParsing",CREAT_PLAY:"tp2pCreatPlay",STATE_CHANGE:"tp2pStateChange",RECEIVE_STATE:"tp2pReceiveState",ERROR:"tp2pError",SYNC_STEP_BACK:"tp2pSyncStepBack",REPORT_ONCE:"tp2pReportOnce",REPORTING_DATA:"tp2pReportingData",REPORTER_STARTING:"tp2pReporterStarting",REPORTER_STOPPING:"tp2pReporterStopping",TRACKER_LOADING:"tp2pTrackerLoading",TRACKER_LOADED:"tp2pTrackerLoaded",TRACKER_STARTING:"tp2pTrackerStarting",TRACKER_STOPPING:"tp2pTrackerStopping",SIGNAL_SENDING:"tp2pSignalSending",SIGNAL_RECEIVING:"tp2pSignalReceiving",FAST_FORWARD:"tp2pFastForward",MEDIA_CREATED:"tp2pMediaCreated",WRITER_TICK:"tp2pWriterTick",FLV_HEAD_LOADED:"tp2pFlvHeadLoaded",LOADED_DATA:"tp2pLoadedData",FIRST_CONF_LOADED:"tp2pFirstConfLoaded",WRITE_SKIP:"tp2pWriteSkip",STOP_WRITE_SKIP:"tp2pStopWriteSkip",FILL_FRAGMENT_SUCCESS:"tp2pFillFragmentSuccess",FILL_FRAGMENT_FAIL:"tp2pFillFragmentFail",P2P_FILL_FRAGMENT_SUCCESS:"tp2pP2pFillFragmentSuccess",P2P_FILL_FRAGMENT_FAIL:"tp2pP2pFillFragmentFail",FOUND_SLICE:"tp2pFoundSlice",P2P_FILL_SUCCESS:"tp2pP2pFillSuccess",P2P_FILL_REQ:"tp2pP2pFillReq",P2P_FILL_RES:"tp2pP2pFillRes",TRY_P2P_FILL:"tp2pTryP2pFill",SUBSCRIBE_FILL:"tp2pSubscribeFill",PULL_SUB_STREAM:"tp2pPullSubStream",P2P_STARTING:"tp2pP2pStarting",P2P_STOPPING:"tp2pP2pStopping",STUCK_RELOAD:"tp2pStuckReload",CHANGE_PEER:"tp2pChangePeer",CONF_FAIL:"tp2pConfFail"}},{}],20:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=(n=e(89))&&n.__esModule?n:{default:n},o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="DataSet",this._set=new Set,this._keeper={}}return i(e,[{key:"destroy",value:function(){this.clear(),this._set=null,this._keeper=null}},{key:"add",value:function(e,t){if(this.has(e))return!1;this._set.add(e),this._keeper[e]={loader:t.loader,addTime:a.default.timestamp()}}},{key:"has",value:function(e){return this._set.has(e)}},{key:"get",value:function(e){return!!this.has(e)&&this._keeper[e]}},{key:"clear",value:function(){var e=this;this._set.forEach(function(t){e._deleteFromKeeper(t)}),this._set.clear(),this._keeper={}}},{key:"deletes",value:function(e){return!!this.has(e)&&(this._set.delete(e),this._deleteFromKeeper(e),!0)}},{key:"keys",value:function(){var e=this._set.keys();return[].concat(function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}(e))}},{key:"_deleteFromKeeper",value:function(e){try{this._keeper[e].loader.destroy(),delete this._keeper[e].loader,delete this._keeper[e]}catch(e){}}},{key:"_logTitle",value:function(){return this.TAG+" ### "}},{key:"size",get:function(){return this._set.size}}]),e}();r.default=o},{89:89}],21:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=o(e(20)),a=o(e(89));function o(e){return e&&e.__esModule?e:{default:e}}var s=function(e){function t(e){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(r.TAG="PeerCache",!e.maxCacheSize)throw Error('peer cache 初始化必填 "maxCacheSize"');return r._maxCacheSize=e.maxCacheSize,r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,i.default),n(t,[{key:"add",value:function(e,t){this.has(e)&&this.deletes(e),this._set.add(e),this._keeper[e]={streamId:t.streamId,addTime:a.default.timestamp()},this._keepSize()}},{key:"_keepSize",value:function(){var e=this.size-this._maxCacheSize;if(0<e){var t=this.keys(),r=void 0;for(r=0;r<e;r++){var n=t.shift();this.deletes(n)}}}},{key:"nextStreamPeer",value:function(e){var t=this.keys();if(0<t.length){for(var r=null,n=0;n<t.length;n++){var i=t[n],a=this._keeper[i].streamId;if(a===e){r={peerId:i,streamId:a};break}}return r&&this.deletes(r.peerId),r}return null}},{key:"_deleteFromKeeper",value:function(e){try{delete this._keeper[e]}catch(e){}}},{key:"nextPeer",get:function(){var e=this.keys();if(0<e.length){var t=e.pop(),r=this._keeper[t].streamId;return this.deletes(t),{peerId:t,streamId:r}}return null}}]),t}();r.default=s},{20:20,89:89}],22:[function(e,t,r){var n=e(79).default;window.QVBP2P=n,t.exports=n},{79:79}],23:[function(e,t,n){(function(r){var i="function"==typeof Symbol&&"symbol"==l(Symbol.iterator)?function(e){return void 0===e?"undefined":l(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":l(e)};!function(e){"object"==(void 0===n?"undefined":i(n))&&void 0!==t?t.exports=e():("undefined"!=typeof window?window:void 0!==r?r:"undefined"!=typeof self?self:this).adapter=e()}(function(){return function t(r,n,i){function a(s,l){if(!n[s]){if(!r[s]){var c="function"==typeof e&&e;if(!l&&c)return c(s,!0);if(o)return o(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var d=n[s]={exports:{}};r[s][0].call(d.exports,function(e){return a(r[s][1][e]||e)},d,d.exports,t,r,n,i)}return n[s].exports}for(var o="function"==typeof e&&e,s=0;s<i.length;s++)a(i[s]);return a}({1:[function(e,t,r){},{}],2:[function(e,t,r){var n={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};n.localCName=n.generateIdentifier(),n.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},n.splitSections=function(e){return e.split("\nm=").map(function(e,t){return(0<t?"m="+e:e).trim()+"\r\n"})},n.getDescription=function(e){var t=n.splitSections(e);return t&&t[0]},n.getMediaSections=function(e){var t=n.splitSections(e);return t.shift(),t},n.matchPrefix=function(e,t){return n.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},n.parseCandidate=function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1];break;case"ufrag":r.ufrag=t[n+1],r.usernameFragment=t[n+1];break;default:r[t[n]]=t[n+1]}return r},n.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},n.parseIceOptions=function(e){return e.substr(14).split(" ")},n.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},n.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},n.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:0<t[0].indexOf("/")?t[0].split("/")[1]:"sendrecv",uri:t[1]}},n.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},n.parseFmtp=function(e){for(var t,r={},n=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<n.length;i++)r[(t=n[i].trim().split("="))[0].trim()]=t[1];return r},n.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach(function(t){e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)}),t+="a=fmtp:"+r+" "+n.join(";")+"\r\n"}return t},n.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},n.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},n.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return-1<n?(r.attribute=e.substr(t+1,n-t-1),r.value=e.substr(n+1)):r.attribute=e.substr(t+1),r},n.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}},n.getMid=function(e){var t=n.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},n.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},n.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:n.matchPrefix(e+t,"a=fingerprint:").map(n.parseFingerprint)}},n.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),r},n.getIceParameters=function(e,t){var r=n.splitLines(e);return{usernameFragment:(r=r.concat(n.splitLines(t))).filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:r.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)}},n.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},n.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=n.splitLines(e)[0].split(" "),i=3;i<r.length;i++){var a=r[i],o=n.matchPrefix(e,"a=rtpmap:"+a+" ")[0];if(o){var s=n.parseRtpMap(o),l=n.matchPrefix(e,"a=fmtp:"+a+" ");switch(s.parameters=l.length?n.parseFmtp(l[0]):{},s.rtcpFeedback=n.matchPrefix(e,"a=rtcp-fb:"+a+" ").map(n.parseRtcpFb),t.codecs.push(s),s.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(s.name.toUpperCase())}}}return n.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(n.parseExtmap(e))}),t},n.writeRtpDescription=function(e,t){var r="";r+="m="+e+" ",r+=0<t.codecs.length?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){r+=n.writeRtpMap(e),r+=n.writeFmtp(e),r+=n.writeRtcpFb(e)});var i=0;return t.codecs.forEach(function(e){e.maxptime>i&&(i=e.maxptime)}),0<i&&(r+="a=maxptime:"+i+"\r\n"),r+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach(function(e){r+=n.writeExtmap(e)}),r},n.parseRtpEncodingParameters=function(e){var t,r=[],i=n.parseRtpParameters(e),a=-1!==i.fecMechanisms.indexOf("RED"),o=-1!==i.fecMechanisms.indexOf("ULPFEC"),s=n.matchPrefix(e,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),l=0<s.length&&s[0].ssrc,c=n.matchPrefix(e,"a=ssrc-group:FID").map(function(e){return e.substr(17).split(" ").map(function(e){return parseInt(e,10)})});0<c.length&&1<c[0].length&&c[0][0]===l&&(t=c[0][1]),i.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var n={ssrc:l,codecPayloadType:parseInt(e.parameters.apt,10)};l&&t&&(n.rtx={ssrc:t}),r.push(n),a&&((n=JSON.parse(JSON.stringify(n))).fec={ssrc:l,mechanism:o?"red+ulpfec":"red"},r.push(n))}}),0===r.length&&l&&r.push({ssrc:l});var u=n.matchPrefix(e,"b=");return u.length&&(u=0===u[0].indexOf("b=TIAS:")?parseInt(u[0].substr(7),10):0===u[0].indexOf("b=AS:")?1e3*parseInt(u[0].substr(5),10)*.95-16e3:void 0,r.forEach(function(e){e.maxBitrate=u})),r},n.parseRtcpParameters=function(e){var t={},r=n.matchPrefix(e,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];r&&(t.cname=r.value,t.ssrc=r.ssrc);var i=n.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=0<i.length,t.compound=0===i.length;var a=n.matchPrefix(e,"a=rtcp-mux");return t.mux=0<a.length,t},n.parseMsid=function(e){var t,r=n.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(t=r[0].substr(7).split(" "))[0],track:t[1]};var i=n.matchPrefix(e,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});return 0<i.length?{stream:(t=i[0].value.split(" "))[0],track:t[1]}:void 0},n.generateSessionId=function(){return Math.random().toString().substr(2,21)},n.writeSessionBoilerplate=function(e,t,r){var i=void 0!==t?t:2;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(e||n.generateSessionId())+" "+i+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},n.writeMediaSection=function(e,t,r,i){var a=n.writeRtpDescription(e.kind,t);if(a+=n.writeIceParameters(e.iceGatherer.getLocalParameters()),a+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),a+="a=mid:"+e.mid+"\r\n",e.direction?a+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?a+="a=sendrecv\r\n":e.rtpSender?a+="a=sendonly\r\n":e.rtpReceiver?a+="a=recvonly\r\n":a+="a=inactive\r\n",e.rtpSender){var o="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n";a+="a="+o,a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,a+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"),a},n.getDirection=function(e,t){for(var r=n.splitLines(e),i=0;i<r.length;i++)switch(r[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[i].substr(2)}return t?n.getDirection(t):"sendrecv"},n.getKind=function(e){return n.splitLines(e)[0].split(" ")[0].substr(2)},n.isRejected=function(e){return"0"===e.split(" ",2)[1]},n.parseMLine=function(e){var t=n.splitLines(e)[0].substr(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},n.parseOLine=function(e){var t=n.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},n.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=n.splitLines(e),r=0;r<t.length;r++)if(t[r].length<2||"="!==t[r].charAt(1))return!1;return!0},"object"==(void 0===t?"undefined":i(t))&&(t.exports=n)},{}],3:[function(e,t,n){(function(r){var n=e("./adapter_factory.js");t.exports=n({window:r.window})}).call(this,void 0!==r?r:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./adapter_factory.js":4}],4:[function(e,t,r){var n=e("./utils");t.exports=function(t,r){var i=t&&t.window,a={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0};for(var o in r)hasOwnProperty.call(r,o)&&(a[o]=r[o]);var s=n.log,l=n.detectBrowser(i),c=e("./chrome/chrome_shim")||null,u=e("./edge/edge_shim")||null,d=e("./firefox/firefox_shim")||null,p=e("./safari/safari_shim")||null,f=e("./common_shim")||null,h={browserDetails:l,commonShim:f,extractVersion:n.extractVersion,disableLog:n.disableLog,disableWarnings:n.disableWarnings};switch(l.browser){case"chrome":if(!c||!c.shimPeerConnection||!a.shimChrome)return s("Chrome shim is not included in this adapter release."),h;s("adapter.js shimming chrome."),h.browserShim=c,f.shimCreateObjectURL(i),c.shimGetUserMedia(i),c.shimMediaStream(i),c.shimSourceObject(i),c.shimPeerConnection(i),c.shimOnTrack(i),c.shimAddTrackRemoveTrack(i),c.shimGetSendersWithDtmf(i),c.shimSenderReceiverGetStats(i),c.fixNegotiationNeeded(i),f.shimRTCIceCandidate(i),f.shimMaxMessageSize(i),f.shimSendThrowTypeError(i);break;case"firefox":if(!d||!d.shimPeerConnection||!a.shimFirefox)return s("Firefox shim is not included in this adapter release."),h;s("adapter.js shimming firefox."),h.browserShim=d,f.shimCreateObjectURL(i),d.shimGetUserMedia(i),d.shimSourceObject(i),d.shimPeerConnection(i),d.shimOnTrack(i),d.shimRemoveStream(i),d.shimSenderGetStats(i),d.shimReceiverGetStats(i),d.shimRTCDataChannel(i),f.shimRTCIceCandidate(i),f.shimMaxMessageSize(i),f.shimSendThrowTypeError(i);break;case"edge":if(!u||!u.shimPeerConnection||!a.shimEdge)return s("MS edge shim is not included in this adapter release."),h;s("adapter.js shimming edge."),h.browserShim=u,f.shimCreateObjectURL(i),u.shimGetUserMedia(i),u.shimPeerConnection(i),u.shimReplaceTrack(i),f.shimMaxMessageSize(i),f.shimSendThrowTypeError(i);break;case"safari":if(!p||!a.shimSafari)return s("Safari shim is not included in this adapter release."),h;s("adapter.js shimming safari."),h.browserShim=p,f.shimCreateObjectURL(i),p.shimRTCIceServerUrls(i),p.shimCreateOfferLegacy(i),p.shimCallbacksAPI(i),p.shimLocalStreamsAPI(i),p.shimRemoteStreamsAPI(i),p.shimTrackEventTransceiver(i),p.shimGetUserMedia(i),f.shimRTCIceCandidate(i),f.shimMaxMessageSize(i),f.shimSendThrowTypeError(i);break;default:s("Unsupported browser!")}return h}},{"./chrome/chrome_shim":5,"./common_shim":7,"./edge/edge_shim":1,"./firefox/firefox_shim":8,"./safari/safari_shim":10,"./utils":11}],5:[function(e,t,r){var n=e("../utils.js"),a=n.log;function o(e,t,r){var n=r?"outbound-rtp":"inbound-rtp",i=new Map;if(null===t)return i;var a=[];return e.forEach(function(e){"track"===e.type&&e.trackIdentifier===t.id&&a.push(e)}),a.forEach(function(t){e.forEach(function(t){t.type===n&&t.trackId===r.id&&function e(t,r,n){r&&!n.has(r.id)&&(n.set(r.id,r),Object.keys(r).forEach(function(i){i.endsWith("Id")?e(t,t.get(r[i]),n):i.endsWith("Ids")&&r[i].forEach(function(r){e(t,t.get(r),n)})}))}(e,t,i)})}),i}t.exports={shimGetUserMedia:e("./getusermedia"),shimMediaStream:function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},shimOnTrack:function(e){if("object"!=(void 0===e?"undefined":i(e))||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype)n.wrapPeerConnectionEvent(e,"track",function(e){return e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e});else{Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var r=this;return r._ontrackpoly||(r._ontrackpoly=function(t){t.stream.addEventListener("addtrack",function(n){var i;i=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find(function(e){return e.track&&e.track.id===n.track.id}):{track:n.track};var a=new Event("track");a.track=n.track,a.receiver=i,a.transceiver={receiver:i},a.streams=[t.stream],r.dispatchEvent(a)}),t.stream.getTracks().forEach(function(n){var i;i=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find(function(e){return e.track&&e.track.id===n.id}):{track:n};var a=new Event("track");a.track=n,a.receiver=i,a.transceiver={receiver:i},a.streams=[t.stream],r.dispatchEvent(a)})},r.addEventListener("addstream",r._ontrackpoly)),t.apply(r,arguments)}}},shimGetSendersWithDtmf:function(e){if("object"==(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){var i=r.apply(this,arguments);return i||(i=t(this,e),this._senders.push(i)),i};var n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);var t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}var a=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;r._senders=r._senders||[],a.apply(r,[e]),e.getTracks().forEach(function(e){r._senders.push(t(r,e))})};var o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._senders=t._senders||[],o.apply(t,[e]),e.getTracks().forEach(function(e){var r=t._senders.find(function(t){return t.track===e});r&&t._senders.splice(t._senders.indexOf(r),1)})}}else if("object"==(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var s=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=s.apply(e,[]);return t.forEach(function(t){t._pc=e}),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},shimSenderReceiverGetStats:function(e){if("object"==(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver){if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(e,[]);return r.forEach(function(t){t._pc=e}),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this._pc.getStats().then(function(t){return o(t,e.track,!0)})}}if(!("getStats"in e.RTCRtpReceiver.prototype)){var a=e.RTCPeerConnection.prototype.getReceivers;a&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=a.apply(e,[]);return t.forEach(function(t){t._pc=e}),t}),n.wrapPeerConnectionEvent(e,"track",function(e){return e.receiver._pc=e.srcElement,e}),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this._pc.getStats().then(function(t){return o(t,e.track,!1)})}}if("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype){var s=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(0<arguments.length&&arguments[0]instanceof e.MediaStreamTrack){var t,r,n,i=arguments[0];return this.getSenders().forEach(function(e){e.track===i&&(t?n=!0:t=e)}),this.getReceivers().forEach(function(e){return e.track===i&&(r?n=!0:r=e),e.track===i}),n||t&&r?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():r?r.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return s.apply(this,arguments)}}}},shimSourceObject:function(e){var t=e&&e.URL;"object"==(void 0===e?"undefined":i(e))&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var r=this;this._srcObject=e,this.src&&t.revokeObjectURL(this.src),e?(this.src=t.createObjectURL(e),e.addEventListener("addtrack",function(){r.src&&t.revokeObjectURL(r.src),r.src=t.createObjectURL(e)}),e.addEventListener("removetrack",function(){r.src&&t.revokeObjectURL(r.src),r.src=t.createObjectURL(e)})):this.src=""}}))},shimAddTrackRemoveTrackWithNative:function(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(function(t){return e._shimmedLocalStreams[t][0]})};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var n=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(n)&&this._shimmedLocalStreams[r.id].push(n):this._shimmedLocalStreams[r.id]=[r,n],n};var r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(function(e){if(t.getSenders().find(function(t){return t.track===e}))throw new DOMException("Track already exists.","InvalidAccessError")});var n=t.getSenders();r.apply(this,arguments);var i=t.getSenders().filter(function(e){return-1===n.indexOf(e)});this._shimmedLocalStreams[e.id]=[e].concat(i)};var n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};var i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(function(r){var n=t._shimmedLocalStreams[r].indexOf(e);-1!==n&&t._shimmedLocalStreams[r].splice(n,1),1===t._shimmedLocalStreams[r].length&&delete t._shimmedLocalStreams[r]}),i.apply(this,arguments)}},shimAddTrackRemoveTrack:function(e){var t=n.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&65<=t.version)return this.shimAddTrackRemoveTrackWithNative(e);var r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=r.apply(this);return e._reverseStreams=e._reverseStreams||{},t.map(function(t){return e._reverseStreams[t.id]})};var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var r=this;if(r._streams=r._streams||{},r._reverseStreams=r._reverseStreams||{},t.getTracks().forEach(function(e){if(r.getSenders().find(function(t){return t.track===e}))throw new DOMException("Track already exists.","InvalidAccessError")}),!r._reverseStreams[t.id]){var n=new e.MediaStream(t.getTracks());r._streams[t.id]=n,r._reverseStreams[n.id]=t,t=n}i.apply(r,[t])};var a=e.RTCPeerConnection.prototype.removeStream;function o(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var n=e._reverseStreams[t],i=e._streams[n.id];r=r.replace(new RegExp(i.id,"g"),n.id)}),new RTCSessionDescription({type:t.type,sdp:r})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},a.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,r){var n=this;if("closed"===n.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find(function(e){return e===t}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(n.getSenders().find(function(e){return e.track===t}))throw new DOMException("Track already exists.","InvalidAccessError");n._streams=n._streams||{},n._reverseStreams=n._reverseStreams||{};var a=n._streams[r.id];if(a)a.addTrack(t),Promise.resolve().then(function(){n.dispatchEvent(new Event("negotiationneeded"))});else{var o=new e.MediaStream([t]);n._streams[r.id]=o,n._reverseStreams[o.id]=r,n.addStream(o)}return n.getSenders().find(function(e){return e.track===t})},["createOffer","createAnswer"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this,t=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(e,[function(r){var n=o(e,r);t[0].apply(null,[n])},function(e){t[1]&&t[1].apply(null,e)},arguments[2]]):r.apply(e,arguments).then(function(t){return o(e,t)})}});var s=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){var e,t,r;return arguments.length&&arguments[0].type&&(arguments[0]=(e=this,t=arguments[0],r=t.sdp,Object.keys(e._reverseStreams||[]).forEach(function(t){var n=e._reverseStreams[t],i=e._streams[n.id];r=r.replace(new RegExp(n.id,"g"),i.id)}),new RTCSessionDescription({type:t.type,sdp:r}))),s.apply(this,arguments)};var l=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=l.get.apply(this);return""===e.type?e:o(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t,r=this;if("closed"===r.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==r)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");r._streams=r._streams||{},Object.keys(r._streams).forEach(function(n){r._streams[n].getTracks().find(function(t){return e.track===t})&&(t=r._streams[n])}),t&&(1===t.getTracks().length?r.removeStream(r._reverseStreams[t.id]):t.removeTrack(e.track),r.dispatchEvent(new Event("negotiationneeded")))}},shimPeerConnection:function(e){var t=n.detectBrowser(e);!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=function(t,r){return a("PeerConnection"),t&&t.iceTransportPolicy&&(t.iceTransports=t.iceTransportPolicy),new e.webkitRTCPeerConnection(t,r)},e.RTCPeerConnection.prototype=e.webkitRTCPeerConnection.prototype,e.webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.webkitRTCPeerConnection.generateCertificate}}));var r=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,t,n){var i=this,a=arguments;if(0<arguments.length&&"function"==typeof e)return r.apply(this,arguments);if(0===r.length&&(0===arguments.length||"function"!=typeof e))return r.apply(this,[]);var o=function(e){var t={};return e.result().forEach(function(e){var r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(function(t){r[t]=e.stat(t)}),t[r.id]=r}),t},s=function(e){return new Map(Object.keys(e).map(function(t){return[t,e[t]]}))};return 2<=arguments.length?r.apply(this,[function(e){a[1](s(o(e)))},e]):new Promise(function(e,t){r.apply(i,[function(t){e(s(o(t)))},t])}).then(t,n)},t.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=arguments,t=this,n=new Promise(function(n,i){r.apply(t,[e[0],n,i])});return e.length<2?n:n.then(function(){e[1].apply(null,[])},function(t){3<=e.length&&e[2].apply(null,[t])})}}),t.version<52&&["createOffer","createAnswer"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"==i(arguments[0])){var t=1===arguments.length?arguments[0]:void 0;return new Promise(function(n,i){r.apply(e,[n,i,t])})}return r.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}});var o=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?o.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}},fixNegotiationNeeded:function(e){n.wrapPeerConnectionEvent(e,"negotiationneeded",function(e){if("stable"===e.target.signalingState)return e})},shimGetDisplayMedia:function(e,t){"getDisplayMedia"in e.navigator||"function"==typeof t&&(navigator.getDisplayMedia=function(e){return t(e).then(function(t){return e.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:e.video.frameRate||3}},e.video&&(e.video.height&&(e.video.maxWidth=e.video.width),e.video.width&&(e.video.maxHeight=e.video.height)),navigator.mediaDevices.getUserMedia(e)})})}}},{"../utils.js":11,"./getusermedia":6}],6:[function(e,t,r){var n=e("../utils.js"),a=n.log;t.exports=function(e){var t=n.detectBrowser(e),r=e&&e.navigator,o=function(e){if("object"!=(void 0===e?"undefined":i(e))||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(r){if("require"!==r&&"advanced"!==r&&"mediaSource"!==r){var n="object"==i(e[r])?e[r]:{ideal:e[r]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);var a=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];var o={};"number"==typeof n.ideal?(o[a("min",r)]=n.ideal,t.optional.push(o),(o={})[a("max",r)]=n.ideal):o[a("",r)]=n.ideal,t.optional.push(o)}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[a("",r)]=n.exact):["min","max"].forEach(function(e){void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[a(e,r)]=n[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},s=function(e,n){if(61<=t.version)return n(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==i(e.audio)){var s=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};s((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),s(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=o(e.audio)}if(e&&"object"==i(e.video)){var l=e.video.facingMode;l=l&&("object"==(void 0===l?"undefined":i(l))?l:{ideal:l});var c,u=t.version<66;if(l&&("user"===l.exact||"environment"===l.exact||"user"===l.ideal||"environment"===l.ideal)&&(!r.mediaDevices.getSupportedConstraints||!r.mediaDevices.getSupportedConstraints().facingMode||u)&&(delete e.video.facingMode,"environment"===l.exact||"environment"===l.ideal?c=["back","rear"]:"user"!==l.exact&&"user"!==l.ideal||(c=["front"]),c))return r.mediaDevices.enumerateDevices().then(function(t){var r=(t=t.filter(function(e){return"videoinput"===e.kind})).find(function(e){return c.some(function(t){return-1!==e.label.toLowerCase().indexOf(t)})});return!r&&t.length&&-1!==c.indexOf("back")&&(r=t[t.length-1]),r&&(e.video.deviceId=l.exact?{exact:r.deviceId}:{ideal:r.deviceId}),e.video=o(e.video),a("chrome: "+JSON.stringify(e)),n(e)});e.video=o(e.video)}return a("chrome: "+JSON.stringify(e)),n(e)},l=function(e){return 64<=t.version?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};r.getUserMedia=function(e,t,n){s(e,function(e){r.webkitGetUserMedia(e,t,function(e){n&&n(l(e))})})};var c=function(e){return new Promise(function(t,n){r.getUserMedia(e,t,n)})};if(r.mediaDevices||(r.mediaDevices={getUserMedia:c,enumerateDevices:function(){return new Promise(function(t){var r={audio:"audioinput",video:"videoinput"};return e.MediaStreamTrack.getSources(function(e){t(e.map(function(e){return{label:e.label,kind:r[e.kind],deviceId:e.id,groupId:""}}))})})},getSupportedConstraints:function(){return{deviceId:!0,echoCancellation:!0,facingMode:!0,frameRate:!0,height:!0,width:!0}}}),r.mediaDevices.getUserMedia){var u=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(e){return s(e,function(e){return u(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(e){return Promise.reject(l(e))})})}}else r.mediaDevices.getUserMedia=function(e){return c(e)};void 0===r.mediaDevices.addEventListener&&(r.mediaDevices.addEventListener=function(){a("Dummy mediaDevices.addEventListener called.")}),void 0===r.mediaDevices.removeEventListener&&(r.mediaDevices.removeEventListener=function(){a("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":11}],7:[function(e,t,r){var n=e("sdp"),a=e("./utils");t.exports={shimRTCIceCandidate:function(e){if(e.RTCIceCandidate&&!(e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==(void 0===e?"undefined":i(e))&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var r=new t(e),a=n.parseCandidate(e.candidate),o=Object.assign(r,a);return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,a.wrapPeerConnectionEvent(e,"icecandidate",function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t})}},shimCreateObjectURL:function(e){var t=e&&e.URL;if("object"==(void 0===e?"undefined":i(e))&&e.HTMLMediaElement&&"srcObject"in e.HTMLMediaElement.prototype&&t.createObjectURL&&t.revokeObjectURL){var r=t.createObjectURL.bind(t),n=t.revokeObjectURL.bind(t),o=new Map,s=0;t.createObjectURL=function(e){if("getTracks"in e){var t="polyblob:"+ ++s;return o.set(t,e),a.deprecated("URL.createObjectURL(stream)","elem.srcObject = stream"),t}return r(e)},t.revokeObjectURL=function(e){n(e),o.delete(e)};var l=Object.getOwnPropertyDescriptor(e.HTMLMediaElement.prototype,"src");Object.defineProperty(e.HTMLMediaElement.prototype,"src",{get:function(){return l.get.apply(this)},set:function(e){return this.srcObject=o.get(e)||null,l.set.apply(this,[e])}});var c=e.HTMLMediaElement.prototype.setAttribute;e.HTMLMediaElement.prototype.setAttribute=function(){return 2===arguments.length&&"src"===(""+arguments[0]).toLowerCase()&&(this.srcObject=o.get(arguments[1])||null),c.apply(this,arguments)}}},shimMaxMessageSize:function(e){if(!e.RTCSctpTransport&&e.RTCPeerConnection){var t=a.detectBrowser(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}});var r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e,i,a,o;if(this._sctp=null,a=arguments[0],(o=n.splitSections(a.sdp)).shift(),o.some(function(e){var t=n.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})){var s,l=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;var r=parseInt(t[1],10);return r!=r?-1:r}(arguments[0]),c=(e=l,i=65536,"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i),u=function(e,r){var i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);var a=n.matchPrefix(e.sdp,"a=max-message-size:");return 0<a.length?i=parseInt(a[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(i=2147483637),i}(arguments[0],l);s=0===c&&0===u?Number.POSITIVE_INFINITY:0===c||0===u?Math.max(c,u):Math.min(c,u);var d={};Object.defineProperty(d,"maxMessageSize",{get:function(){return s}}),this._sctp=d}return r.apply(this,arguments)}}},shimSendThrowTypeError:function(e){if(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype){var t=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=t.apply(this,arguments);return r(e,this),e},a.wrapPeerConnectionEvent(e,"datachannel",function(e){return r(e.channel,e.target),e})}function r(e,t){var r=e.send;e.send=function(){var n=arguments[0],i=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&i>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}}}},{"./utils":11,sdp:2}],8:[function(e,t,r){var n=e("../utils");t.exports={shimGetUserMedia:e("./getusermedia"),shimOnTrack:function(e){"object"!=(void 0===e?"undefined":i(e))||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(t){var r=new Event("track");r.track=t,r.receiver={track:t},r.transceiver={receiver:r.receiver},r.streams=[e.stream],this.dispatchEvent(r)}.bind(this))}.bind(this))},enumerable:!0,configurable:!0}),"object"==(void 0===e?"undefined":i(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimSourceObject:function(e){"object"==(void 0===e?"undefined":i(e))&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}}))},shimPeerConnection:function(e){var t=n.detectBrowser(e);if("object"==(void 0===e?"undefined":i(e))&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){e.RTCPeerConnection||(e.RTCPeerConnection=function(r,n){if(t.version<38&&r&&r.iceServers){for(var i=[],a=0;a<r.iceServers.length;a++){var o=r.iceServers[a];if(o.hasOwnProperty("urls"))for(var s=0;s<o.urls.length;s++){var l={url:o.urls[s]};0===o.urls[s].indexOf("turn")&&(l.username=o.username,l.credential=o.credential),i.push(l)}else i.push(r.iceServers[a])}r.iceServers=i}return new e.mozRTCPeerConnection(r,n)},e.RTCPeerConnection.prototype=e.mozRTCPeerConnection.prototype,e.mozRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.mozRTCPeerConnection.generateCertificate}}),e.RTCSessionDescription=e.mozRTCSessionDescription,e.RTCIceCandidate=e.mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}});var r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var a={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},o=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,r,n){return o.apply(this,[e||null]).then(function(e){var n,i;if(t.version<48&&(n=e,i=new Map,Object.keys(n).forEach(function(e){i.set(e,n[e]),i[e]=n[e]}),e=i),t.version<53&&!r)try{e.forEach(function(e){e.type=a[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;e.forEach(function(t,r){e.set(r,Object.assign({},t,{type:a[t.type]||t.type}))})}return e}).then(r,n)}}},shimSenderGetStats:function(e){if("object"==(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(e,[]);return r.forEach(function(t){t._pc=e}),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}},shimReceiverGetStats:function(e){if("object"==(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)){var t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,r=t.apply(e,[]);return r.forEach(function(t){t._pc=e}),r}),n.wrapPeerConnectionEvent(e,"track",function(e){return e.receiver._pc=e.srcElement,e}),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}},shimRemoveStream:function(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;n.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(r){r.track&&-1!==e.getTracks().indexOf(r.track)&&t.removeTrack(r)})})},shimRTCDataChannel:function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)},shimGetDisplayMedia:function(e,t){"getDisplayMedia"in e.navigator||(navigator.getDisplayMedia=function(e){if(e&&e.video)return!0===e.video?e.video={mediaSource:t}:e.video.mediaSource=t,navigator.mediaDevices.getUserMedia(e);var r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)})}}},{"../utils":11,"./getusermedia":9}],9:[function(e,t,r){var n=e("../utils"),a=n.log;t.exports=function(e){var t=n.detectBrowser(e),r=e&&e.navigator,o=e&&e.MediaStreamTrack,s=function(e){return{name:{InternalError:"NotReadableError",NotSupportedError:"TypeError",PermissionDeniedError:"NotAllowedError",SecurityError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},l=function(e,n,o){var l=function(e){if("object"!=(void 0===e?"undefined":i(e))||e.require)return e;var t=[];return Object.keys(e).forEach(function(r){if("require"!==r&&"advanced"!==r&&"mediaSource"!==r){var n=e[r]="object"==i(e[r])?e[r]:{ideal:e[r]};if(void 0===n.min&&void 0===n.max&&void 0===n.exact||t.push(r),void 0!==n.exact&&("number"==typeof n.exact?n.min=n.max=n.exact:e[r]=n.exact,delete n.exact),void 0!==n.ideal){e.advanced=e.advanced||[];var a={};"number"==typeof n.ideal?a[r]={min:n.ideal,max:n.ideal}:a[r]=n.ideal,e.advanced.push(a),delete n.ideal,Object.keys(n).length||delete e[r]}}}),t.length&&(e.require=t),e};return e=JSON.parse(JSON.stringify(e)),t.version<38&&(a("spec: "+JSON.stringify(e)),e.audio&&(e.audio=l(e.audio)),e.video&&(e.video=l(e.video)),a("ff37: "+JSON.stringify(e))),r.mozGetUserMedia(e,n,function(e){o(s(e))})};if(r.mediaDevices||(r.mediaDevices={getUserMedia:function(e){return new Promise(function(t,r){l(e,t,r)})},addEventListener:function(){},removeEventListener:function(){}}),r.mediaDevices.enumerateDevices=r.mediaDevices.enumerateDevices||function(){return new Promise(function(e){e([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}])})},t.version<41){var c=r.mediaDevices.enumerateDevices.bind(r.mediaDevices);r.mediaDevices.enumerateDevices=function(){return c().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}if(t.version<49){var u=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(e){return u(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("The object can not be found here.","NotFoundError");return t},function(e){return Promise.reject(s(e))})}}if(!(55<t.version&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){var d=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},p=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(e){return"object"==(void 0===e?"undefined":i(e))&&"object"==i(e.audio)&&(e=JSON.parse(JSON.stringify(e)),d(e.audio,"autoGainControl","mozAutoGainControl"),d(e.audio,"noiseSuppression","mozNoiseSuppression")),p(e)},o&&o.prototype.getSettings){var f=o.prototype.getSettings;o.prototype.getSettings=function(){var e=f.apply(this,arguments);return d(e,"mozAutoGainControl","autoGainControl"),d(e,"mozNoiseSuppression","noiseSuppression"),e}}if(o&&o.prototype.applyConstraints){var h=o.prototype.applyConstraints;o.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"==(void 0===e?"undefined":i(e))&&(e=JSON.parse(JSON.stringify(e)),d(e,"autoGainControl","mozAutoGainControl"),d(e,"noiseSuppression","mozNoiseSuppression")),h.apply(this,[e])}}}r.getUserMedia=function(e,i,a){if(t.version<44)return l(e,i,a);n.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(i,a)}}},{"../utils":11}],10:[function(e,t,r){var n=e("../utils");t.exports={shimLocalStreamsAPI:function(e){if("object"==(void 0===e?"undefined":i(e))&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),"getStreamById"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getStreamById=function(e){var t=null;return this._localStreams&&this._localStreams.forEach(function(r){r.id===e&&(t=r)}),this._remoteStreams&&this._remoteStreams.forEach(function(r){r.id===e&&(t=r)}),t}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),-1===this._localStreams.indexOf(e)&&this._localStreams.push(e);var r=this;e.getTracks().forEach(function(n){t.call(r,n,e)})},e.RTCPeerConnection.prototype.addTrack=function(e,r){return r&&(this._localStreams?-1===this._localStreams.indexOf(r)&&this._localStreams.push(r):this._localStreams=[r]),t.call(this,e,r)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);var t=this._localStreams.indexOf(e);if(-1!==t){this._localStreams.splice(t,1);var r=this,n=e.getTracks();this.getSenders().forEach(function(e){-1!==n.indexOf(e.track)&&r.removeTrack(e)})}})}},shimRemoteStreamsAPI:function(e){if("object"==(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){this._onaddstream&&this.removeEventListener("addstream",this._onaddstream),this.addEventListener("addstream",this._onaddstream=e)}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(function(t){if(e._remoteStreams||(e._remoteStreams=[]),!(0<=e._remoteStreams.indexOf(t))){e._remoteStreams.push(t);var r=new Event("addstream");r.stream=t,e.dispatchEvent(r)}})}),t.apply(e,arguments)}}},shimCallbacksAPI:function(e){if("object"==(void 0===e?"undefined":i(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,r=t.createOffer,n=t.createAnswer,a=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){var n=2<=arguments.length?arguments[2]:e,i=r.apply(this,[n]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){var r=2<=arguments.length?arguments[2]:e,i=n.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i};var l=function(e,t,r){var n=a.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n};t.setLocalDescription=l,l=function(e,t,r){var n=o.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.setRemoteDescription=l,l=function(e,t,r){var n=s.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.addIceCandidate=l}},shimGetUserMedia:function(e){var t=e&&e.navigator;t.getUserMedia||(t.webkitGetUserMedia?t.getUserMedia=t.webkitGetUserMedia.bind(t):t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,n){t.mediaDevices.getUserMedia(e).then(r,n)}.bind(t)))},shimRTCIceServerUrls:function(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){for(var i=[],a=0;a<e.iceServers.length;a++){var o=e.iceServers[a];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(n.deprecated("RTCIceServer.url","RTCIceServer.urls"),(o=JSON.parse(JSON.stringify(o))).urls=o.url,delete o.url,i.push(o)):i.push(e.iceServers[a])}e.iceServers=i}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})},shimTrackEventTransceiver:function(e){"object"==(void 0===e?"undefined":i(e))&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimCreateOfferLegacy:function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);var r=this.getTransceivers().find(function(e){return e.sender.track&&"audio"===e.sender.track.kind});!1===e.offerToReceiveAudio&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveAudio||r||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);var n=this.getTransceivers().find(function(e){return e.sender.track&&"video"===e.sender.track.kind});!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection("sendonly"):"recvonly"===n.direction&&n.setDirection("inactive"):!0!==e.offerToReceiveVideo||n||this.addTransceiver("video")}return t.apply(this,arguments)}}}},{"../utils":11}],11:[function(e,t,r){var n=!0;function a(e,t,r){var n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)}t.exports={extractVersion:a,wrapPeerConnectionEvent:function(e,t,r){if(e.RTCPeerConnection){var n=e.RTCPeerConnection.prototype,i=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return i.apply(this,arguments);var a=function(e){var t=r(e);t&&n(t)};return this._eventMap=this._eventMap||{},this._eventMap[n]=a,i.apply(this,[e,a])};var a=n.removeEventListener;n.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[r])return a.apply(this,arguments);var n=this._eventMap[r];return delete this._eventMap[r],a.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}},disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":i(e))+". Please use a boolean."):(n=e)?"adapter.js logging disabled":"adapter.js logging enabled"},disableWarnings:function(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":i(e))+". Please use a boolean."):"adapter.js deprecation warnings "+(e?"disabled":"enabled")},log:function(){if("object"==("undefined"==typeof window?"undefined":i(window))){if(n)return;"undefined"!=typeof console&&console.log}},deprecated:function(e,t){},detectBrowser:function(e){var t=e&&e.navigator,r={browser:null,version:null};if(void 0===e||!e.navigator)return r.browser="Not a browser.",r;if(t.mozGetUserMedia)r.browser="firefox",r.version=a(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia)r.browser="chrome",r.version=a(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=a(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return r.browser="Not a supported browser.",r;r.browser="safari",r.version=a(t.userAgent,/AppleWebKit\/(\d+)\./,1)}return r}}},{}]},{},[3])(3)})}).call(this,void 0!==r?r:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],24:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=s(e(25)),a=s(e(19)),o=s(e(18));function s(e){return e&&e.__esModule?e:{default:e}}var c=function(e){function t(e){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,a.default.SIGNAL_SENDING));r.TAG="SignalClient";var n=e.config;return r._socketIOConnection=new i.default({signalServer:n.signalServer},r.onEvents.bind(r)),r._socketIOConnection.on("message",function(e){r.tp2p.trigger(a.default.SIGNAL_RECEIVING,e)}),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o.default),n(t,[{key:"onSignalSending",value:function(e){this.send(e)}},{key:"destroy",value:function(){this._socketIOConnection.destroy(),o.default.prototype.destroy.call(this),this.tp2p=null}},{key:"onEvents",value:function(e){switch(e.event){case"connect":this.tp2p.initiator.localPeerId=this._socketIOConnection.socketId}}},{key:"send",value:function(e){this._socketIOConnection.emit("message",e)}}]),t}();r.default=c},{18:18,19:19,25:25}],25:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=(n=e(26))&&n.__esModule?n:{default:n},o=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._socket=new a.default(t.signalServer,{reconnection:!0,reconnectionAttempts:10,reconnectionDelay:2e3,randomizationFactor:.5,timeout:2e4,autoConnect:!0}),this.callback=r,this._initListening()}return i(e,[{key:"destroy",value:function(){this._disconnect(),this._socket=null,this.callback=null}},{key:"on",value:function(e,t){this._socket.on(e,t)}},{key:"emit",value:function(e,t){this._socket.emit(e,t)}},{key:"_disconnect",value:function(){return this._socket.disconnect()}},{key:"_initListening",value:function(){var e=this,t=this._socket;t.on("connect",function(){e.callback({event:"connect"})}),t.on("connect_error",function(e){}),t.on("connect_timeout",function(e){}),t.on("error",function(e){}),t.on("disconnect",function(e){}),t.on("reconnect",function(e){}),t.on("reconnect_attempt",function(e){}),t.on("reconnecting",function(e){}),t.on("reconnect_error",function(e){}),t.on("reconnect_failed",function(){}),t.on("ping",function(){}),t.on("pong",function(e){})}},{key:"socketId",get:function(){return this._socket.id}},{key:"connection",get:function(){return this._socket},set:function(e){this._socket=e}},{key:"logTime",get:function(){var e=new Date;return e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+"."+e.getMilliseconds()}}]),e}();r.default=o},{26:26}],26:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=null,this.events={},this.uri="wss://"+t,this.options=r,this.reconnect=0,this.timer=null,this.initWebSocket()}return n(e,[{key:"initWebSocket",value:function(){WebSocket&&(this.reconnect++,this._ws=new WebSocket(this.uri),this._ws.onopen=this.onopen.bind(this),this._ws.onmessage=this.onmessage.bind(this),this._ws.onclose=this.onclose.bind(this),this._ws.onerror=this.onerror.bind(this))}},{key:"on",value:function(e,t){"connect"!==e&&"message"!==e||(this.events[e]=t)}},{key:"emit",value:function(e,t){"message"===e&&this._ws.send("S "+t.to+" "+JSON.stringify(t))}},{key:"disconnect",value:function(){this.timer&&(clearTimeout(this.timer),this.timer=null),this.options.reconnection=!1,this._ws.close()}},{key:"onopen",value:function(e){this.reconnect=0}},{key:"onmessage",value:function(e){var t=e.data.substring(0,1);if("C"===t)this.id=e.data.substring(2),this.events.connect();else if("S"===t){var r=JSON.parse(e.data.substring(29));this.events.message(r)}}},{key:"onerror",value:function(e){}},{key:"onclose",value:function(e){this.options.reconnection&&this.options.reconnectionAttempts>this.reconnect&&(this.timer=setTimeout(function(){this.initWebSocket()}.bind(this),this.options.reconnectionDelay+1e3*this.reconnect))}},{key:"logTime",get:function(){var e=new Date;return e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+"."+e.getMilliseconds()}}]),e}();r.default=i},{}],27:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.SignalType={OFFER:"offer",ANSWER:"answer",ICE_CANDIDATE:"iceCandidate",JUST_START:"justStart"},r.DataChannelState={OPEN:"open",CLOSE:"close",ERROR:"error",BUFFER_AMOUNT_LOW:"bufferAmountLow",REPORT:"report"}},{}],28:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=e(27),a=function(){function e(t,r,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="DataChannel",this.enableDCClosing=r.enableDCClosing,this.callbacks=n;var i={negotiated:!0,id:r.id,ordered:!1,reliable:!0,bufferedAmountLowThreshold:0};this.dataChannel=t.createDataChannel(r.label,i),this.dataChannel.binaryType="arraybuffer",this._bindHandler(),this._bufferedAmountLimit=r.bufferedAmountLimit}return n(e,[{key:"destroy",value:function(){this.dataChannel.close(),this.dataChannel=null,this.callbacks=null}},{key:"_bindHandler",value:function(){var e=this.dataChannel;e.onopen=this.onOpen.bind(this),e.onerror=this.onError.bind(this),e.onclose=this.onClose.bind(this),e.onmessage=this.onMessage.bind(this),e.onbufferedamountlow&&(e.onbufferedamountlow=this.onBufferedAmountLow.bind(this))}},{key:"send",value:function(e){var t=this.dataChannel;if(t&&"open"===t.readyState){if(t.bufferedAmount<=this._bufferedAmountLimit)try{if(e instanceof Array){var r=Date.now();e.forEach(function(e){t.send(e)});var n=Date.now()-r;this.callbacks&&this.callbacks.onDataChannelStateChange({state:i.DataChannelState.REPORT,duration:n})}else t.send(e)}catch(e){}}else this.enableDCClosing&&t&&"closing"===this.readyState&&this.onClose()}},{key:"onMessage",value:function(e){this.callbacks&&this.callbacks.onDataChannelMessage(e.data)}},{key:"onOpen",value:function(){this.callbacks&&this.callbacks.onDataChannelStateChange({state:i.DataChannelState.OPEN})}},{key:"onClose",value:function(){this.callbacks&&this.callbacks.onDataChannelStateChange({state:i.DataChannelState.CLOSE})}},{key:"onError",value:function(e){this.callbacks&&this.callbacks.onDataChannelStateChange({state:i.DataChannelState.ERROR})}},{key:"onBufferedAmountLow",value:function(){this.callbacks.onDataChannelStateChange({state:i.DataChannelState.BUFFER_AMOUNT_LOW})}},{key:"readyState",get:function(){return this.dataChannel.readyState}},{key:"bufferedAmount",get:function(){return this.dataChannel.bufferedAmount}},{key:"label",get:function(){return this.dataChannel.label}},{key:"id",get:function(){return this.dataChannel.id}},{key:"bufferedAmountLowThreshold",get:function(){return this.dataChannel.bufferedAmountLowThreshold}}]),e}();r.default=a},{27:27}],29:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=(n=e(28))&&n.__esModule?n:{default:n},o=e(27),s=function(){function e(t,r){var n,i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="WebRTCPeerConnection",this.localId=t.localId,this.remoteId=t.remoteId,this.callbacks=r,this._rtcPeerConnection=new RTCPeerConnection(t.ice),this._bindHandler(),n={label:this.remoteId,id:0,bufferedAmountLimit:t.bufferedAmountLimit,enableDCClosing:t.enableDCClosing},i={onDataChannelMessage:this.onDataChannelMessage.bind(this),onDataChannelStateChange:this.onDataChannelStateChange.bind(this)},this._dataChannel=new a.default(this._rtcPeerConnection,n,i)}return i(e,[{key:"destroy",value:function(){this._dataChannel.destroy(),this._dataChannel=null,this._rtcPeerConnection.close(),this.callbacks=null}},{key:"send",value:function(e){this._dataChannel.send(e)}},{key:"_bindHandler",value:function(){this._rtcPeerConnection.onicecandidate=this.onIceCandidate.bind(this),this._rtcPeerConnection.oniceconnectionstatechange=this.onIceConnectionStateChange.bind(this),this._rtcPeerConnection.onsignalingstatechange=this.onSignalingStateChange.bind(this)}},{key:"receiveSignal",value:function(e){switch(e.type){case o.SignalType.JUST_START:this._createOffer();break;case o.SignalType.OFFER:this._receiveOffer(e.msg);break;case o.SignalType.ANSWER:this._receiveAnswer(e.msg);break;case o.SignalType.ICE_CANDIDATE:this._receiveCandidate(e.msg)}}},{key:"onIceCandidate",value:function(e){if(this.callbacks){if(!e||!e.candidate)return;this.callbacks.onSendBySignalChannel({type:o.SignalType.ICE_CANDIDATE,msg:e.candidate})}}},{key:"onIceConnectionStateChange",value:function(e){this.callbacks&&this.callbacks.onStateChange({context:"peerConnection",type:"IceConnectionState",state:e.target.iceConnectionState})}},{key:"onSignalingStateChange",value:function(){this.callbacks&&this.callbacks.onStateChange({context:"peerConnection",type:"SignalingState",state:this._rtcPeerConnection.signalingState})}},{key:"onDataChannelMessage",value:function(e){this.callbacks&&this.callbacks.onMessage(e)}},{key:"onDataChannelStateChange",value:function(e){this.callbacks&&this.callbacks.onStateChange({context:"dataChannel",type:"State",state:e.state,originData:e})}},{key:"_receiveOffer",value:function(e){var t=this;this._receiveDescription(e,function(){t._createAnswer()})}},{key:"_receiveAnswer",value:function(e){this._receiveDescription(e)}},{key:"_receiveCandidate",value:function(e){this._rtcPeerConnection.addIceCandidate(new RTCIceCandidate(e)).then(function(){}).catch(function(e){})}},{key:"_createAnswer",value:function(){var e=this;this._rtcPeerConnection.createAnswer().then(function(t){return e._rtcPeerConnection.setLocalDescription(t)}).then(function(){e.callbacks&&e.callbacks.onSendBySignalChannel({type:o.SignalType.ANSWER,msg:e._rtcPeerConnection.localDescription})}).catch(function(e){})}},{key:"_receiveDescription",value:function(e,t){this._rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(e)).then(function(e){t&&t()}).catch(function(e){})}},{key:"_createOffer",value:function(){var e=this;this._rtcPeerConnection.createOffer({OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}).then(function(t){return e._rtcPeerConnection.setLocalDescription(t)}).then(function(){e.callbacks&&e.callbacks.onSendBySignalChannel({type:o.SignalType.OFFER,msg:e._rtcPeerConnection.localDescription,streamId:e._dataChannel.id})}).catch(function(e){})}},{key:"iceGatheringState",get:function(){return this._rtcPeerConnection.iceGatheringState}}]),e}();r.default=s},{27:27,28:28}],30:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=c(e(19)),a=c(e(18)),o=c(e(79)),s=e(77);function c(e){return e&&e.__esModule?e:{default:e}}var u=function(e){function t(e){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i.default.CONF_PARSING));return r.TAG="ConfController",r._pconfField=[],r.init(),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),n(t,[{key:"destroy",value:function(){this.onStopping(),a.default.prototype.destroy.call(this),this.tp2p=null}},{key:"init",value:function(){this._confRequestCounter=0,this._initConfFieldMap(),this._getConfFromLocalStorage()}},{key:"_initConfFieldMap",value:function(){this._pconfField=[["monitorStart","monitor_start"],["PCHeartTimeout","pc_heart_timeout"],["syncInterval","sync_interval"],["maxRequestEachTime","max_request_each_time"],["backupCdnDelay","backup_cdn_delay"],["adjustPlayDelayInterval","adjust_play_delay_interval"],["peerCacheSize","peer_cache_size"],["trackerInterval","tracker_interval"],["failCauseFallback","fail_cause_fallback"],["stuckCauseRollback","stuck_cause_rollback"],["stuckCauseSkip","stuck_cause_skip"],["localStreamShare","local_stream_share"],["maxSubLevel","max_sub_level"],["maxSubscribePCUsefulCount","max_subscribe_pc_useful_count"],["maxConnectRequestEachPeriod","max_connect_request_each_period"],["maxConnectedPC","max_connected_pc"],["maxSubscribedPC","max_subscribed_pc"],["PCHeartInterval","pc_heart_interval"],["PCKeepTimeout","pc_keep_timeout"],["PCCheckAliveInterval","pc_check_alive_interval"],["bufferedAmountLimit","buffered_amount_limit"],["DCChunkSize","dc_chunk_size"],["stunServer","h5_stun_server"],["signalServer","h5_signal_server"],["peerConnWaWeight","peer_conn_wa_weight"],["cdnSuffix","suffix"],["protectWin","protect_w"],["adjustPlayDelayTimerInterval","adjust_play_delay_timer_interval"],["skipStartValidity","skip_start_validity"],["fastForwardRate","fast_forward_rate"],["fixStuck","fix_stuck"],["stuckFilter","stuck_filter"],["initEstimate","init_estimate"],["initRollback","init_rollback"],["checkPeerInterval","check_peer_interval"],["stuckThreshold","stuck_threshold"],["stuckPerformance","stuck_performance"],["maxConnecting","max_connecting"],["enableFastStartUp","enable_fast_start_up"],["enableAdjustDelay","enable_adjust_delay"],["enableFastWardRate","enable_fast_ward_rate"],["enableSlowDownRate","enable_slow_down_rate"],["fastForwardLimit","fast_forward_limit"],["adjustPlayDelayIntervalSlowDown","adjust_play_delay_interval_slow_down"],["delayTolerateMax","delay_tolerate_max"],["delayTolerateMin","delay_tolerate_min"],["fastForwardMaxDuration","fast_forward_max_duration"],["fastForwardMaxBufferLength","fast_forward_max_buffer_length"],["syncThresh","sync_thresh"],["cdnLoadingTimeout","cdn_loading_timeout"],["cdnLoadingMaxRetry","cdn_loading_max_retry"],["bufferCount","buffer_count"],["bFix","b_fix"],["bpFix","bp_fix"],["playerMaxBuffer","player_max_buffer"],["pushBoundary","push_boundary"],["trackerCustomVersion","tracker_custom_version"],["backupTaskLen","backup_task_len"],["maxTaskLen","max_task_len"],["xpieceTaskLimit","xpiece_task_limit"],["xpieceBackup","xpiece_backup"],["startFastDownload","start_fast_download"],["backupCdnLoadingTimeout","backup_cdn_loading_timeout"],["backupCdnLoadingMaxRetry","backup_cdn_loading_max_retry"],["codeEqual404","code_equal_404"],["maxConnectedPCHigh","max_connected_pc_high"],["maxSubscribedPC","max_subscribed_pc_high"],["highBitRate","high_bit_rate"],["primeXpieceWithBackup","prime_xpiece_with_backup"],["enableExtraPeer","enable_extra_peer"],["extraPeerCount","extra_peer_count"],["appendCheck","append_check"],["p2p","p2p"],["fillTimeout","fill_timeout"],["pcdnMaxTaskSize","pcdn_max_task_size"],["p2pWindow","p2p_w"],["judgeAliveDelay","judge_alive_delay"],["judgeAliveCount","judge_alive_cnt"],["p2pUsefulRatio","p2p_useful_ratio"],["forceFillCnt","force_fill_cnt"],["sampleDuration","useful_sample_dura"],["fillMinBuf","fill_min_buf"],["enableSpeedUp","enable_speed_up"],["accelerationRate","acc_rate"],["targetBufferLen","target_buf_len"],["checkInterval","check_interval"],["fillTimeoutWithP2P","fill_timeout_with_p2p"],["fill404WitP2P","fill_404_with_p2p"],["p2pFillOffset","p2p_fill_offset"],["ssmCheckInterval","ssm_check_interval"],["ssmResGap2PR","ssm_res_gap_pr"],["ssmContinuousCount","ssm_continuous_count"],["ssmEmitInterval","ssm_emit_interval"],["pcdnLiveDelay","pcdn_live_delay"],["uselessSliceCount","useless_slice_cnt"],["confVersion","conf_ver"],["enableBakOC","en_bak_oc"],["enableDCClosing","en_dc_closing"],["mainMaxRetryCount","main_max_retry_cnt"],["enableSubFill","en_sub_fill"],["subStreamLoadInterval","sub_load_interval"],["sampleUsefulJudge","sample_useful_judge"],["disableTrigger","dis_trigger"],["plrEnable","plr_enable"],["plrThreshold","plr_threshold"],["plrCacheLength","plr_cache_length"],["plrCheckDelay","plr_check_delay"],["syncConf","sync_conf"],["retryMainDelay","retry_main_delay"],["enableWriteAll","en_write_all"],["confirmLossEnable","confirm_loss_enable"],["enableStuckReload","en_stuck_reload"],["restartP2PDelay","restart_p2p_delay"],["fillRatio","fill_ratio"],["maxSkipRetryTimes","max_skip_retry"],["enableRollbackOther","en_rb_other"],["rollbackWhileList","rb_white_list"],["enableStuckWaitBuffer","en_stuck_wait"],["resumePlayDelay","re_play_delay"],["resumePlayBuffer","re_play_buf"],["parseHeader","parse_header"],["rollback404","rb_404"],["eos404Limit","eos_404_limit"],["startPlayWaitSliceLen","start_play_wait","spwsl"],["playStartTimeout","play_start_timeout","pst"],["assignDelayRooms","assign_delay_rooms","adr"],["assignDelay","assign_delay","ady"],["fillMaxTaskSize","fill_max_size"],["stuckCauseReload","stuck_cause_reload"],["enableAbortController","en_abort"]]}},{key:"_getConfFromLocalStorage",value:function(){if(window.localStorage){var e=this.tp2p.config,t=JSON.parse(localStorage.getItem("TC_CONF"))||{};this._pconfField.forEach(function(r){var n=t[r[2]];void 0!==n&&void 0!==e[r[0]]&&(e[r[0]]=n)})}}},{key:"onStopping",value:function(){this._confTimer&&(clearInterval(this._confTimer),this._confTimer=null)}},{key:"starting",value:function(){var e=this;if(!this._confTimer){var t=1e3*Math.max(this.tp2p.config.syncInterval,60);this._confTimer=setInterval(function(){e.tp2p.trigger(i.default.CONF_LOADING)},t)}}},{key:"onConfParsing",value:function(e){var t=e.conf,r=this.tp2p.config,n=t.pconf,a=t.cconf,l=this._pconfField,c={};l.forEach(function(e){void 0!==n[e[1]]&&(r[e[0]]=n[e[1]],e[2]&&(c[e[2]]=n[e[1]]))}),window.localStorage&&localStorage.setItem("TC_CONF",JSON.stringify(c));var u,d,p,f=n.arch_pcdn;f&&"pcdn"===r.arch&&l.forEach(function(e){void 0!==f[e[1]]&&(r[e[0]]=f[e[1]])}),!r.initRollback&&r.p2p?(void 0!==n.streams&&0===r.streams&&(r.streams=parseInt(n.streams)),n.tracker&&(r.trackerServer=n.tracker),n.reportserver&&(r.reportServer=n.reportserver),void 0!==n.h5_p2p&&(r.useP2p=n.h5_p2p&&o.default.supportP2P()),void 0!==n.livedelay_w&&(r.liveDelay=parseInt(n.livedelay_w),r.maxDelay=r.liveDelay+r.delayTolerateMax,r.minDelay=r.liveDelay-r.delayTolerateMin),void 0!==a.appid&&(r.partnerId=a.appid),void 0!==a.channelId&&(r.channelId=a.channelId),void 0!==a.cdns&&(r.CDNList=a.cdns),r.timeOffset=a.verifyTime-Date.now(),r.streams=r.pcdnStreams,this._confRequestCounter++,1===this._confRequestCounter?(this.tp2p.trigger(i.default.FIRST_CONF_LOADED),r.syncConf&&this.starting()):this.tp2p.trigger(i.default.CONF_LOADED)):this.tp2p.trigger(i.default.ERROR,{fatal:!0,rollbackCode:s.ReportCode.ROLLBACK,extendReportData:(u={},d=s.ReportField.ROLLBACK_REASON,p=s.ReportField.ROLLBACK_CONF_CONFIG,d in u?Object.defineProperty(u,d,{value:p,enumerable:!0,configurable:!0,writable:!0}):u[d]=p,u)})}}]),t}();r.default=u},{18:18,19:19,77:77,79:79}],31:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=p(e(19)),a=p(e(18)),o=p(e(92)),s=p(e(3)),c=p(e(2)),u=e(77),d=p(e(93));function p(e){return e&&e.__esModule?e:{default:e}}var f=function(e){function t(e){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i.default.CONF_LOADING));return r.TAG="ConfLoader",r.config=r.tp2p.config,r._isFirstDownload=!0,r.confFail=0,r._initReporterData(),r.tp2p.registerReportCallback(r.TAG,r.reportCallback.bind(r)),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),n(t,[{key:"destroy",value:function(){this.loader&&this.loader.destroy(),a.default.prototype.destroy.call(this),this.tp2p=null,this.config=null,this._isFirstDownload=null}},{key:"onConfLoading",value:function(){if(!this.loader||this.loader._abort){var e,t,r,n=this.config;this.loader=new d.default,e={url:""+n.confPCDNBaseUrl+n.channelId+"?domain="+n.domain+"&s="+window.btoa(n.sourceUrl)+"&d="+n.liveDelayPreset+"&timestamp="+parseInt(Date.now()),method:"GET",responseType:"text"},t={timeout:n.pcdnConfTimeout,maxRetry:n.pcdnConfMaxRetry,retryDelay:n.pcdnConfRetryDelay,maxRetryDelay:n.pcdnConfMaxRetryDelay},r={onSuccess:this.loadSuccess.bind(this),onError:this.loadError.bind(this),onTimeout:this.loadTimeout.bind(this)},this.loader.load(e,t,r)}}},{key:"loadSuccess",value:function(e,t,r){3<arguments.length&&void 0!==arguments[3]&&arguments[3];var n=e.data,a=o.default.decrypt(n),s=this.tp2p.config;if(this._isFirstDownload){this._isFirstDownload=!1;var l={i:{}};l[u.ReportField.CODE]=u.ReportCode.PHASE_DATA,l[u.ReportField.EVENT_CODE]=u.ReportCode.CONF_OK,l.i[u.ReportField.CONF_DURATION]=t.tload-s.startTime,l.i[u.ReportField.CONF_OK_TIME]=t.tload-t.trequest,this.tp2p.trigger(i.default.REPORT_ONCE,l)}this.loader=null,this.confFail=0,a.cconf.verifyTime=1e3*a.cconf.verifyTime+Math.round((t.tfirst-t.tsend)/2),this.tp2p.trigger(i.default.CONF_PARSING,{conf:a})}},{key:"loadError",value:function(e,t,r){3<arguments.length&&void 0!==arguments[3]&&arguments[3],this._reportData[u.ReportField.CONF_ERROR]+=1,this._confFail()}},{key:"loadTimeout",value:function(e,t){2<arguments.length&&void 0!==arguments[2]&&arguments[2],this._reportData[u.ReportField.CONF_TIMEOUT]+=1,this._confFail()}},{key:"_confFail",value:function(){this.confFail=1,this.tp2p.trigger(i.default.CONF_FAIL)}},{key:"reportCallback",value:function(){var e=this._reportData;for(var t in e)e.hasOwnProperty(t)&&!e[t]&&delete e[t];return e[u.ReportField.CONF_FAIL]=this.confFail,this._initReporterData(),e}},{key:"_initReporterData",value:function(){this._reportData={};var e=this._reportData;e[u.ReportField.CONF_ERROR]=0,e[u.ReportField.CONF_TIMEOUT]=0,e[u.ReportField.CONF_FAIL]=0}}],[{key:"hmacMD5",value:function(e,t){return window.btoa(new s.default(t,e).toString(c.default))}}]),t}();r.default=f},{18:18,19:19,2:2,3:3,77:77,92:92,93:93}],32:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.RequestType={MAIN_STREAM:1,SUB_STREAM:2,FRAGMENT:3},r.HttpReportType={CODE_404:404,CODE_403:403,CODE_200:200,UNKNOWN_ERROR:-3,DONE:0,TIMEOUT:-1,NETWORK_ERROR:-2,READ_ERROR:-4,REPORT_RES_HEADER:11,REPORT_STATS:12},r.SubLoadingState={LOADING_MAIN:2,LOADING:1,IDLE:0}},{}],33:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=e(77),a=u(e(19)),o=u(e(18)),s=u(e(40)),c=u(e(35));function u(e){return e&&e.__esModule?e:{default:e}}var d=function(e){function t(e,r){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r,a.default.FILL_FRAGMENT_SUCCESS,a.default.FILL_FRAGMENT_FAIL));return n.TAG="FillStreamHole",n.stateMgr=e.stateMgr,n.storage=e.storage,n.storageMgr=e.storageMgr,n.switchController=e.switchController,n.tp2p=r,n.missingFragment=new Set,n.fail404=n.stateMgr.confirmLoss,n.timer=new s.default(n.TAG),n.p2pFill=new c.default(e,r),n._initReporterData(),n.tp2p.registerReportCallback(n.TAG,n.reportCallback.bind(n)),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o.default),n(t,[{key:"destroy",value:function(){this.onStopping(),this.p2pFill.destroy()}},{key:"onStarting",value:function(){var e=this,t=setTimeout(function(){e.setFillTimer(),e.tp2p.config.enableP2PFill&&e.p2pFill.onStarting()},5e3);this.timer.set("starter",t)}},{key:"onStopping",value:function(){this.p2pFill.onStopping(),this.timer.destroy()}},{key:"setFillTimer",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=this.timer;t.has("fill")&&t.clearInterval("fill");var r=setInterval(this.fill.bind(this,{bakOC:e}),1e3);t.set("fill",r)}},{key:"fill",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(this.stateMgr.playStart&&!this.stateMgr.loadingMain){var t=this.findMissingSlice();this.cdnFill(t,e)}}},{key:"cdnFill",value:function(e){var t=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};e.length&&(this._reportData[i.ReportField.FILL_REQ]+=1,this._reportData[i.ReportField.FILL_SLICE]+=e.length,e.forEach(function(e){e>t.stateMgr.getMaxSubStreamId(e%4)&&(t._reportData[i.ReportField.FILL_GT_SUB]+=1)}),this.switchController.loadFragments(e,r))}},{key:"onFillFragmentSuccess",value:function(e){var t=e.sliceArray;this._reportData[i.ReportField.FILL_SLICE_OK]+=t.length,this._deleteFragCache(t)}},{key:"onFillFragmentFail",value:function(e){var t=e.sliceArray,r=e.failReason;this._deleteFragCache(t);var n=this.tp2p.config,a=n.fillTimeoutWithP2P,o=n.fill404WitP2P;a&&r===i.ReportField.ROLLBACK_STREAM_TIMEOUT&&this.p2pFill.tryFill(t),r!==i.ReportField.ROLLBACK_STREAM_404&&r!==i.ReportField.ROLLBACK_STREAM_END||(this._record404(t),o&&this.p2pFill.tryFill(t))}},{key:"findMissingSlice",value:function(){for(var e=[],t=this.stateMgr,r=(t.fillSliceRange,t.nextWriteId),n=this.calculateBoundaryId(),i=r;i<n&&(this.storage.has(i)||this.missingFragment.has(i)||this.fail404.has(i)||(this.missingFragment.add(i),e.push(i),!(e.length>=Math.floor(this.stateMgr.frameRate*this.tp2p.config.fillRatio))));i++);return this._removeOutDateFrag(r),this._removeOutDate404(r),e}},{key:"calculateBoundaryId",value:function(){var e=this.tp2p.config,t=e.useP2PWindow,r=this.stateMgr.nextWriteId,n=this.stateMgr.frameRate,a=void 0;if(t){if(a=this.stateMgr.p2pBoundId,e.enableP2PFill&&(a=this.p2pFill.p2pFillMin),this.stateMgr.lowLatency){var o=Math.min(this.stateMgr.maxSliceId-2*n,r+n),s=this.storageMgr.missingSliceNum(r,o);0<s&&s<e.forceFillCnt&&(this._reportData[i.ReportField.FILL_FORCE]+=1,a=r+n)}}else{var l=this.tp2p.bufferLength,c=(e.pcdnProtectWindow-parseInt(l))*this.stateMgr.frameRate;a=Math.min(r+c,this.stateMgr.maxSliceId-this.stateMgr.frameRate)}return a}},{key:"_deleteFragCache",value:function(e){var t=this;e.forEach(function(e){t.missingFragment.delete(e)})}},{key:"_removeOutDateFrag",value:function(e){this.missingFragment.forEach(function(t,r,n){t<e&&n.delete(r)})}},{key:"_record404",value:function(e){var t=this;e.forEach(function(e){t.fail404.add(e)})}},{key:"_removeOutDate404",value:function(e){this.fail404.forEach(function(t,r,n){t<e&&n.delete(r)})}},{key:"_initReporterData",value:function(){this._reportData={};var e=this._reportData;e[i.ReportField.FILL_REQ]=0,e[i.ReportField.FILL_SLICE]=0,e[i.ReportField.FRAME_RATE]=0,e[i.ReportField.FILL_SLICE_OK]=0,e[i.ReportField.FILL_GT_SUB]=0,e[i.ReportField.FILL_BAK_REQ]=0,e[i.ReportField.FILL_FORCE]=0}},{key:"reportCallback",value:function(){this._reportData[i.ReportField.FRAME_RATE]=this.stateMgr.frameRate;var e=this._reportData;return this._initReporterData(),e}}]),t}();r.default=d},{18:18,19:19,35:35,40:40,77:77}],34:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=(n=e(19))&&n.__esModule?n:{default:n},o=e(32),s=e(77),l=function(){function e(t,r,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="MainStreamController",this.initiator=t,this.tp2p=r,this.switchController=n,this.stateMgr=t.stateMgr,this._initReporterData(),this.tp2p.registerReportCallback(this.TAG,this.reportCallback.bind(this))}return i(e,[{key:"destroy",value:function(){this._clearDelayTimer(),this._clearStartTimer()}},{key:"onStuckReload",value:function(){if(!this.stateMgr.reloadingMain){this.stateMgr.reloadingMain=!0,this._reportData[s.ReportField.STUCK_RELOAD_COUNT]+=1,this.tp2p.trigger(a.default.P2P_STOPPING),this.tp2p.trigger(a.default.STOP_WRITE_SKIP),this.switchController.switchLoading(o.RequestType.MAIN_STREAM);var e=this.tp2p.config.restartP2PDelay;e&&!this._delayStartTimer&&(this._delayStartTimer=setTimeout(this._restartP2P.bind(this),e))}}},{key:"_restartP2P",value:function(){var e=this;this._clearDelayTimer(),this._restartTimer||(this._restartTimer=setInterval(function(){e._canStartP2P()&&(e._clearStartTimer(),e.switchController.switchLoading(o.RequestType.SUB_STREAM),e.tp2p.trigger(a.default.P2P_STARTING),e._reportData[s.ReportField.STUCK_RELOAD_RECOVER]+=1)},1e3))}},{key:"_canStartP2P",value:function(){var e=this.tp2p.config,t=Math.max(e.pcdnLiveDelay-e.p2pWindow-2,2),r=e.pcdnLiveDelay;return this.tp2p.bufferLength>t&&this.stateMgr.realDelay>r}},{key:"_clearDelayTimer",value:function(){this._delayStartTimer&&(clearTimeout(this._delayStartTimer),this._delayStartTimer=null)}},{key:"_clearStartTimer",value:function(){this._restartTimer&&(clearInterval(this._restartTimer),this._restartTimer=null)}},{key:"onLoadError",value:function(){}},{key:"_initReporterData",value:function(){this._reportData={};var e=this._reportData;e[s.ReportField.STUCK_RELOAD_COUNT]=0,e[s.ReportField.STUCK_RELOAD_RECOVER]=0}},{key:"reportCallback",value:function(){var e=this._reportData;for(var t in e)e[t]||delete e[t];return this._initReporterData(),e}}]),e}();r.default=l},{19:19,32:32,77:77}],35:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=(n=e(19))&&n.__esModule?n:{default:n},o=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="P2PFill",this.tp2p=r,this.stateMgr=t.stateMgr,this.storage=t.storage,this._interval=300,this._lastFillId=-1}return i(e,[{key:"destroy",value:function(){this.onStopping()}},{key:"onStarting",value:function(){this._interval=this.tp2p.config.p2pCheckInterval||300,this._fillTimer||(this._fillTimer=setInterval(this.check.bind(this),this._interval))}},{key:"onStopping",value:function(){this._fillTimer&&(clearInterval(this._fillTimer),this._fillTimer=null)}},{key:"check",value:function(){var e=this.stateMgr.nextWriteId,t=this.stateMgr.frameRate,r=this.p2pFillMax;if(r<e)return 0;var n=this.p2pFillMin;-1===this._lastFillId&&(this._lastFillId=n);var i=Math.max(n,e);this._lastFillId=Math.max(this._lastFillId,i);for(var a=[],o=Math.min(r,this._lastFillId+Math.ceil(t/2));this._lastFillId<o;)this.storage.has(this._lastFillId)||a.push(this._lastFillId),this._lastFillId+=1;this.tryFill(a)}},{key:"tryFill",value:function(e){e.length&&this.tp2p.trigger(a.default.TRY_P2P_FILL,{missing:e,from:"P2PFill"})}},{key:"p2pFillMax",get:function(){var e=this.stateMgr.p2pBoundId,t=this.stateMgr.frameRate;return e+this.tp2p.config.p2pFillOffset*t}},{key:"p2pFillMin",get:function(){return this.p2pFillMax-this.stateMgr.frameRate}}]),e}();r.default=o},{19:19}],36:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=h(e(48)),a=e(77),o=h(e(19)),s=h(e(18)),c=h(e(82)),u=h(e(39)),d=e(32),p=h(e(41)),f=h(e(85));function h(e){return e&&e.__esModule?e:{default:e}}var _=function(e){function t(e,r,n){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r,o.default.FIRST_CONF_LOADED));return i.TAG="PCDNController",i.storage=e.storage,i.stateMgr=e.stateMgr,i.storageMgr=e.storageMgr,i.streamController=n,i.ztcLoader=new p.default({timeout:r.config.ztcTimeout},{onError:i.onZTCError.bind(i),onSuccess:i.onZTCSuccess.bind(i)}),i.baseSub=e.pcdnStreams,i.xStreamId=e.xStreamId,i.tp2p=r,i._loadQueue=[],i._downloadServers=new Map,i._idCount=0,i._nonSliceVideoTagCnt=0,i._initReporterData(),i.tp2p.registerReportCallback(i.TAG,i.reportCallback.bind(i)),i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s.default),n(t,[{key:"destroy",value:function(){this.ztcLoader.destroy(),this._downloadServers.forEach(function(e){e.destroy()}),this._downloadServers=null,this._collectTimeout&&clearInterval(this._collectTimeout)}},{key:"onFirstConfLoaded",value:function(){this._collectTimelineInfo()}},{key:"onZTCSuccess",value:function(){u.default.LoadMainWithZTC(this.streamId,this.tp2p.config.testOCRoom)&&(this.domain.main=this.ztcLoader.sug+"/"+this.domain.sub,this.streamController.initLoad())}},{key:"onZTCError",value:function(){}},{key:"setStreamId",value:function(e){this.streamId=e,this.domain={main:this.tp2p.config.pcdnDomainMain,sub:this.tp2p.config.pcdnDomainSub},this._init()}},{key:"_init",value:function(){this.ztcLoader.init({ztcDomain:this.domain.sub,streamId:this.streamId,playId:this.tp2p.config.randomPlayId,uuid:f.default.myUUID().UUID||"ztc_error"}),this.ztcLoader.load()}},{key:"load",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(!this.streamId)throw Error("no streamId");if(e&&~[d.RequestType.MAIN_STREAM,d.RequestType.SUB_STREAM,d.RequestType.FRAGMENT].indexOf(e.type))return this._loadQueue.push({id:++this._idCount,config:e}),this._load(),this._idCount}},{key:"abort",value:function(e){this._downloadServers.has(e)&&(this._downloadServers.get(e).destroy(),this._downloadServers.delete(e))}},{key:"_choseOC",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]&&arguments[2],n=this.ztcLoader.sug;return t&&e%2==0&&(n=this.ztcLoader.bak),r&&(n=this.ztcLoader.bak),n}},{key:"_genStreamDomain",value:function(e,t){var r=void 0;if(!this.ztcLoader.gotDomainConfig)return"https://"+this.domain.main;switch(e.type){case d.RequestType.FRAGMENT:var n=e.query.reqid%2;r="https://"+this._choseOC(n,t.enableBakOC,e.bakOC)+"/"+this.domain.sub;break;case d.RequestType.SUB_STREAM:r="https://"+this._choseOC(e.query.substream,t.enableBakOC,e.bakOC)+"/"+this.domain.sub;break;case d.RequestType.MAIN_STREAM:r="https://"+this.domain.main}return r}},{key:"_load",value:function(){var e=this,t=this.tp2p.config;this._loadQueue.forEach(function(r){var n=r.id,s=r.config,l=e._genStreamDomain(s,t)+"/"+e.streamId+".xs",u=Object.keys(s.query||{}).reduce(function(e,t){return e.push(t+"="+s.query[t]),e},[]).join("&"),p=l+(u?"?"+u:""),f=new i.default(p,n,s.type,s);f.on("found_slice",function(r){var n=r.sliceId,i=r.payload,s=r.tagTime,l=r.requestType;if(n>=e.stateMgr.nextWriteId&&!e.storage.has(n)&&(e._reportData[a.ReportField.CDN_DOWNLOAD_USEFUL_BYTES]+=i.length),e.storage.set(n,{payload:i,tagTime:s}),n%e.baseSub===e.xStreamId&&(t.disableTrigger?e.stateMgr.onCdnLoaded({sliceId:n,payload:i,tagTime:s}):e.tp2p.trigger(o.default.CDN_LOADED,{sliceId:n,payload:i,tagTime:s})),l===d.RequestType.FRAGMENT)e.tp2p.trigger(o.default.FILL_FRAGMENT_SUCCESS,{sliceArray:[n]});else if(l===d.RequestType.MAIN_STREAM){e.stateMgr.firstSubSliceId&&n>e.stateMgr.firstSubSliceId+3&&e.streamController.stopMainStream();var c=!1;if(e.stateMgr.lastMainSliceId&&e.stateMgr.lastMainSliceId!==n-1&&(e._reportData[a.ReportField.ERR_MAIN_NOT_CON]+=1,c=!0),e.stateMgr.loadingMain){var u={sliceId:c?n:0};e.tp2p.trigger(o.default.FOUND_SLICE,u)}e.stateMgr.lastMainSliceId=n}e.stateMgr.firstSubSliceId||l!==d.RequestType.SUB_STREAM||(e.stateMgr.firstSubSliceId=n),e.stateMgr.setSubStreamId(n),e.storageMgr.cleanStorage(),t.enableWriteAll&&e.tp2p&&e.tp2p.initiator&&e.tp2p.initiator.writer&&e.tp2p.initiator.writer.onFoundSlice(),l!==d.RequestType.MAIN_STREAM&&l!==d.RequestType.SUB_STREAM||(e.stateMgr.notFoundCounter=0)}),f.on("found_flv_head",function(r){var n=r.startSliceId,i=r.payload;if(e.tp2p.trigger(o.default.FLV_HEAD_LOADED,{startSliceId:n,payload:i}),!e.stateMgr.playStart){var s=c.default.pageVisibility();e.tp2p.trigger(o.default.LOADED_DATA),e._reportData[a.ReportField.FIRST_DOWNLOAD_TIME]=Date.now()-t.loadTime,e._reportData[a.ReportField.LOADING_PAGE_VISIBILITY]=s.pageVisible}}),f.on("frag_loaded",function(r,n){n===d.RequestType.FRAGMENT&&(e._reportData[a.ReportField.FILL_BYTES]+=r),e._reportData[a.ReportField.CDN_DOWNLOAD_BYTES]+=r,e.tp2p.flow.CBS+=r*(t.bFix||1)}),f.on("http_status",function(t){var r=t.serverId,n=t.requestType,i=t.requestConfig,a=t.httpReportType,o=t.data;switch(a){case d.HttpReportType.CODE_200:e.streamController.onResOk(r,n,i);break;case d.HttpReportType.DONE:e.streamController.onFinished(r,n,i);break;case d.HttpReportType.NETWORK_ERROR:e.streamController.onNetworkError(r,n,i);break;case d.HttpReportType.TIMEOUT:e.streamController.onTimeout(r,n,i);break;case d.HttpReportType.UNKNOWN_ERROR:e.streamController.onUnknownError(r,n,i);break;case d.HttpReportType.CODE_403:e.streamController.onForbidden(r,n,i);break;case d.HttpReportType.CODE_404:e.streamController.onNotFound(r,n,i);break;case d.HttpReportType.READ_ERROR:e.streamController.onReadError(r,n,i);break;case d.HttpReportType.REPORT_RES_HEADER:e.streamController.onResHeader(r,n,i,o)}}),f.on("slice_error",function(t){var r=t.sliceId,n=t.diff;e._reportData[a.ReportField.ERR_SLICE_FRAME_COUNT]+=r+"_"+n+","}),f.on("video_tag",function(){e.stateMgr.playStart||(0<=e._nonSliceVideoTagCnt&&(e._nonSliceVideoTagCnt+=1),5<e._nonSliceVideoTagCnt&&(e.streamController.onSliceNotFound(),e._nonSliceVideoTagCnt=-1))}),e._downloadServers.set(n,f)}),this._loadQueue=[]}},{key:"_collectTimelineInfo",value:function(){var e=this,t=this.tp2p.config.timeOffset;void 0!==t&&(this._collectTimeout&&clearInterval(this._collectTimeout),this._collectTimeout=setInterval(function(){var r=e.stateMgr;if(0==Math.round((Date.now()+t)/1e3)%60){for(var n=Math.floor(r.playId),i=r.maxSliceId,o=r.baseId+Math.floor((Date.now()-r.baseTime)/1e3)*r.frameRate,s={},l={},c={},u={},d=0;d<e.baseSub;d++){var p=r.getMaxSubStreamId(d),f="s"+d;s[f]=p-n,l[f]=r.getLastSubStreamId(d)-n,c[f]=p-o,u[f]=i-p}var h=i-n,_=i-o;e._reportData[a.ReportField.DIFF_SUB_MAX_TO_PLAY]=s,e._reportData[a.ReportField.DIFF_SUB_CON_TO_PLAY]=l,e._reportData[a.ReportField.DIFF_SUB_MAX_TO_IDLE]=c,e._reportData[a.ReportField.DIFF_MAX_TO_SUB_MAX]=u,e._reportData[a.ReportField.DIFF_MAX_TO_PLAY]=h,e._reportData[a.ReportField.DIFF_MAX_TO_IDLE]=_}},1e3))}},{key:"_initReporterData",value:function(){this._reportData={};var e=this._reportData;e[a.ReportField.CDN_DOWNLOAD_BYTES]=0,e[a.ReportField.CDN_BYTES]=0,e[a.ReportField.CDN_DOWNLOAD_USEFUL_BYTES]=0,e[a.ReportField.FILL_BYTES]=0,e[a.ReportField.FIRST_DOWNLOAD_TIME]=0,e[a.ReportField.ERR_SLICE_FRAME_COUNT]="",e[a.ReportField.ZTC_ADDRESS]="",e[a.ReportField.ZTC_BAK]="",e[a.ReportField.LOADING_PAGE_VISIBILITY]="",e[a.ReportField.ERR_MAIN_NOT_CON]=0,e[a.ReportField.CUR_WRITE_ID]=0,e[a.ReportField.DIFF_SUB_MAX_TO_PLAY]={},e[a.ReportField.DIFF_SUB_CON_TO_PLAY]={},e[a.ReportField.DIFF_SUB_MAX_TO_IDLE]={},e[a.ReportField.DIFF_MAX_TO_SUB_MAX]={},e[a.ReportField.DIFF_MAX_TO_PLAY]=0,e[a.ReportField.DIFF_MAX_TO_IDLE]=0}},{key:"reportCallback",value:function(){var e=this;this._reportData[a.ReportField.ZTC_ADDRESS]=this.ztcLoader.sug,this._reportData[a.ReportField.ZTC_BAK]=this.ztcLoader.bak,0===this._reportData[a.ReportField.FIRST_DOWNLOAD_TIME]&&delete this._reportData[a.ReportField.FIRST_DOWNLOAD_TIME],this._reportData[a.ReportField.ERR_SLICE_FRAME_COUNT]||delete this._reportData[a.ReportField.ERR_SLICE_FRAME_COUNT],this._reportData[a.ReportField.LOADING_PAGE_VISIBILITY]||delete this._reportData[a.ReportField.LOADING_PAGE_VISIBILITY],this._reportData[a.ReportField.ERR_MAIN_NOT_CON]||delete this._reportData[a.ReportField.ERR_MAIN_NOT_CON],[a.ReportField.DIFF_SUB_MAX_TO_PLAY,a.ReportField.DIFF_SUB_CON_TO_PLAY,a.ReportField.DIFF_SUB_MAX_TO_IDLE,a.ReportField.DIFF_MAX_TO_SUB_MAX].forEach(function(t){Object.keys(e._reportData[t]).length||delete e._reportData[t]}),this._reportData[a.ReportField.CDN_BYTES]=this._reportData[a.ReportField.CDN_DOWNLOAD_BYTES],this._reportData[a.ReportField.CUR_WRITE_ID]=this.stateMgr.nextWriteId-1;var t=this._reportData;return this._initReporterData(),t}}]),t}();r.default=_},{18:18,19:19,32:32,39:39,41:41,48:48,77:77,82:82,85:85}],37:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=h(e(36)),a=e(77),o=e(17),s=h(e(19)),c=h(e(18)),u=h(e(85)),d=e(32),p=h(e(34)),f=h(e(39));function h(e){return e&&e.__esModule?e:{default:e}}var _=function(e){function t(e,r){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var a=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r,s.default.PULL_SUB_STREAM,s.default.STUCK_RELOAD));return a.TAG="StreamSwitchController",a.config=n,a.stateMgr=e.stateMgr,a.storage=e.storage,a._downloadTask=new Map,a._fragmentReqLen=0,a._loadRecord=new Map,a._retrySub=new Map,a.tp2p=r,a._fragmentCounter=0,a._rollback=!1,a.pcdnController=new i.default(e,r,a),a.mainStreamController=new p.default(e,r,a),a._initReporterData(),a.tp2p.registerReportCallback(a.TAG,a.reportCallback.bind(a)),a}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,c.default),n(t,[{key:"onPullSubStream",value:function(e){var t=e.subStreamId;this.loadSubStream(t,!0)}},{key:"onStuckReload",value:function(){this.mainStreamController.onStuckReload()}},{key:"destroy",value:function(){this._clearTimer(),this.mainStreamController.destroy(),this.pcdnController.destroy(),this._downloadTask.clear()}},{key:"_clearTimer",value:function(){this._retryMainTimer&&clearTimeout(this._retryMainTimer),clearTimeout(this._timeout),clearTimeout(this._killTimer)}},{key:"startLoad",value:function(e){this.pcdnController.setStreamId(e),f.default.LoadMainWithZTC(e,this.tp2p.config.testOCRoom)||this.initLoad()}},{key:"initLoad",value:function(){this.switchLoading(d.RequestType.MAIN_STREAM),this._trySub()}},{key:"_trySub",value:function(){var e=this;this._timeout=setTimeout(function(){e.stateMgr.playStart?e.switchLoading(d.RequestType.SUB_STREAM):e._trySub()},1e4)}},{key:"switchLoading",value:function(e){var t=this;switch(e){case d.RequestType.MAIN_STREAM:this.stateMgr.loadingMain=!0,this._abortAllRequest(),this.loadMainStream();break;case d.RequestType.SUB_STREAM:this.stateMgr.loadingMain=!1,this._killTimer=setTimeout(function(){t.stopMainStream()},4e3);for(var r=this.config.baseSub,n=0;n<r;n++)this.loadSubStream(n)}}},{key:"_abortAllRequest",value:function(){var e=this;this._downloadTask.forEach(function(t,r){e.abort({},r)})}},{key:"loadMainStream",value:function(){this.stateMgr.loadMainReset(),this.stateMgr.stopAutoFetchSubStreamOnce();var e=this._getMainConfig();return this._load(e)}},{key:"stopMainStream",value:function(){var e=this._getMainConfig();this.abort(e)}},{key:"loadSubStream",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],r=this._getSubConfig(e);if(t){var n=this._getSubConfig(e),i=this.getRequestKey(n),a=this._loadRecord.get(i);a&&Date.now()-a>this.tp2p.config.subStreamLoadInterval&&this.stopSubStream(e)}return this.stateMgr.setSubStreamState(e,d.SubLoadingState.LOADING),this._load(r)}},{key:"stopSubStream",value:function(e){var t=this._getSubConfig(e);this.abort(t)}},{key:"loadFragments",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=this.tp2p.config.fillMaxTaskSize;if(this._fragmentReqLen>=r)return this._reportData[a.ReportField.FILL_FULL_QUE]+=1,this.tp2p.trigger(s.default.FILL_FRAGMENT_FAIL,{sliceArray:e}),-1;this._fragmentCounter+=1;var n=this._getFragmentConfig(e,t);return this._load(n)}},{key:"_load",value:function(e){var t=this.getRequestKey(e);if(!this._downloadTask.has(t)){switch(e.type){case d.RequestType.SUB_STREAM:this._reportData[a.ReportField.LOAD_SUB_COUNT]+=1;break;case d.RequestType.FRAGMENT:this._fragmentReqLen+=1}this._loadRecord.set(t,Date.now());var r=this.pcdnController.load(e);return this._downloadTask.set(t,r),r}}},{key:"abort",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";e&&e.type===d.RequestType.SUB_STREAM&&this.stateMgr.setSubStreamState(e.query.substream,d.SubLoadingState.IDLE);var r=t||this.getRequestKey(e);this._downloadTask.has(r)&&((-1<t.indexOf("fragment")||e.type===d.RequestType.FRAGMENT)&&(this._fragmentReqLen-=1),this.pcdnController.abort(this._downloadTask.get(r)),this._downloadTask.delete(r))}},{key:"_getMainConfig",value:function(){var e={type:d.RequestType.MAIN_STREAM,enableAbortController:this.tp2p.config.enableAbortController,query:{playid:this.tp2p.config.randomPlayId,uuid:u.default.myUUID().UUID||"error"}},t=this._specifyStreamDelay();return t&&(e.query.delay=t),e}},{key:"_specifyStreamDelay",value:function(){if(this.stateMgr.playStart)return 0;var e=this.tp2p.config;return f.default.SpecifyDelayRoom(this.pcdnController.streamId,e.assignDelayRooms)?e.assignDelay:0}},{key:"_getSubConfig",value:function(e){return{type:d.RequestType.SUB_STREAM,enableAbortController:this.tp2p.config.enableAbortController,query:{startid:this.stateMgr.getLastSubStreamId(e)+this.config.baseSub,substream:e,basesub:this.config.baseSub,playid:this.tp2p.config.randomPlayId,uuid:u.default.myUUID().UUID||"error"}}}},{key:"_getFragmentConfig",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=this.tp2p.config;return{type:d.RequestType.FRAGMENT,bakOC:t.bakOC,timeout:r.fillTimeout||2e3,enableAbortController:r.enableAbortController,query:{slicenum:e.join(","),playid:r.randomPlayId,uuid:u.default.myUUID().UUID||"error",reqid:this._fragmentCounter},context:{start:Date.now()}}}},{key:"getRequestKey",value:function(e){switch(e.type){case d.RequestType.MAIN_STREAM:return"main";case d.RequestType.SUB_STREAM:return"sub"+e.query.substream;case d.RequestType.FRAGMENT:return"fragment"+this._fragmentCounter}}},{key:"findKeyByServerId",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=this._downloadTask[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;if(o[1]===e)return o[0]}}catch(e){r=!0,n=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw n}}}},{key:"onResOk",value:function(e,t,r){if(t===d.RequestType.SUB_STREAM)this._retrySub.delete(e);else if(t===d.RequestType.FRAGMENT)this._reportData[a.ReportField.FILL_REQ_OK]+=1,r.ok=!0;else if(t===d.RequestType.MAIN_STREAM&&(this._retrySub.delete(e),!this.stateMgr.playStart)){var n=this.tp2p.config.loadTime;this._reportData[a.ReportField.RES_OK]=Date.now()-n}}},{key:"onNotFound",value:function(e,t,r){switch(t){case d.RequestType.SUB_STREAM:return this._notFoundDecision();case d.RequestType.MAIN_STREAM:this._notFoundDecision()||this._processFail(e,t,r,a.ReportField.ROLLBACK_STREAM_404);break;case d.RequestType.FRAGMENT:this._processFail(e,t,r,a.ReportField.ROLLBACK_STREAM_404)}}},{key:"_notFoundDecision",value:function(){return this.stateMgr.playStart?!!this._monitorNotFound(this.tp2p.config.rollback404)&&(this.tp2p.config.rollback404?this._reportAndRollback(a.ReportField.ROLLBACK_STREAM_404):this._reportEndOfStream(),!0):(this._reportAndRollback(a.ReportField.ROLLBACK_STREAM_404),!0)}},{key:"_monitorNotFound",value:function(e){return!!e||(this.stateMgr.notFoundCounter+=1,this.stateMgr.notFoundCounter>=this.tp2p.config.eos404Limit)}},{key:"onForbidden",value:function(e,t,r){this._processFail(e,t,r,a.ReportField.ROLLBACK_STREAM_403)}},{key:"onNetworkError",value:function(e,t,r){this._processFail(e,t,r,a.ReportField.ROLLBACK_NETWORK_ERR)}},{key:"onFinished",value:function(e,t,r){this._processFail(e,t,r,a.ReportField.ROLLBACK_STREAM_END)}},{key:"onUnknownError",value:function(e,t,r){this._processFail(e,t,r,a.ReportField.ROLLBACK_STREAM_UNKNOWN_ERR)}},{key:"onTimeout",value:function(e,t,r){this._processFail(e,t,r,a.ReportField.ROLLBACK_STREAM_TIMEOUT)}},{key:"onReadError",value:function(e,t,r){this._processFail(e,t,r,a.ReportField.ROLLBACK_READ_ERR)}},{key:"onResHeader",value:function(e,t,r,n){this.tp2p.config.parseHeader&&t===d.RequestType.FRAGMENT&&this._parseHeader(n,r)}},{key:"_parseHeader",value:function(e,t){var r=e.header,n=r["x-tlive-detailerrmsg"]||r["X-Tlive-DetailErrMsg"];if(-1===["null","NULL"].indexOf(n)){var i=this._parseErrMsg(n),o=i.sliceRange,l=i.earlySlice,c=i.missSlice,u=i.expireSlice;o.length&&(this.stateMgr.fillSliceRange=o);var d=c.concat(u);d.length&&this.tp2p.trigger(s.default.FILL_FRAGMENT_FAIL,{sliceArray:d,failReason:a.ReportField.ROLLBACK_STREAM_404});var p=this._reportData;p[a.ReportField.EARLY_COUNT]+=l.length,p[a.ReportField.EXPIRE_COUNT]+=u.length,p[a.ReportField.MISS_COUNT]+=c.length}else t.noErrDetailHeader=!0}},{key:"_parseErrMsg",value:function(e){var t=[],r=[],n=[],i=[];if(e){var a=e.split("/"),o=a[1];if(a[0]&&(t=a[0].split("-").map(function(e){return+e||0})),o){var s=o.split(";"),l=s[0],c=s[1],u=s[2];l&&(r=l.split(",").map(function(e){return+e})),c&&(n=c.split(",").map(function(e){return+e})),u&&(i=u.split(",").map(function(e){return+e}))}}return{sliceRange:t,earlySlice:r,missSlice:n,expireSlice:i}}},{key:"onSliceNotFound",value:function(){this._reportAndRollback(a.ReportField.ROLLBACK_SLICE_NOT_FOUND)}},{key:"_processFail",value:function(e,t,r,n){var i=this;if(t===d.RequestType.MAIN_STREAM){var o=this.tp2p.config.mainMaxRetryCount-1,l=this._retrySub.get(e)||0;if(o<l&&n!==a.ReportField.ROLLBACK_STREAM_404)return void this._reportAndRollback(n);this._retrySub.delete(e),this.abort(r),this._retryMainTimer=setTimeout(function(){var e=i.loadMainStream();i._retrySub.set(e,l+1)},this.tp2p.config.retryMainDelay)}else if(t===d.RequestType.SUB_STREAM)this._reportLoadSubError(n),this.abort(r);else if(t===d.RequestType.FRAGMENT){var c=[];if(r.query.slicenum.split(",").forEach(function(e){c.push(+e)}),n===a.ReportField.ROLLBACK_STREAM_END?Date.now()-r.context.start<=1e3?this._reportData[a.ReportField.FILL_DURATION].ms1000+=1:this._reportData[a.ReportField.FILL_DURATION].ms2000+=1:n===a.ReportField.ROLLBACK_STREAM_404?(this._reportData[a.ReportField.FILL_REQ_404]+=1,this._reportData[a.ReportField.FILL_REQ_404]+this._reportData[a.ReportField.FILL_BAK_404]<8&&(this._reportData[a.ReportField.FILL_404_ID]+=c[0]+"-"+c[c.length-1]+"-"+this.stateMgr.nextWriteId+"-"+this.stateMgr.maxSliceId+"-"+(r.bakOC?"bak":"sug")+",")):n===a.ReportField.ROLLBACK_STREAM_TIMEOUT&&(this._reportData[a.ReportField.FILL_REQ_TIMEOUT]+=1,t.ok&&(this._reportData[a.ReportField.FILL_TIMEOUT_OK]+=1),this._reportData[a.ReportField.FILL_TIMEOUT_ID]+=r.query.reqid+"-"+!!r.ok+"-"+this.tp2p.bufferLength+"'}, "),this.abort("",this.findKeyByServerId(e)),this.tp2p.config.parseHeader)n===a.ReportField.ROLLBACK_STREAM_404&&r.noErrDetailHeader&&0<c.length&&this.tp2p.trigger(s.default.FILL_FRAGMENT_FAIL,{sliceArray:c,failReason:n});else{var u=[];c.forEach(function(e){i.storage.has(e)||u.push(e)}),0<u.length&&this.tp2p.trigger(s.default.FILL_FRAGMENT_FAIL,{sliceArray:u,failReason:n})}}}},{key:"_reportLoadSubError",value:function(e){var t=void 0;switch(e){case a.ReportField.ROLLBACK_STREAM_404:t=a.ReportField.NOT_FOUND_COUNT;break;case a.ReportField.ROLLBACK_STREAM_403:t=a.ReportField.FORBIDDEN_COUNT;break;case a.ReportField.ROLLBACK_NETWORK_ERR:t=a.ReportField.NETWORK_ERROR_COUNT;break;case a.ReportField.ROLLBACK_STREAM_END:t=a.ReportField.FINISHED_COUNT;break;case a.ReportField.ROLLBACK_STREAM_UNKNOWN_ERR:t=a.ReportField.UNKNOWN_ERROR_COUNT;break;case a.ReportField.ROLLBACK_STREAM_TIMEOUT:t=a.ReportField.TIMEOUT_COUNT;break;case a.ReportField.ROLLBACK_READ_ERR:t=a.ReportField.READ_ERROR_COUNT}this._reportData[t]+=1}},{key:"_reportAndRollback",value:function(e){var t,r,n;this._rollback||(this._rollback=!0,this.tp2p.trigger(s.default.ERROR,{type:o.ErrorTypes.NETWORK_ERROR,fatal:!0,rollbackCode:a.ReportCode.ROLLBACK,extendReportData:(t={},r=a.ReportField.ROLLBACK_REASON,n=e,r in t?Object.defineProperty(t,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[r]=n,t)}))}},{key:"_reportEndOfStream",value:function(){this._rollback||(this._rollback=!0,this.tp2p.trigger(s.default.ERROR,{type:o.ErrorTypes.NETWORK_ERROR,fatal:!0,rollbackCode:a.ReportCode.END_OF_STREAM}))}},{key:"_initReporterData",value:function(){this._reportData={};var e=this._reportData;e[a.ReportField.FILL_REQ_OK]=0,e[a.ReportField.FILL_SLICE_OK]=0,e[a.ReportField.RES_OK]=0,e[a.ReportField.FILL_REQ_404]=0,e[a.ReportField.FILL_REQ_TIMEOUT]=0,e[a.ReportField.FILL_TIMEOUT_OK]=0,e[a.ReportField.FILL_FULL_QUE]=0,e[a.ReportField.FILL_404_ID]="",e[a.ReportField.FILL_TIMEOUT_ID]="",e[a.ReportField.FILL_DURATION]={ms1000:0,ms2000:0},e[a.ReportField.SUB_MAX_ID]="",e[a.ReportField.SUB_CONTINUOUS_ID]="",e[a.ReportField.FILL_REQ_OK]=0,e[a.ReportField.FILL_BAK_404]=0,e[a.ReportField.FILL_BAK_TIMEOUT]=0,e[a.ReportField.STREAM_STATE]="",e[a.ReportField.LOAD_SUB_COUNT]=0,e[a.ReportField.NOT_FOUND_COUNT]=0,e[a.ReportField.FORBIDDEN_COUNT]=0,e[a.ReportField.NETWORK_ERROR_COUNT]=0,e[a.ReportField.FINISHED_COUNT]=0,e[a.ReportField.UNKNOWN_ERROR_COUNT]=0,e[a.ReportField.TIMEOUT_COUNT]=0,e[a.ReportField.READ_ERROR_COUNT]=0,e[a.ReportField.EARLY_COUNT]=0,e[a.ReportField.MISS_COUNT]=0,e[a.ReportField.EXPIRE_COUNT]=0}},{key:"reportCallback",value:function(){this._reportData[a.ReportField.STREAM_STATE]=this.stateMgr.getAllSubStreamState(),0===this._reportData[a.ReportField.FILL_REQ_OK]&&delete this._reportData[a.ReportField.FILL_DURATION];for(var e=this.stateMgr,t=[],r=[],n=0;n<this.config.baseSub;n++)t.push(e.getMaxSubStreamId(n)),r.push(e.getLastSubStreamId(n));this._reportData[a.ReportField.SUB_MAX_ID]=t.join("-"),this._reportData[a.ReportField.SUB_CONTINUOUS_ID]=r.join("-");var i=this._reportData;for(var o in i)i[o]||delete i[o];return this._initReporterData(),i}}]),t}();r.default=_},{17:17,18:18,19:19,32:32,34:34,36:36,39:39,77:77,85:85}],38:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.SubStreamStatus=void 0;var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=e(77),o=(n=e(19))&&n.__esModule?n:{default:n},s=r.SubStreamStatus={OUT_GAP:0,IN_GAP:1},l=function(){function e(t,r){var n=this;!function(t,r){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this),this.TAG="SubStreamMonitor",this.tp2p=r,this.stateMgr=t.stateMgr,this.storage=t.storage,this.switchController=t.switchController,this.baseSub=r.config.pcdnStreams,this._streamState=[],this._checkTimeout=null;for(var i=0;i<this.baseSub;i++)this._streamState.push({cdn:{ts:0,continuous:0}});0<r.config.ssmCheckInterval&&(this._checkTimeout=setInterval(function(){n._checkSubStream()},r.config.ssmCheckInterval)),this._initReporterData(),this.tp2p.registerReportCallback(this.TAG,this.reportCallback.bind(this))}return i(e,[{key:"destroy",value:function(){this._streamState=[],clearInterval(this._checkTimeout)}},{key:"_getSubStreamStatus",value:function(e){var t=this.stateMgr,r=t.p2pBoundId,n=t.frameRate,i=this.tp2p.config.ssmResGap2PR;if(!i)return s.OUT_GAP;for(var a=t.getLastSubStreamId(e),o=t.getMaxSubStreamId(e),l=a+this.baseSub,c=o;l<=c;l+=this.baseSub)this.storage.has(l)&&(a+=this.baseSub);return r+Math.round(i/1e3*n)<=a?s.OUT_GAP:s.IN_GAP}},{key:"_checkSubStream",value:function(){if(this._streamState.length){for(var e=this.stateMgr.loadingMain,t=null,r=0;r<this.baseSub;r++){var n=this.stateMgr.getLastSubStreamId(r);t=Math.min(t||n,n)}if(!e&&null!==t){var i=t%this.baseSub,l=this._getSubStreamStatus(i),c=this._streamState[i].cdn;if(l===s.IN_GAP){var u=Date.now(),d=this.tp2p.config,p=d.ssmContinuousCount,f=d.ssmEmitInterval;if(u-c.ts>=f)return c.continuous++,void(c.continuous>=p&&(c.continuous=0,c.ts=u,this.tp2p.trigger(o.default.PULL_SUB_STREAM,{subStreamId:i}),this._reportData[a.ReportField.SSM_PULL_STREAM]++))}c.continuous=0}}}},{key:"_initReporterData",value:function(){this._reportData={},this._reportData[a.ReportField.SSM_PULL_STREAM]=0}},{key:"reportCallback",value:function(){var e=this._reportData;return this._initReporterData(),e}}]),e}();r.default=l},{19:19,77:77}],39:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,null,[{key:"LoadMainWithZTC",value:function(e,t){return!!t&&-1!==e.indexOf(t)}},{key:"DomainStuckRollback",value:function(e,t){for(var r=0;r<t.length;r++)if(-1!==e.indexOf(t[r]))return!1;return!0}},{key:"SpecifyDelayRoom",value:function(e,t){if(!t||0===t.length)return!1;for(var r=0;r<t.length;r++)if(-1!==e.indexOf(t[r]))return!0;return!1}}]),e}();r.default=i},{}],40:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="TimerManager-"+t,this.timer=new Map}return n(e,[{key:"destroy",value:function(){this.timer.forEach(function(e,t){clearTimeout(e)}),this.timer.clear()}},{key:"has",value:function(e){return this.timer.has(e)}},{key:"clearTimeout",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){var t=this.timer.get(e);clearTimeout(t),this.timer.delete(e)})},{key:"clearInterval",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){var t=this.timer.get(e);clearInterval(t),this.timer.delete(e)})},{key:"set",value:function(e,t){this.has(e),this.timer.set(e,t)}}]),e}();r.default=i},{}],41:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=(n=e(93))&&n.__esModule?n:{default:n},o=function(){function e(t,r){var n=t.timeout,i=r.onSuccess,a=r.onError;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="ZTCLoader",this.timeout=n,this.onSuccess=i,this.onError=a,this.maxRetryTimes=2,this.retryDelay=500,this.maxRetryDelay=1e3,this.streamId="",this.ztcDomain="",this.uuid="",this.playId="",this.subDomain={sug:"",bak:""}}return i(e,[{key:"destroy",value:function(){this._loader&&(this._loader.destroy(),this._loader=null)}},{key:"init",value:function(e){var t=e.ztcDomain,r=e.streamId,n=e.uuid,i=e.playId;this.ztcDomain=t,this.streamId=r,this.uuid=n,this.playId=i}},{key:"load",value:function(){this._loader&&this._loader.destroy(),this._loader=new a.default;var e,t,r,n="https://"+this.ztcDomain+"/"+this.streamId+".xs?playid="+this.playId+"&uuid="+this.uuid;e={tag:"tracker_"+Date.now(),url:n,method:"GET",responseType:"text"},t={timeout:this.timeout,maxRetry:this.maxRetryTimes,retryDelay:this.retryDelay,maxRetryDelay:this.maxRetryDelay},r={onSuccess:this.loadSuccess.bind(this),onError:this.loadError.bind(this),onTimeout:this.loadTimeout.bind(this)},this._loader.load(e,t,r)}},{key:"loadSuccess",value:function(e,t,r){3<arguments.length&&void 0!==arguments[3]&&arguments[3];var n=e.data;try{var i=JSON.parse(n);this.subDomain.sug=i.sug[0]||"",this.subDomain.bak=i.bak[0]||"",this.onSuccess()}catch(e){}}},{key:"loadError",value:function(e,t,r){3<arguments.length&&void 0!==arguments[3]&&arguments[3],t.retry>=this.maxRetryTimes&&this.onError()}},{key:"loadTimeout",value:function(e,t){2<arguments.length&&void 0!==arguments[2]&&arguments[2],e.retry>=this.maxRetryTimes&&this.onError()}},{key:"gotDomainConfig",get:function(){return this.subDomain.sug&&this.subDomain.bak}},{key:"sug",get:function(){return this.subDomain.sug}},{key:"bak",get:function(){return this.subDomain.bak}}]),e}();r.default=o},{93:93}],42:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=e(32),a=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.baseSub=t.pcdnStreams,this.xStreamId=t.xStreamId,this.globalConfig=r.config,this.initiator=t,this.tp2p=r,this.storage=t.storage,this.reset()}return n(e,[{key:"reset",value:function(){this.frameRate=30,this.playSkipSucc=!1,this.playStart=!1,this.nextWriteId=0,this.confirmLoss=new Set,this.confirmLossSkipSliceId=0,this.firstSubSliceId=0,this.lastMainSliceId=0,this.reloadingMain=!1,this.loadingMain=!1,this.baseTime=Date.now(),this.baseId=0,this.stuck=!1,this.notFoundCounter=0,this.subStreamState={},this._fillSliceRange=[0,0,Date.now()],this._maxSliceId=0,this._subStreamMaxContinousId=[],this._subStreamMaxId=[];for(var e=0;e<this.baseSub;e++)this._subStreamMaxContinousId.push(0),this._subStreamMaxId.push(0),this.subStreamState[e]=i.SubLoadingState.LOADING_MAIN}},{key:"setSubStreamId",value:function(e){this.setMaxSliceId(e);var t=e%this.baseSub,r=this._subStreamMaxContinousId[t];if(0===r)this._subStreamMaxContinousId[t]=e;else{if(this.nextWriteId-r>this.baseSub){var n=t-this.nextWriteId%this.baseSub;r=this.nextWriteId+(n<=0?n:n-this.baseSub),this._subStreamMaxContinousId[t]=r}for(;this.storage.has(r)||this.confirmLoss.has(r);)this._subStreamMaxContinousId[t]=r,r+=this.baseSub}e>this._subStreamMaxId[t]&&(this._subStreamMaxId[t]=e)}},{key:"resetSubMaxCon",value:function(){this._subStreamMaxContinousId=[];for(var e=0;e<this.baseSub;e++)this._subStreamMaxContinousId.push(0)}},{key:"getLastSubStreamId",value:function(e){return this._subStreamMaxContinousId[e]}},{key:"getMaxSubStreamId",value:function(e){return this._subStreamMaxId[e]}},{key:"setMaxSliceId",value:function(e){e>this._maxSliceId&&(this._maxSliceId=e)}},{key:"stopAutoFetchSubStreamOnce",value:function(){for(var e=0;e<this.baseSub;e++)this.subStreamState[e]=i.SubLoadingState.LOADING_MAIN}},{key:"getAllSubStreamState",value:function(){for(var e="",t=["i","s","m"],r=0;r<this.baseSub;r++)e+=t[this.getSubStreamState(r)]+"-";return e}},{key:"getSubStreamState",value:function(e){return this.subStreamState[e]}},{key:"setSubStreamState",value:function(e,t){this.subStreamState[e]=t}},{key:"onCdnLoaded",value:function(e){var t=this.initiator.p2pController;t&&t.onCdnLoaded(e)}},{key:"onP2PLoaded",value:function(e){var t=this.initiator.p2pController;t&&t.onP2pLoaded(e)}},{key:"loadMainReset",value:function(){this.firstSubSliceId=0,this.lastMainSliceId=0}},{key:"maxXSubStreamId",get:function(){return this._subStreamMaxId[this.xStreamId]}},{key:"maxSliceId",get:function(){return this._maxSliceId}},{key:"p2pBoundId",get:function(){return this.maxSliceId-this.frameRate*this.globalConfig.p2pWindow}},{key:"lowLatency",get:function(){return this.tp2p.bufferLength<this.globalConfig.fillMinBuf&&this.p2pBoundId<this.nextWriteId}},{key:"maxContinuousId",get:function(){return this.initiator.storageMgr.maxContinuousId}},{key:"minSliceId",get:function(){return this.initiator.storageMgr.minSliceId}},{key:"playId",get:function(){return this.nextWriteId-this.tp2p.bufferLength*this.frameRate}},{key:"realDelay",get:function(){return(this.maxSliceId-this.playId)/this.frameRate}},{key:"fillSliceRange",get:function(){var e=this._fillSliceRange.slice(0,2);return 0<e[1]&&(e[1]+=Math.floor((Date.now()-this._fillSliceRange[2])/1e3*this.frameRate)),e},set:function(e){e instanceof Array&&2===e.length&&(this._fillSliceRange=e.concat(Date.now()))}}]),e}();r.default=a},{32:32}],43:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.FlvConst={FLV_HEADER_LEN:9,TAG_HEADER_LEN:11,PREV_TAG_SIZE_LEN:4,AUDIO_TAG:8,VIDEO_TAG:9,SCRIPT_TAG:18,I_FRAME:1,NAL_VPS:32,NAL_SPS:33,NAL_PPS:34}},{}],44:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=s(e(46)),a=e(43),o=s(e(45));function s(e){return e&&e.__esModule?e:{default:e}}var l=function(){function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="FlvDemux",this.observer=t.observer,this._parseFlvHead=t.parseFlvHead,this._firstSliceFound=!1,this._writeFlvHead=t.writeFlvHead,this._requestType=t.requestType,this._naluLengthSize=4,this.loaderBuffer=t.loaderBuffer,this.tagCache=new i.default,this.observer.on("frag_loaded",this._fragLoaded.bind(this))}return n(e,[{key:"_fragLoaded",value:function(){if(this._parseFlvHead){if(this.loaderBuffer.length<a.FlvConst.FLV_HEADER_LEN+a.FlvConst.PREV_TAG_SIZE_LEN)return;this._readFlvHeader(),this._fragLoaded()}else for(var e=void 0;null!==(e=this._readTag());)this._parseTag(e)}},{key:"_readFlvHeader",value:function(){this._parseFlvHead=!1;var e=this.loaderBuffer.shift(13);this.tagCache.push(e)}},{key:"_readTag",value:function(){if(this.loaderBuffer.length<a.FlvConst.TAG_HEADER_LEN)return null;var e=this.loaderBuffer.toInt(1,3),t=a.FlvConst.TAG_HEADER_LEN+e+a.FlvConst.PREV_TAG_SIZE_LEN;if(this.loaderBuffer.length<t)return null;var r=this.loaderBuffer.shift(t);return this.tagCache.push(r),r}},{key:"_parseTag",value:function(e){switch(31&e[0]){case a.FlvConst.VIDEO_TAG:this._parseVideoTag(e),this._writeFlvHead&&!this._firstSliceFound&&this.observer.emit("video_tag")}}},{key:"_parseVideoTag",value:function(e){7===(15&e[a.FlvConst.TAG_HEADER_LEN])&&this._parseAVCVideoPacket(e)}},{key:"_parseAVCVideoPacket",value:function(e){var t=1,r=(e[t++]<<16)+(e[t++]<<8)+e[t++];if(!(r<4)){var n=a.FlvConst.TAG_HEADER_LEN+1;1===e[n]&&this._parseAVCVideoData(e,r,n+4)}}},{key:"_parseAVCVideoData",value:function(e,t,r){for(var n=t-5,i=this._naluLengthSize,a=0;a<n&&!(n<=a+4);){var s=r+a,l=(e[s]<<32)+(e[s+1]<<16)+(e[s+2]<<8)+e[s+3];if(3===i&&(l>>>=8),n-i<l)return;var c=r+1+a+i,u=c+l-1;if(6===e[c-1]){var d=e.slice(c,u),p=o.default.parseSEI(d);if(p){var f=(e[4]<<16)+(e[5]<<8)+e[6]+(e[7]<<24);p.tagTimestamp=f,this._deleteSEINalu(e,r+a,l+i),this._findSliceVideoTag(p);break}}a+=4+l}}},{key:"_deleteSEINalu",value:function(e,t,r){var n=e.length,i=new ArrayBuffer(n-r),a=new Uint8Array(i),o=a.length;a.set(e.slice(0,t),0),a.set(e.slice(t+r),t);var s=new DataView(i),l=16777215&s.getUint32(0,!1),c=s.getUint8(0);s.setUint32(0,l-r),s.setUint8(0,c);var u=s.getUint32(o-4);s.setUint32(o-4,u-r),this.tagCache.pop(),this.tagCache.push(a)}},{key:"_findSliceVideoTag",value:function(e){var t=e.idx,r=e.frames,n=e.tagTimestamp;if(this._firstSliceFound){var i=this.tagCache.size;i!==r&&this.observer.emit("slice_error",{sliceId:t,diff:r+"_"+i+"_"+this._requestType})}var a=this.tagCache.getSlice(r);if(this.observer.emit("found_slice",{sliceId:t,payload:a,tagTime:n,requestType:this._requestType}),!this._firstSliceFound&&(this._firstSliceFound=!0,this._writeFlvHead)){var o=this.tagCache.getSlice(0,!0);this.observer.emit("found_flv_head",{startSliceId:t,payload:o})}this.tagCache.clear()}}]),e}();r.default=l},{43:43,45:45,46:46}],45:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,r=t.byteLength,n=new Uint8Array(r),i=0,a=0;a<r;a++)2<=a&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(n[i]=t[a],i++);return new Uint8Array(n.buffer,0,i)}},{key:"parseSEI",value:function(t){for(var r=e._ebsp2rbsp(t),n=new DataView(r.buffer),i=0,a=0,o=0,s=void 0,l=void 0;l=n.getUint8(o),o+=1,i+=l,255===l;);for(;l=n.getUint8(o),o+=1,a+=l,255===l;);switch(i){case 5:s=e.decodeUnregisteredUserData(n,o,a)}return s}},{key:"decodeUnregisteredUserData",value:function(e,t,r){if(r<16||30<r)return null;for(var n=[84,101,110,99,101,110,116,83,116,114,101,97,109,83,69,73],i=0;i<16;i++)if(e.getUint8(t+i)!==n[i])return null;t+=16;var a={uuid:"",idx:"",frames:"",timestamp:""};return a.uuid="tencentStreamSEI",a.idx=e.getUint32(t),t+=4,a.frames=e.getUint16(t),t+=2,a.timestamp=e.getUint32(t)<<32+e.getUint32(t+4),a}}]),e}();r.default=i},{}],46:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cache=[]}return n(e,[{key:"push",value:function(e){this.cache.push(e)}},{key:"pop",value:function(){return this.cache.pop()}},{key:"getSlice",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],r=this.cache.length,n=void 0;r===e||t?(n=this.cache,this.cache=[]):n=this.cache.splice(r-e);var i=0;n.forEach(function(e){i+=e.length});var a=new Uint8Array(i),o=0;return n.forEach(function(e){a.set(e,o),o+=e.length}),a}},{key:"clear",value:function(){this.cache=[]}},{key:"size",get:function(){return this.cache.length}}]),e}();r.default=i},{}],47:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=S(e(8)),a=S(e(73)),o=S(e(76)),s=S(e(42)),c=S(e(37)),u=S(e(53)),d=S(e(75)),p=S(e(52)),f=S(e(31)),h=S(e(30)),_=S(e(19)),v=e(77),m=S(e(58)),y=S(e(33)),g=S(e(82)),b=S(e(38));function S(e){return e&&e.__esModule?e:{default:e}}var T=function(e){function t(e,r){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));n.TAG="PCDNInitiator",n.tp2p=e,n.startedHook=r,n.pcdnStreams=e.config.pcdnStreams,n._xStreamId=void 0!==e.config.xStreamId?e.config.xStreamId:Math.floor(n.pcdnStreams*Math.random());var i=n.storage=new a.default;n.stateMgr=new s.default(n,e);var m=n.storageMgr=new d.default(n,e),S=n.subStreamMonitor=new b.default(n,e),T=n.switchController=new c.default(n,e,{baseSub:n.pcdnStreams}),R=n.writer=new o.default(n,e),C=n.videoProxy=new u.default,E=n.videoManager=new p.default(n,e),k=n.fillStreamHole=new y.default(n,e),I=n.confLoader=new f.default(e),O=n.confController=new h.default(e);return n.coreComponents=[k,i,S,T,R,C,m,E,I,O],n.lazyStartComponents=[R,k,E],e.on(_.default.LOADED_DATA,function(){if(!n.stateMgr.playStart){var e={i:{}};e[v.ReportField.CODE]=v.ReportCode.PHASE_DATA,e.i[v.ReportField.LOAD_OK_TIME]=Date.now()-n.tp2p.config.loadTime;var t=g.default.pageVisibility();e.i[v.ReportField.PLAY_VISIBLE]=t.pageVisible,n.tp2p.trigger(_.default.REPORT_ONCE,e),n.stateMgr.playStart=!0,n.tp2p.status.isFirstPieceDownloaded=!0,n.tp2p.trigger(_.default.CONF_LOADING)}}),e.on(_.default.FIRST_CONF_LOADED,function(){n.startLazyComponents(),n.startedHook&&n.startedHook(),e.config.useP2p&&n._lazyStartP2P()}),e.on(_.default.CONF_FAIL,function(){n.startLazyComponents(),n.startedHook&&n.startedHook()}),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,i.default),n(t,[{key:"destroy",value:function(){this.coreComponents.forEach(function(e){e.destroy()})}},{key:"startLazyComponents",value:function(){this.lazyStartComponents.forEach(function(e){e&&e.onStarting()})}},{key:"stopLazyComponents",value:function(){this.lazyStartComponents.forEach(function(e){e&&e.onStopping()})}},{key:"_lazyStartP2P",value:function(){var e=this.p2pController=new m.default(this,this.tp2p);this.coreComponents.push(e),this.lazyStartComponents.push(e),this.tp2p.trigger(_.default.TRACKER_STARTING)}},{key:"load",value:function(){var e=this.tp2p.config.channelId;this.switchController.startLoad(e)}},{key:"setMediaElement",value:function(e){this.videoProxy.setVideoByElement(e)}},{key:"localPeerId",get:function(){return this._localPeerId},set:function(e){this._localPeerId=e}},{key:"xStreamId",get:function(){return this._xStreamId},set:function(e){this._xStreamId=e}}]),t}();r.default=T},{19:19,30:30,31:31,33:33,37:37,38:38,42:42,52:52,53:53,58:58,73:73,75:75,76:76,77:77,8:8,82:82}],48:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=d(e(6)),a=d(e(49)),o=d(e(74)),s=d(e(44)),c=d(e(50)),u=e(32);function d(e){return e&&e.__esModule?e:{default:e}}var p=function(e){function t(e,r,n,i){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var d=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));d.TAG="DownloadServer",d.id=r,d.isMainStream=n===u.RequestType.MAIN_STREAM,d.isSubStream=n===u.RequestType.SUB_STREAM,d.requestType=n,d.config=i,d.loaderBuffer=new o.default,d.flvDemux=new s.default({parseFlvHead:d.isMainStream||d.isSubStream,writeFlvHead:d.isMainStream,loaderBuffer:d.loaderBuffer,observer:d,requestType:n});var p=a.default.support()?a.default:c.default,f=function(e,t){var r={serverId:d.id,requestType:d.requestType,requestConfig:d.config,httpReportType:e,data:t};d.emit("http_status",r)};return n===u.RequestType.FRAGMENT&&i.timeout&&(d.timeoutTimeout=setTimeout(function(){f(u.HttpReportType.TIMEOUT),d.timeoutTimeout=null},i.timeout)),d.streamLoader=new p({url:e,timeout:n===u.RequestType.FRAGMENT?2*i.timeout:i.timeout,streamingDownload:n!==u.RequestType.FRAGMENT,enableAbortController:i.enableAbortController,onLoadBuffer:function(e){d.loaderBuffer.push(e),d.emit("frag_loaded",e.byteLength,n)},onHttpReport:f}),d}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,i.default),n(t,[{key:"destroy",value:function(){this.timeoutTimeout&&clearTimeout(this.timeoutTimeout),this.streamLoader.destroy(),this.loaderBuffer.clear(),this.streamLoader=this.loaderBuffer=this.flvDemux=null}}]),t}();r.default=p},{32:32,44:44,49:49,50:50,6:6,74:74}],49:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=e(32),a=function(){function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="FetchStreamLoader",this.onLoadBuffer=t.onLoadBuffer,this.onHttpReport=t.onHttpReport,this._abort=!1,this._timeout=t.timeout||4e3,this._enableAbortController=t.enableAbortController,this._abortController=null,this._open(t.url)}return n(e,[{key:"abort",value:function(){this._abortController&&this._enableAbortController&&this._abortController.abort(),this._abort=!0,this._readerInstance&&(this._readerInstance.cancel().catch(function(e){}),this._readerInstance=null)}},{key:"destroy",value:function(){this.abort(),this.onHttpReport=function(){},this.onLoadBuffer=function(){}}},{key:"_open",value:function(e){var t=this;if(!this._readerInstance){var r={method:"GET",mode:"cors",referrerPolicy:"no-referrer-when-downgrade"};window.AbortController&&(this._abortController=new window.AbortController,r.signal=this._abortController.signal);var n=window.fetch(e,r).then(function(e){if(!t._abort)return Promise.resolve(e);t._readerInstance||(t._readerInstance=e.body.getReader(),t.abort())}).catch(function(e){if(!t._abort)return Promise.reject(e)}),a=new Promise(function(e,r){setTimeout(function(){r("timeout")},t._timeout)});Promise.race([n,a]).then(function(e){if(!t._abort){var r=e.headers,n=t._getHeader(r);t.onHttpReport(i.HttpReportType.REPORT_RES_HEADER,{header:n}),e.ok&&200<=e.status&&e.status<=209?(t.onHttpReport(i.HttpReportType.CODE_200),t._readerInstance=e.body.getReader(),t._pump(t._readerInstance)):404===e.status?t.onHttpReport(i.HttpReportType.CODE_404):403===e.status?t.onHttpReport(i.HttpReportType.CODE_403):t.onHttpReport(i.HttpReportType.UNKNOWN_ERROR)}}).catch(function(e){t._abort||("timeout"===e?t.onHttpReport(i.HttpReportType.TIMEOUT):t.onHttpReport(i.HttpReportType.NETWORK_ERROR))})}}},{key:"_pump",value:function(e){var t=this;this._abort||e.read().then(function(r){var n=r.done,a=r.value;n?t._readerInstance&&(t._readerInstance=null,t.onHttpReport(i.HttpReportType.DONE)):(t.onLoadBuffer&&t.onLoadBuffer(a),t._pump(e))}).catch(function(e){t._abort||t.onHttpReport(i.HttpReportType.READ_ERROR)})}},{key:"_getHeader",value:function(e){var t={},r=!0,n=!1,i=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;t[s[0]]=s[1]}}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}return t}}],[{key:"support",value:function(){return!!(window.fetch&&window.ReadableStream&&Uint8Array)}}]),e}();r.default=a},{32:32}],50:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=(n=e(93))&&n.__esModule?n:{default:n},o=e(32),s=function(){function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="XhrStreamLoader",this.onLoadBuffer=t.onLoadBuffer,this.onHttpReport=t.onHttpReport,this._abort=!1,this._streamingDownload=t.streamingDownload,this._timeout=t.timeout||4e3,this._open(t.url)}return i(e,[{key:"abort",value:function(){this._abort=!0,this.loader&&this.loader.abort()}},{key:"destroy",value:function(){this.loader&&this.loader.destroy()}},{key:"_open",value:function(e){this.loader=new a.default;var t={url:e,method:"GET",responseType:this._streamingDownload?"moz-chunked-arraybuffer":"arraybuffer",tag:this.TAG},r={timeout:this._timeout,maxRetry:0,retryDelay:300,maxRetryDelay:1e3,stream:!0},n={onSuccess:this.loadEnd.bind(this),onError:this.loadError.bind(this),onTimeout:this.loadTimeout.bind(this),onProgress:this.loadProgress.bind(this),onHeadLoaded:this.loadSuccess.bind(this),onLoadError:this.loaderError.bind(this)};this.loader.load(t,r,n)}},{key:"loadSuccess",value:function(){this.onHttpReport(o.HttpReportType.CODE_200)}},{key:"loadError",value:function(e){var t=e.code;404===t?this.onHttpReport(o.HttpReportType.CODE_404):403===t&&this.onHttpReport(o.HttpReportType.CODE_403)}},{key:"loadTimeout",value:function(){this.onHttpReport(o.HttpReportType.TIMEOUT)}},{key:"loadProgress",value:function(e){this._abort||this._streamingDownload&&this.onLoadBuffer(new Uint8Array(e))}},{key:"loaderError",value:function(){this.onHttpReport(o.HttpReportType.NETWORK_ERROR)}},{key:"loadEnd",value:function(e){this._streamingDownload||this.onLoadBuffer(new Uint8Array(e.data)),this.onHttpReport(o.HttpReportType.DONE)}}]),e}();r.default=s},{32:32,93:93}],51:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=(n=e(80))&&n.__esModule?n:{default:n},o="idle",s=function(){function e(t,r){var n=r.liveDelay,i=r.p2pWindow,a=r.enableSpeedUp,s=r.accelerationRate,l=r.videoProxy,c=r.targetBufferLen,u=r.delayCheckInterval;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="PlaybackRateController",this.stateMgr=t.stateMgr,this.enableSpeedUp=a,this.accelerationRate=s||1.05,this.delayCheckInterval=u||15e3,this.videoProxy=l,this.liveDelay=n,this.p2pWindow=i,this.targetBufferLen=c,this._state=o,this._clearTimer=null,this._loopTimer=null}return i(e,[{key:"destroy",value:function(){this.onStopping()}},{key:"onStarting",value:function(){this.onStopping(),this._loopTimer=setInterval(this.loop.bind(this),this.delayCheckInterval)}},{key:"onStopping",value:function(){this._loopTimer&&(clearInterval(this._loopTimer),this._loopTimer=null),this._clearTimer&&(clearTimeout(this._clearTimer),this._clearTimer=null)}},{key:"loop",value:function(){var e=this.check();if(this.enableSpeedUp)if(e)switch(this._state){case o:this.speedUp(e,this.accelerationRate);break;case"accelerating":this.clear(),this.speedUp(e,this.accelerationRate)}else this.clear()}},{key:"check",value:function(){var e=this.stateMgr.realDelay-this.liveDelay,t=this.liveDelay-this.p2pWindow;if(0<e&&this.bufferLength>t){var r=1e3*e;return r<1e3?0:0<r&&1!==this.accelerationRate?Math.floor(r/(this.accelerationRate-1)):0}}},{key:"speedUp",value:function(e){var t=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1.05;this.videoProxy.playbackRate=r,this._state="accelerating",this._clearTimer=setTimeout(function(){t.clear()},e)}},{key:"clear",value:function(){this.videoProxy.playbackRate=1,clearTimeout(this._clearTimer),this._state=o}},{key:"bufferLength",get:function(){var e=this.videoProxy.video;if(!e)return 0;var t=e.currentTime;return a.default.bufferInfo(e,t,0).len}}]),e}();r.default=s},{80:80}],52:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=e(77),a=e(17),o=u(e(19)),s=e(86),l=u(e(51)),c=u(e(39));function u(e){return e&&e.__esModule?e:{default:e}}function d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var p=function(){function e(t,r){!function(t,r){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this),this.TAG="VideoManager",this.initiator=t,this.tp2p=r,this.videoProxy=t.videoProxy,this.stateMgr=t.stateMgr,this.videoProxy.on("waiting",this.onWaiting.bind(this)),this.videoProxy.on("canplay",this.onCanplay.bind(this)),this.videoProxy.on("loadeddata",this.onLoadedData.bind(this)),this.videoProxy.on("loadedmetadata",this.onLoadedMetadata.bind(this)),this.setMonitor(),this._skipping=!1,this._initReporterData(),this.tp2p.registerReportCallback(this.TAG,this.reportCallback.bind(this))}return n(e,[{key:"destroy",value:function(){this.playpackRateController&&this.playpackRateController.destroy(),this.onStopping()}},{key:"onStarting",value:function(){var e=this.tp2p.config;this.playpackRateController=new l.default(this.initiator,{liveDelay:e.pcdnLiveDelay,p2pWindow:e.p2pWindow,enableSpeedUp:e.enableSpeedUp,accelerationRate:e.accelerationRate,videoProxy:this.videoProxy,targetBufferLen:e.targetBufferLen,delayCheckInterval:e.delayCheckInterval}),this.playpackRateController.onStarting()}},{key:"onStopping",value:function(){this._stuckCheckTimer&&(clearInterval(this._stuckCheckTimer),this._stuckCheckTimer=void 0),this._monitorStartTimer&&(clearTimeout(this._monitorStartTimer),this._monitorStartTimer=void 0),this.playpackRateController&&this.playpackRateController.onStopping()}},{key:"setMonitor",value:function(){this._monitorStartTimer=setTimeout(this._playStartMonitor.bind(this),this.tp2p.config.playStartTimeout)}},{key:"_playStartMonitor",value:function(){this.stateMgr.playStart||(this.tp2p.media||s.logger.warn("没有检测到 media"),this.stateMgr.playStart||s.logger.warn("media没有足够数据"),this.tp2p.trigger(o.default.ERROR,{fatal:!0,rollbackCode:i.ReportCode.ROLLBACK,extendReportData:d({},i.ReportField.ROLLBACK_REASON,i.ReportField.ROLLBACK_EMPTY_BUFFER)}))}},{key:"onWaiting",value:function(){this.videoProxy.ended||this.videoProxy.seeking||(this.stateMgr.stuck=!0,this._newStatistics(),this._preStatistics())}},{key:"_newStatistics",value:function(){var e=this.stateMgr,t=e.loadingMain,r=e.playId,n=e.confirmLossSkipSliceId,a=e.frameRate;this._reportData[i.ReportField.STUCK_TOTAL]++,this._reportData[i.ReportField["STUCK_FROM_"+(t?"MAIN":"SUB")]]++;var o=Math.round(1e3*this.tp2p.bufferLength)/1e3;this._reportData[i.ReportField.STUCK_FIRST_BUFFER_LEN].length||(this._reportData[i.ReportField.STUCK_FIRST_BUFFER_LEN]=o),this._reportData[i.ReportField.STUCK_ALL_BUFFER_LEN]+="-"+o,Math.abs(r-n)<=a&&this._reportData[i.ReportField.STUCK_FROM_CL]++}},{key:"_preStatistics",value:function(){this._stallTime=Date.now();var e=this.tp2p.bufferLength,t=this.tp2p.config;e>t.stuckThreshold&&(this._reportData[i.ReportField.PLAY_STUCK_TIRED]+=1);var r=Date.now()-t.loadTime,n=r.toFixed(2);if(r<t.initStuckThreshold&&(this._reportData[i.ReportField.PLAY_STUCK_INIT]+=1,this._stuckInitTime.push(n)),r<t.mainStuckThreshold&&(this._reportData[i.ReportField.PLAY_STUCK_MAIN]+=1,this._stuckMainTime.push(n)),this._reportData[i.ReportField.PLAY_STUCK_SHORT]+=1,this._stuckCheckTimer||(this._stuckCheckTimer=setInterval(this._processStuck.bind(this),1e3)),this._reportData[i.ReportField.PLAY_STUCK_SHORT]<4){for(var a="",o="",s=0;s<this.initiator.pcdnStreams;s++)a+="-"+this.stateMgr.getMaxSubStreamId(s),o+=this.stateMgr.getSubStreamState(s);this._reportData[i.ReportField.STUCK_ID_PCDN]+=this.stateMgr.nextWriteId+"_"+e.toFixed(2)+"_"+a+"_"+o+", "}}},{key:"_processStuck",value:function(){var e=void 0;if(void 0!==this._stallTime){e=Date.now()-this._stallTime;var t=this.tp2p.config,r=t.stuckCauseSkip,n=t.stuckCauseRollback,a=t.stuckCauseReload,s=t.enableStuckReload,l=t.originalUrl,u=t.enableRollbackOther,d=t.rollbackWhileList;if(a<=e)this._reload();else{if(!(n<=e))return!this._skipping&&r<=e?(this._skipping=!0,this._reportData[i.ReportField.PLAY_SKIP]+=1,void this.tp2p.trigger(o.default.WRITE_SKIP,{retry:!0})):void 0;s?u&&c.default.DomainStuckRollback(l,d)&&this._rollback(2):this._rollback(1)}}}},{key:"_reload",value:function(){this._cleanTimer(),this._reportData[i.ReportField.STUCK_TRIGGER_RELOAD_COUNT]+=1,this.tp2p.trigger(o.default.STUCK_RELOAD)}},{key:"_rollback",value:function(e){var t;this._cleanTimer(),this._reportData[i.ReportField.ROLLBACK_STUCK_CODE]=e,this.tp2p.trigger(o.default.ERROR,{fatal:!0,type:a.ErrorTypes.NETWORK_ERROR,details:a.ErrorDetails.STUCK_ROLLBACK,rollbackCode:i.ReportCode.ROLLBACK,extendReportData:(t={},d(t,i.ReportField.ROLLBACK_REASON,i.ReportField.ROLLBACK_STUCK),d(t,i.ReportField.ROLLBACK_STUCK_CODE,e),t)})}},{key:"onCanplay",value:function(){if(this._stallTime&&!this.videoProxy.ended&&!this.videoProxy.seeking){this._cleanTimer(),this.stateMgr.stuck=!1;var t=Date.now()-this._stallTime;this._stallTime=void 0,this._skipping=!1,this.stateMgr.playSkipSucc&&(this._reportData[i.ReportField.PLAY_SKIP_SUCC]+=1,this.stateMgr.playSkipSucc=!1),this.stateMgr.reloadingMain=!1,e.IsNumeric(t)&&(this._reportData[i.ReportField.STUCK_DURATION]+=t)}}},{key:"onLoadedData",value:function(){this._reportData[i.ReportField.LOADEDDATA_TIME]=Date.now()-this.tp2p.config.loadTime}},{key:"onLoadedMetadata",value:function(){this._reportData[i.ReportField.METADATA_TIME]=Date.now()-this.tp2p.config.loadTime}},{key:"_cleanTimer",value:function(){this._stuckCheckTimer&&(clearInterval(this._stuckCheckTimer),this._stuckCheckTimer=void 0)}},{key:"reportCallback",value:function(){var e=this._reportData;return e[i.ReportField.PLAY_DELAY]=this.stateMgr.realDelay,e[i.ReportField.BUFFER_LENGTH]=parseInt(this.tp2p.bufferLength),e[i.ReportField.STUCK_COUNT]=e[i.ReportField.PLAY_STUCK_SHORT],e[i.ReportField.STUCK_ALL_BUFFER_LEN]&&(e[i.ReportField.STUCK_ALL_BUFFER_LEN]=e[i.ReportField.STUCK_ALL_BUFFER_LEN].slice(1)),e[i.ReportField.INIT_STUCK_TIME]=this._stuckInitTime.join("-"),e[i.ReportField.MAIN_STUCK_TIME]=this._stuckMainTime.join("-"),Object.keys(e).forEach(function(t){-1===[i.ReportField.BUFFER_LENGTH,i.ReportField.PLAY_DELAY,i.ReportField.STUCK_COUNT].indexOf(t)&&(e[t]||delete e[t])}),this._initReporterData(),e}},{key:"_initReporterData",value:function(){this._stuckMainTime=[],this._stuckInitTime=[],this._reportData={};var e=this._reportData;e[i.ReportField.PLAY_STUCK_SHORT]=0,e[i.ReportField.STUCK_COUNT]=0,e[i.ReportField.BUFFER_LENGTH]=0,e[i.ReportField.STUCK_DURATION]=0,e[i.ReportField.PLAY_STUCK_TIRED]=0,e[i.ReportField.PLAY_SKIP]=0,e[i.ReportField.PLAY_SKIP_SUCC]=0,e[i.ReportField.METADATA_TIME]=0,e[i.ReportField.LOADEDDATA_TIME]=0,e[i.ReportField.STUCK_ID_PCDN]="",e[i.ReportField.PLAY_STUCK_INIT]=0,e[i.ReportField.PLAY_STUCK_MAIN]=0,e[i.ReportField.PLAY_DELAY]=0,e[i.ReportField.STUCK_TRIGGER_RELOAD_COUNT]=0,e[i.ReportField.STUCK_TOTAL]=0,e[i.ReportField.STUCK_FROM_MAIN]=0,e[i.ReportField.STUCK_FROM_SUB]=0,e[i.ReportField.STUCK_FROM_CL]=0,e[i.ReportField.STUCK_FIRST_BUFFER_LEN]=0,e[i.ReportField.STUCK_ALL_BUFFER_LEN]="",e[i.ReportField.INIT_STUCK_TIME]="",e[i.ReportField.MAIN_STUCK_TIME]=""}}],[{key:"IsNumeric",value:function(e){return!isNaN(parseFloat(e))&&isFinite(e)}}]),e}();r.default=p},{17:17,19:19,39:39,51:51,77:77,86:86}],53:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=(n=e(6))&&n.__esModule?n:{default:n},o=function(e){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="VideoProxy",e._videoElement=void 0,e._listenEvent=["waiting","canplay","loadedmetadata","loadeddata"],e._handler=new Map,e._genHandler(),e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),i(t,[{key:"destroy",value:function(){this._videoElement&&(this.releaseVideoElement(),this._videoElement=null)}},{key:"setVideoByElement",value:function(e){this._videoElement&&this.releaseVideoElement(),this._videoElement=e,this.attachVideoElement()}},{key:"setVideoById",value:function(e){var t=document.getElementById(e);this.setVideoByElement(t)}},{key:"attachVideoElement",value:function(){var e=this;this._handler.forEach(function(t,r){e._videoElement.addEventListener(r,t)})}},{key:"releaseVideoElement",value:function(){var e=this;this._handler.forEach(function(t,r){e._videoElement.removeEventListener(r,t)})}},{key:"onWaiting",value:function(){this.emit("waiting")}},{key:"onCanplay",value:function(){this.emit("canplay")}},{key:"onLoadedmetadata",value:function(){this.emit("loadedmetadata")}},{key:"onLoadeddata",value:function(){this.emit("loadeddata")}},{key:"_transEventToFunc",value:function(e){if(!e)throw new TypeError("Video-Proxy: param event must be a non-empty string");if(e.length<4)throw new Error("Video-Proxy: no such event");return"on"+e[0].toUpperCase()+e.slice(1)}},{key:"_genHandler",value:function(){var e=this;this._listenEvent.forEach(function(t){var r=e._transEventToFunc(t);if(!e[r])throw new Error("Video-Proxy: no such function");e._handler.set(t,e[r].bind(e))})}},{key:"currentTime",get:function(){return this._videoElement.currentTime}},{key:"seeking",get:function(){return this._videoElement.seeking}},{key:"ended",get:function(){return this._videoElement.ended}},{key:"video",get:function(){return this._videoElement}},{key:"buffered",get:function(){return this._videoElement.buffered}},{key:"playbackRate",set:function(e){this._videoElement.playbackRate=e},get:function(){return this._videoElement.playbackRate}}]),t}();r.default=o},{6:6}],54:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.Uri={PING:1,PONG:2,AV:3,SUB:4,TREE:5,P2P_FILL_REQ:6,P2P_FILL_RES:7},r.PeerConnectionState={FAIL:"fail",OPEN:"open",ICE:"ice",ERROR:"error",REPORT:"report"},r.SubscribeEvent={SUBSCRIBE:1,SUBSCRIBE_SUCC:2,SUBSCRIBE_FAIL:3,UNSUBSCRIBE:4,SUBSCRIBE_TREE:5},r.PieceUsage={NORMAL:0,FILL:1,PUSH:2}},{}],55:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="DatachannelManager",this.subs=new Map,this.allPeers=new Map}return n(e,[{key:"destroy",value:function(){this.subs=null}},{key:"addPeer",value:function(e,t){this.allPeers.set(e,t)}},{key:"deletePeer",value:function(e){this.allPeers.delete(e)}},{key:"sendToPeer",value:function(e,t,r){var n=this,i=this.allPeers.get(e);i&&setTimeout(function(){r&&(t=n._updateSeq(i,t)),i.send(t)},0)}},{key:"addSub",value:function(e,t){this.subs.set(e,t)}},{key:"deleteSub",value:function(e){this.subs.delete(e)}},{key:"sendToAllSub",value:function(e){var t=this;this.subs.forEach(function(r,n){setTimeout(function(){e=t._updateSeq(r,e),r.send(e)})})}},{key:"_updateSeq",value:function(e,t){if(e){var r=e.seq||0;t instanceof Array&&(t.forEach(function(e){new DataView(e).setUint32(1,r++)}),e.seq=r)}return t}},{key:"peerSize",get:function(){return this.allPeers.size}},{key:"subsSize",get:function(){return this.subs.size}}]),e}();r.default=i},{}],56:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=d(e(69)),a=d(e(70)),o=d(e(19)),s=d(e(18)),c=e(77),u=e(54);function d(e){return e&&e.__esModule?e:{default:e}}var p=function(e){function t(e,r,n,i,a){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var s=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r,o.default.TRY_P2P_FILL,o.default.P2P_FILL_RES,o.default.P2P_FILL_REQ,o.default.P2P_FILL_SUCCESS,o.default.SUBSCRIBE_FILL));return s.TAG="FillManager",s.storage=e.storage,s.stateMgr=e.stateMgr,s.dataChannelManager=n,s.sliceManager=i,s.peerManager=a,s.baseSub=e.pcdnStreams,s._initReporterData(),s.tp2p.registerReportCallback(s.TAG,s.reportCallback.bind(s)),s}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s.default),n(t,[{key:"destroy",value:function(){this._pushSubTimer&&clearInterval(this._pushSubTimer),s.default.prototype.destroy.call(this),this.tp2p=null}},{key:"onTryP2pFill",value:function(e){var t=e.missing;this._reportData[c.ReportField.FILL_TRY_P]+=t.length;var r=void 0,n=void 0;if(this.dataChannelManager.peerSize){var i=this.groupPeers(),a=this.assignPeer(t,i);r=a.p2pMissing,n=a.fillMapping;var s=this.generateReq(n);this._reportData[c.ReportField.FILL_REQ_P]+=s.length,this._reportData[c.ReportField.FILL_MISS_P]+=r.length,this.send(s)}else r=t,this._reportData[c.ReportField.FILL_NO_PEER_MISS]+=t.length;this.tp2p.trigger(o.default.P2P_FILL_FRAGMENT_FAIL,{failReason:"missing",sliceArray:r})}},{key:"onSubscribeFill",value:function(e){var t=this,r=e.from,n=e.startSliceId;if(this.tp2p.config.enableSubFill&&(this._pushQueue||(this._pushQueue=[]),n)){for(var i=this.stateMgr.maxXSubStreamId,a=n;a<=i;a+=this.baseSub)this.storage.has(a)?this._pushQueue.push({peerId:r,sliceId:a}):this._reportData[c.ReportField.PUSH_MISS]+=1;this._pushSubTimer||(this._pushSubTimer=setInterval(function(){var e=Math.min(t._pushQueue.length,5);if(e)for(var r=0;r<e;r++){t._reportData[c.ReportField.PUSH_REQ]+=1;var n=t._pushQueue.shift();t.sendRes(n.peerId,n.sliceId,u.PieceUsage.PUSH)}},100))}}},{key:"groupPeers",value:function(){var e=[];this.peerManager.forEach(function(t,r){if(t){var n=t.getPeerInfo();n.sort(function(e,t){return e.rtt-t.rtt}),e[r]=n}});for(var t=e.length,r=0;r<t;r++)e[r]||(e[r]=[]);return e}},{key:"assignPeer",value:function(e,t){var r=this,n=[],i=[],a=[],o=!1;if(e.forEach(function(e){var a=e%r.baseSub,s=t[a];if(o=!1,s&&s.length){var l=!0,c=!1,u=void 0;try{for(var d,p=s[Symbol.iterator]();!(l=(d=p.next()).done);l=!0){var f=d.value;if(e>f.remoteMinSliceId&&e<f.remoteMaxSubId){n.push({peerId:f.peerId,sliceId:e}),o=!0;break}}}catch(e){c=!0,u=e}finally{try{!l&&p.return&&p.return()}finally{if(c)throw u}}}o||i.push(e)}),i.length){var s=[].concat.apply([],t);s.sort(function(e,t){return e.score-t.score});for(var l=i.length,c=void 0,u=0;u<l;u++){c=i[u];var d=!(o=!1),p=!1,f=void 0;try{for(var h,_=s[Symbol.iterator]();!(d=(h=_.next()).done);d=!0){var v=h.value;if(c>v.remoteMinSliceId&&c<v.remoteMaxContinuousId){n.push({peerId:v.peerId,sliceId:c}),o=!0;break}}}catch(e){p=!0,f=e}finally{try{!d&&_.return&&_.return()}finally{if(p)throw f}}o||a.push(c)}}return{p2pMissing:a,fillMapping:n}}},{key:"generateReq",value:function(e){var t=[];return e.forEach(function(e){var r=new i.default;r.fillSliceId=e.sliceId,t.push({peerId:e.peerId,data:r.encode()})}),t}},{key:"onP2pFillReq",value:function(e){var t=e.remotePeerId,r=e.pkt,n=new i.default;n.decode(r);var a=n.fillSliceId;this.sendRes(t,a,u.PieceUsage.FILL)}},{key:"sendRes",value:function(e,t,r){if(this.storage.has(t)){var n=this.storage.get(t);r===u.PieceUsage.FILL?this._reportData[c.ReportField.FILL_P_S_BYTES]+=n.payload.length:this._reportData[c.ReportField.PUSH_S_BYTES]+=n.payload.length,this.sliceManager.receiveFillSlice(e,t,n.payload,n.tagTime,r)}else{if(r===u.PieceUsage.PUSH)return void(this._reportData[c.ReportField.PUSH_MISS]+=1);var i=this.generateEmptyRes(t);this.dataChannelManager.sendToPeer(e,i,!1)}}},{key:"generateEmptyRes",value:function(e){var t=new a.default;return t.fillSliceId=e,t.findSlice=0,t.encode()}},{key:"onP2pFillRes",value:function(e){e.remotePeerId;var t=e.pkt,r=new a.default;r.decode(t),r.findSlice||(this._reportData[c.ReportField.FILL_EMPTY_P]+=1,this.tp2p.trigger(o.default.P2P_FILL_FRAGMENT_FAIL,{failReason:"notFound",sliceArray:[r.fillSliceId]}))}},{key:"onP2pFillSuccess",value:function(e){var t=e.sliceId,r=e.length,n=e.usage;n===u.PieceUsage.FILL?(this._reportData[c.ReportField.FILL_OK_P]+=1,this._reportData[c.ReportField.FILL_P_U_BYTES]+=r,this.tp2p.trigger(o.default.P2P_FILL_FRAGMENT_SUCCESS,{sliceArray:[t]})):n===u.PieceUsage.PUSH&&(this._reportData[c.ReportField.PUSH_OK]+=1,this._reportData[c.ReportField.PUSH_U_BYTES]+=r)}},{key:"send",value:function(e){var t=this;e.forEach(function(e){t.dataChannelManager.sendToPeer(e.peerId,e.data,!1)})}},{key:"_initReporterData",value:function(){this._reportData={};var e=this._reportData;e[c.ReportField.FILL_TRY_P]=0,e[c.ReportField.FILL_NO_PEER_MISS]=0,e[c.ReportField.FILL_REQ_P]=0,e[c.ReportField.FILL_OK_P]=0,e[c.ReportField.FILL_MISS_P]=0,e[c.ReportField.FILL_EMPTY_P]=0,e[c.ReportField.FILL_P_S_BYTES]=0,e[c.ReportField.FILL_P_U_BYTES]=0,e[c.ReportField.PUSH_REQ]=0,e[c.ReportField.PUSH_OK]=0,e[c.ReportField.PUSH_MISS]=0,e[c.ReportField.PUSH_S_BYTES]=0,e[c.ReportField.PUSH_U_BYTES]=0}},{key:"reportCallback",value:function(){var e=this._reportData;for(var t in e)e[t]||delete e[t];return this._initReporterData(),e}}]),t}();r.default=p},{18:18,19:19,54:54,69:69,70:70,77:77}],57:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=e(54),a=s(e(66)),o=s(e(67));function s(e){return e&&e.__esModule?e:{default:e}}var l=function(){function e(t,r,n,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="Heartbeat",this.pc=r,this.peerInfo=n,this.stateMgr=i,this.dataChannelOpen=!1,this._lastSyncTime=Date.now(),this._heartTimeout=t.PCHeartTimeout,this._keepTimeout=t.PCKeepTimeout,this._timeBase=Date.now(),this._onCheckTimer=setInterval(this.onCheck.bind(this),1e3)}return n(e,[{key:"destroy",value:function(){this._clearTimer()}},{key:"_clearTimer",value:function(){this._onCheckTimer&&(clearInterval(this._onCheckTimer),this._onCheckTimer=null)}},{key:"start",value:function(){this.dataChannelOpen=!0}},{key:"onCheck",value:function(){var e=Date.now()-this._lastSyncTime,t="initHeartTimeout";this.dataChannelOpen&&(t="heartTimeout"),("initHeartTimeout"===t?this._heartTimeout:this._keepTimeout)<e?this.pc.callbacks.onPeerConnectionState({remoteId:this.pc.remoteId,type:i.PeerConnectionState.FAIL,reason:t}):this.dataChannelOpen&&this.sendPing()}},{key:"sendPing",value:function(){var e=new a.default;e.lastSliceId=this.stateMgr.maxXSubStreamId,e.minSliceId=this.stateMgr.minSliceId,e.maxContinuousId=this.stateMgr.maxContinuousId,e.sendTime=Date.now()-this._timeBase,this.pc.send(e.encode())}},{key:"receivePing",value:function(e){this._lastSyncTime=Date.now();var t=new a.default;t.decode(e),this.peerInfo.sampleRemoteId({lastSliceId:t.lastSliceId,minSliceId:t.minSliceId,maxContinuousId:t.maxContinuousId}),this.sendPong(t.sendTime)}},{key:"sendPong",value:function(e){var t=new o.default;t.lastSliceId=this.stateMgr.maxXSubStreamId,t.minSliceId=this.stateMgr.minSliceId,t.maxContinuousId=this.stateMgr.maxContinuousId,t.lastPingTime=e,this.pc.send(t.encode())}},{key:"receivePong",value:function(e){this._lastSyncTime=Date.now();var t=new o.default;t.decode(e);var r=Date.now()-this._timeBase-t.lastPingTime;this.peerInfo.sampleRtt(r),this.peerInfo.sampleRemoteId({lastSliceId:t.lastSliceId,minSliceId:t.minSliceId,maxContinuousId:t.maxContinuousId})}}]),e}();r.default=l},{54:54,66:66,67:67}],58:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=v(e(55)),a=v(e(72)),o=v(e(62)),s=v(e(24)),c=v(e(19)),u=v(e(18)),d=v(e(15)),p=v(e(14)),f=v(e(59)),h=v(e(56)),_=e(77);function v(e){return e&&e.__esModule?e:{default:e}}var m=function(e){function t(e,r){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r,c.default.SIGNAL_RECEIVING,c.default.CDN_LOADED,c.default.P2P_LOADED,c.default.P2P_STARTING,c.default.P2P_STOPPING,c.default.CHANGE_PEER));n.TAG="P2PController",n._xStreamId=e.xStreamId,n.streams=e.pcdnStreams,n._localStreamShare=r.config.localStreamShare,n._maxSubLevel=r.config.maxSubLevel,n.trackerLoader=new d.default(r),n.trackerController=new p.default(r),n.signalClient=new s.default(r),n.dataChannelManager=new i.default,n.p2pMonitor=new f.default(e,r),n.sliceManager=new a.default(e,r,n.dataChannelManager,n.p2pMonitor),n.peerManager=[];for(var u=0;u<n.streams;u++)(n._localStreamShare||u!==n._xStreamId)&&(n.peerManager[u]=new o.default(e,r,n.dataChannelManager,n.sliceManager,n.p2pMonitor,{managerStreamId:u}));return n.fillManager=new h.default(e,r,n.dataChannelManager,n.sliceManager,n.peerManager),n.tp2p.registerReportCallback(n.TAG,n.reportCallback.bind(n)),n._initReporterData(),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,u.default),n(t,[{key:"onSignalReceiving",value:function(e){var t=e.streamId;this.peerManager[t]&&this.peerManager[t].receiveSignal(e)}},{key:"onCdnLoaded",value:function(e){this.sliceManager.receiveSlice(e.sliceId,e.payload,e.tagTime)}},{key:"onP2pLoaded",value:function(e){var t=e.sliceId,r=e.payload,n=e.tagTime;this._localStreamShare&&t%this.streams===this._xStreamId&&(this.sliceManager.receiveSlice(t,r,n),this._reportData[_.ReportField.P2P_FROM_SHARE_BYTES]+=r.byteLength)}},{key:"onChangePeer",value:function(e){var t=e.subStreamId,r=this.peerManager[t];r&&r.changePeer()}},{key:"onP2pStarting",value:function(){this._reportData[_.ReportField.START_P2P]+=1,this.tp2p.trigger(c.default.TRACKER_STARTING),this.peerManager.forEach(function(e){e&&e.onStarting()})}},{key:"onP2pStopping",value:function(){this._reportData[_.ReportField.STOPPING_P2P]+=1,this.tp2p.trigger(c.default.TRACKER_STOPPING),this.peerManager.forEach(function(e){e&&e.onStopping()})}},{key:"destroy",value:function(){this.fillManager.destroy(),this.sliceManager.destroy(),this.p2pMonitor.destroy(),this.trackerLoader.destroy(),this.trackerController.destroy(),this.signalClient.destroy(),this.peerManager.forEach(function(e){e.destroy()}),this.dataChannelManager.destroy()}},{key:"onStopping",value:function(){this.p2pMonitor.onStopping(),this.trackerController.onTrackerStopping(),this.peerManager.forEach(function(e){e&&e.onStopping()})}},{key:"onStarting",value:function(){}},{key:"_initReporterData",value:function(){this._reportData={};var e=this._reportData;e[_.ReportField.MY_STREAM_ID]=this.tp2p.initiator.xStreamId,e[_.ReportField.P2P_FROM_SHARE_BYTES]=0,e[_.ReportField.LOCAL_STREAM_SHARE]=this._localStreamShare?1:0,e[_.ReportField.SUB_TREE_LEVEL]=this._maxSubLevel,e[_.ReportField.STUN_IP]=this.tp2p.config.stunServer,e[_.ReportField.STOPPING_P2P]=0,e[_.ReportField.START_P2P]=0}},{key:"reportCallback",value:function(){this.collectReportData();var e=this._reportData;return this._initReporterData(),e}},{key:"collectReportData",value:function(){for(var e=0;e<this.streams;e++)if(this._localStreamShare||e!==this._xStreamId){var t=this.peerManager[e].reportData;this._combineData(t,e)}}},{key:"_combineData",value:function(e,t){var r=this;Object.keys(e).forEach(function(n){if(n===_.ReportField.PEER_NUM)return r._addReport(_.ReportField.CONNECTED,e[n]),void r._addObjectReport(_.ReportField.PEER_NUM,t,e[n]);r._addReport(n,e[n])})}},{key:"_addReport",value:function(e,t){var r="[object Object]"==={}.toString.call(t);if(this._reportData[e]||(this._reportData[e]=r?{}:0),r){var n=this._reportData[e];Object.keys(t).forEach(function(e){n[e]=(n[e]||0)+t[e]})}else this._reportData[e]+=t}},{key:"_addObjectReport",value:function(e,t,r){this._reportData[e]||(this._reportData[e]={});var n="stream"+t;this._reportData[e][n]=r}}]),t}();r.default=m},{14:14,15:15,18:18,19:19,24:24,55:55,56:56,59:59,62:62,72:72,77:77}],59:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=e(77),a=c(e(71)),o=e(32),s=c(e(87)),l=c(e(19));function c(e){return e&&e.__esModule?e:{default:e}}var u=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="P2PMonitor",this.initiator=t,this.tp2p=r,this.config=r.config,this.stateMgr=t.stateMgr,this.switchController=t.switchController,this.localStreamShare=r.config.localStreamShare,this.xStreamId=t.xStreamId,this.baseSub=t.pcdnStreams,this.subUpdateTime={},this.subSampleCount={},this.openSample=!1,this.ratioCalcu={},this._plr=[],this._initReporterData(),this.tp2p.registerReportCallback(this.TAG,this.reportCallback.bind(this)),this.onStarting()}return n(e,[{key:"_init",value:function(){for(var e=0;e<this.baseSub;e++)if(this.localStreamShare||e!==this.xStreamId){this.subUpdateTime[e]=Date.now()+1e4,this.subSampleCount[e]=0;var t={sampleDuration:this.config.sampleDuration,frameRate:this.stateMgr.frameRate,pcdnStreams:this.config.pcdnStreams};this.ratioCalcu[e]=new a.default(t),this.config.plrEnable&&(this._plr[e]=new s.default({threshold:t.plrThreshold,cacheLength:t.plrCacheLength,checkDelay:t.plrCheckDelay}))}}},{key:"resetStatistics",value:function(e){this._resetP2PAvailableRatio(e),this._plr[e]&&this._plr[e].reset()}},{key:"onStarting",value:function(){var e=this;this._init(),this._sampleTimer=setInterval(function(){e.openSample=!0,e._judgeTimer=setTimeout(e.start.bind(e),2e3)},3e3)}},{key:"onStopping",value:function(){this._judgeTimer&&(clearTimeout(this._judgeTimer),this._judgeTimer=null),this._sampleTimer&&(clearInterval(this._sampleTimer),this._sampleTimer=null)}},{key:"destroy",value:function(){this.onStopping(),this.openSample=!1,this.initiator=null,this.tp2p=null}},{key:"sample",value:function(e,t){var r=e%this.baseSub;this.ratioCalcu[r].sample(t),this.openSample&&(this.tp2p.config.sampleUsefulJudge&&!t||(this.subSampleCount[r]+=1,this.subUpdateTime[r]=Date.now()))}},{key:"plrSample",value:function(e,t){var r=e%this.baseSub,n=this._plr[r];n&&(n.calculate(t)>=this.config.plrThreshold&&(this._reportData[i.ReportField.SUB_TRY_PLR]++,this.tp2p.trigger(l.default.CHANGE_PEER,{subStreamId:r})))}},{key:"start",value:function(){this.openSample=!1;for(var e=0;e<this.baseSub;e++)(this.localStreamShare||e!==this.xStreamId)&&this.judge(e)}},{key:"judge",value:function(e){var t=Date.now()-this.subUpdateTime[e]<this.config.judgeAliveDelay&&this.subSampleCount[e]>this.config.judgeAliveCount,r=this.stateMgr.getSubStreamState(e);r!==o.SubLoadingState.LOADING_MAIN&&(t&&r===o.SubLoadingState.LOADING?(this.switchController.stopSubStream(e),this._reportData[i.ReportField.P2P_DIS_SUB]+=1):t||r!==o.SubLoadingState.IDLE||(this.switchController.loadSubStream(e),this._reportData[i.ReportField.P2P_EN_SUB]+=1),this.clear(e))}},{key:"clear",value:function(e){this.subSampleCount[e]=0}},{key:"subUseful",value:function(e){return this.ratioCalcu[e].ratio>this.config.p2pUsefulRatio}},{key:"_resetP2PAvailableRatio",value:function(e){var t={sampleDuration:this.config.sampleDuration,frameRate:this.stateMgr.frameRate,pcdnStreams:this.config.pcdnStreams};this.ratioCalcu[e]=new a.default(t)}},{key:"_initReporterData",value:function(){this._reportData={};var e=this._reportData;e[i.ReportField.P2P_DIS_SUB]=0,e[i.ReportField.P2P_EN_SUB]=0,e[i.ReportField.SUB_TRY_PLR]=0}},{key:"reportCallback",value:function(){var e=this._reportData;return this._initReporterData(),e}}]),e}();r.default=u},{19:19,32:32,71:71,77:77,87:87}],60:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=u(e(29)),a=e(54),o=e(27),s=u(e(57)),l=u(e(61)),c=u(e(19));function u(e){return e&&e.__esModule?e:{default:e}}var d=function(){function e(t,r,n,a,o){!function(t,r){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this),this.TAG="PeerConnection",this.localId=a.localId,this.remoteId=a.remoteId,this.callbacks=o,this.streamId=t.xStreamId,this.sliceManager=n;var c,u,d=(this.tp2p=r).config;c={localId:this.localId,remoteId:this.remoteId,ice:{iceServers:[{urls:"stun:"+d.stunServer}]},bufferedAmountLimit:d.bufferedAmountLimit,enableDCClosing:d.enableDCClosing},u={onMessage:this.onMessage.bind(this),onStateChange:this.onStateChange.bind(this),onSendBySignalChannel:this.onSendBySignalChannel.bind(this)},this.webrtcPeerConnection=new i.default(c,u),this.peerInfo=new l.default(t.stateMgr),this.heartbeat=new s.default({PCHeartTimeout:d.PCHeartTimeout,PCKeepTimeout:d.PCKeepTimeout},this,this.peerInfo,t.stateMgr)}return n(e,[{key:"destroy",value:function(){this.webrtcPeerConnection.destroy(),this.peerInfo.destroy(),this.heartbeat.destroy(),this.webrtcPeerConnection=null}},{key:"onStateChange",value:function(e){var t=e.context;if("peerConnection"===t)"IceConnectionState"===e.type&&this.callbacks.onPeerConnectionState({type:a.PeerConnectionState.ICE,state:e.state});else if("dataChannel"===t)switch(e.state){case o.DataChannelState.REPORT:this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:a.PeerConnectionState.REPORT,reason:"report",originData:e.originData});break;case o.DataChannelState.CLOSE:this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:a.PeerConnectionState.FAIL,reason:"dataChannelClose"});break;case o.DataChannelState.ERROR:this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:a.PeerConnectionState.FAIL,reason:"dataChannelError"});break;case o.DataChannelState.OPEN:this.callbacks.onPeerConnectionState({remoteId:this.remoteId,type:a.PeerConnectionState.OPEN,reason:"dataChannelOpen"}),this.heartbeat.start()}}},{key:"receiveSignal",value:function(e){switch(e.type){case o.SignalType.ANSWER:this.webrtcPeerConnection.receiveSignal({type:o.SignalType.ANSWER,msg:e.payload});break;case o.SignalType.OFFER:this.webrtcPeerConnection.receiveSignal({type:o.SignalType.OFFER,msg:e.payload});break;case o.SignalType.ICE_CANDIDATE:this.webrtcPeerConnection.receiveSignal({type:o.SignalType.ICE_CANDIDATE,msg:e.payload});break;default:this.webrtcPeerConnection.receiveSignal({type:o.SignalType.JUST_START})}}},{key:"onSendBySignalChannel",value:function(e){var t=void 0;switch(e.type){case o.SignalType.OFFER:t={from:this.localId,to:this.remoteId,streamId:this.streamId,type:o.SignalType.OFFER,payload:e.msg},this._sendBySignaling(t);break;case o.SignalType.ICE_CANDIDATE:t={from:this.localId,to:this.remoteId,streamId:this.streamId,type:o.SignalType.ICE_CANDIDATE,payload:e.msg},this._sendBySignaling(t);break;case o.SignalType.ANSWER:t={from:this.localId,to:this.remoteId,streamId:this.streamId,type:o.SignalType.ANSWER,payload:e.msg},this._sendBySignaling(t)}}},{key:"_sendBySignaling",value:function(e){this.tp2p.trigger(c.default.SIGNAL_SENDING,e)}},{key:"onMessage",value:function(e){switch(new DataView(e).getUint8(0)){case a.Uri.AV:this.sliceManager.receivePiece(e);break;case a.Uri.PING:this.heartbeat.receivePing(e);break;case a.Uri.PONG:this.heartbeat.receivePong(e);break;case a.Uri.SUB:this.callbacks.onSubMessage(e);break;case a.Uri.P2P_FILL_REQ:this.tp2p.trigger(c.default.P2P_FILL_REQ,{remotePeerId:this.remoteId,pkt:e});break;case a.Uri.P2P_FILL_RES:this.tp2p.trigger(c.default.P2P_FILL_RES,{remotePeerId:this.remoteId,pkt:e})}}},{key:"send",value:function(e){this.webrtcPeerConnection._dataChannel.send(e)}},{key:"usableDelay",get:function(){return this.peerInfo.usableDelay}},{key:"rtt",get:function(){return this.peerInfo.rtt}},{key:"score",get:function(){return this.peerInfo.score}},{key:"info",get:function(){return this.peerInfo}}]),e}();r.default=d},{19:19,27:27,29:29,54:54,57:57,61:61}],61:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=(n=e(91))&&n.__esModule?n:{default:n},o=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.stateMgr=t,this.rttWa=new a.default(.5,100),this.remoteMaxId=0,this.remoteMinSliceId=0,this.remoteMaxContinuousId=0}return i(e,[{key:"destroy",value:function(){}},{key:"sampleRtt",value:function(e){this.rttWa.sample(e)}},{key:"sampleRemoteId",value:function(e){var t=e.lastSliceId,r=e.minSliceId,n=e.maxContinuousId;this.remoteMaxId=t,this.remoteMinSliceId=r,this.remoteMaxContinuousId=n}},{key:"usableDelay",get:function(){var e=this.stateMgr,t=e.frameRate,r=e.p2pBoundId+t,n=e.nextWriteId,i=this.remoteMaxId>r;return e.lowLatency&&(i=this.remoteMaxId>n+2*t),i}},{key:"maxSliceId",get:function(){return this.remoteMaxId}},{key:"rtt",get:function(){return this.rttWa.getEstimate()}},{key:"score",get:function(){return 100/Math.min(this.rtt,.1)}}]),e}();r.default=o},{91:91}],62:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=d(e(63)),a=e(77),o=e(27),s=d(e(60)),l=e(54),c=d(e(68)),u=d(e(19));function d(e){return e&&e.__esModule?e:{default:e}}var p=function(){function e(t,r,n,i,a,o){!function(t,r){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this),this.initiator=t,this.stateMgr=t.stateMgr,this.tp2p=r,this.dataChannelManager=n,this.sliceManager=i,this.p2pMonitor=a,this._managerStreamId=o.managerStreamId,this._init()}return n(e,[{key:"_init",value:function(){this.TAG="PeerManager",this._subed=new Set,this._sub=null,this._docheckPeer=this._checkPeer.bind(this),this._connected=new i.default,this._connecting=new i.default,this._connTryTotal=0,this._connSuccTotal=0,this._peerChangeTs=0,this._dcSendDuration=[0,5,10,20,50,100,1/0],this._dcSendLevelCount=this._dcSendDuration.length-1,this._stoppingP2P=!1,this.onStarting(),this._resetSubTree(),this._initReporterData()}},{key:"onStarting",value:function(){this._stoppingP2P=!1;var e=this.tp2p.config;this._sendSubTreeTimer=setInterval(this._sendSubTree.bind(this),1e3),this._checkPeerTimer=setInterval(this._docheckPeer,e.checkPeerInterval)}},{key:"onStopping",value:function(){var e=this;this._stoppingP2P=!0,this.tp2p.config.clearPeerOnPauseP2P&&(this._connected.forEach(function(t,r){e._deletePC(r)}),this._connecting.forEach(function(t,r){e._deletePC(r)})),this._clearTimer()}},{key:"_clearTimer",value:function(){this._checkPeerTimer&&(clearInterval(this._checkPeerTimer),this._checkPeerTimer=null),this._sendSubTreeTimer&&(clearTimeout(this._sendSubTreeTimer),this._sendSubTreeTimer=null)}},{key:"changePeer",value:function(){var e=Date.now();e-this._peerChangeTs>=this.tp2p.config.checkPeerInterval&&(this._peerChangeTs=e,this._pickUsefulSubPC(!0))}},{key:"destroy",value:function(){this._reportData=null,this._subed=null,this._connected.destroy(),this._connecting.destroy(),this._clearTimer(),this.tp2p=null,this._subTreeInfo=null}},{key:"getPeerInfo",value:function(){var e=this,t=[];return this._connected.forEach(function(r,n){t.push({peerId:n,rtt:r.rtt,parent:n===e._sub,remoteMaxSubId:r.info.remoteMaxId,remoteMinSliceId:r.info.remoteMinSliceId,remoteMaxContinuousId:r.info.remoteMaxContinuousId})}),t}},{key:"_markPCConnected",value:function(e){var t=this._connecting.remove(e);this._connected.add(e,t),this.dataChannelManager.addPeer(e,t.webrtcPeerConnection._dataChannel)}},{key:"_deletePC",value:function(e){this._connected.deletes(e),this._connecting.deletes(e),this._sub===e&&(this._sub=null),this._subed.delete(e),this.dataChannelManager.deleteSub(e),this.dataChannelManager.deletePeer(e),this._subTreeInfo.tree[e]&&delete this._subTreeInfo.tree[e]}},{key:"_checkPCExist",value:function(e){return this._connecting.has(e)||this._connected.has(e)}},{key:"receiveSignal",value:function(e){if(this._stoppingP2P)this._reportData[a.ReportField.STOP_OFFER]+=1;else{var t=e.type,r=e.from,n=e.to;if(t===o.SignalType.OFFER&&!this._checkPCExist(r)){if(!this._canConnect())return void(this.reportData[a.ReportField.REFUSE_OFFER]+=1);this.createPeerConnection({localId:n,remoteId:r})}var i=this._connecting.get(r);i&&i.receiveSignal(e)}}},{key:"createPeerConnection",value:function(e){var t=e.localId,r=e.remoteId,n={onSubMessage:this.onSubMessage.bind(this),onPeerConnectionState:this.onPeerConnectionState.bind(this)},i=void 0;this._reportData[a.ReportField.CONN_TRY]++;try{i=new s.default(this.initiator,this.tp2p,this.sliceManager,{localId:t,remoteId:r},n)}catch(e){this._reportData[a.ReportField.CREATE_PC_ERROR]++}return i&&this._connecting.add(r,i),i}},{key:"_checkPeer",value:function(){this._keepUsefulPCNumber(),this._pickUsefulSubPC(),this._kickUselessPeer(),this._clearUselessSubTree()}},{key:"_resetSubTree",value:function(){this._subTreeInfo={tree:{}}}},{key:"_sendSubTree",value:function(){var e=this,t=this._connected,r=this._subed,n=this.initiator,i=n.localPeerId,a=n.xStreamId;if(this._managerStreamId!==a&&this._sendSubTreeTimer)return clearTimeout(this._sendSubTreeTimer),!1;if(!i)return!1;var o=this._subTreeInfo.tree[i]={parent:this._sub||"",children:[],timestamp:Date.now()};r.size&&this._subed.forEach(function(e){o.children.push(e)});var s=this._subTreeInfo.tree,c={childrenTree:function e(t){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n={},i=s[t];return i&&(n[t]=i).parent&&i.parent!==r&&Object.assign(n,e(i.parent,t)),n||{}}(i),parentTree:function e(t){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n={},i=s[t];return i&&(n[t]=i).children.forEach(function(i){i!==r&&Object.assign(n,e(i,t))}),n||{}}(i)};["parent","children"].forEach(function(r){var n=c[r+"Tree"],i=o[r];"string"==typeof i&&(i=[i]),i.forEach(function(r){var i=t.get(r);i&&e.sendMessage(i,l.SubscribeEvent.SUBSCRIBE_TREE,n)})})}},{key:"_clearUselessSubTree",value:function(){var e=this.initiator,t=e.localPeerId,r=e.xStreamId;if(this._managerStreamId===r){var n=Date.now(),i=this._subTreeInfo.tree,a=this.tp2p.config.checkPeerInterval;Object.keys(i).forEach(function(e){t!==e&&i[e].timestamp-n>=a&&delete i[e]})}}},{key:"_pickUsefulSubPC",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=this._connected,r=this.initiator,n=r.localPeerId,i=r.xStreamId;if(this._managerStreamId===i){var o=this._subTreeInfo.tree[n];if(!o||o.parent||o.children.length)return!1}var s=t.get(this._sub);if(!e&&s&&this.p2pMonitor.subUseful(this._managerStreamId))return!1;var c=s;t.forEach(function(e){e.usableDelay&&(c?e.score>c.score&&(c=e):c=e)}),c&&c!==s&&(this.sendMessage(c,l.SubscribeEvent.SUBSCRIBE),s&&(this._reportData[a.ReportField.CHANGE_SUB]+=1),this._reportData[a.ReportField.SUB_TRY]++)}},{key:"_keepUsefulPCNumber",value:function(){var e=this.initiator.localPeerId,t=this.initiator.p2pController.trackerController,r=this.tp2p.config;if(!this._canConnect())return!1;for(var n=0;n++<r.maxConnectRequestEachPeriod;){var i=t.nextStreamPeer(this._managerStreamId);if(!i){this._reportData[a.ReportField.LACK_OF_PEER]++;break}if(i.peerId!==e&&!this._checkPCExist(i.peerId)){var o=this.createPeerConnection({localId:e,remoteId:i.peerId});o&&o.receiveSignal({type:"init"})}}}},{key:"_kickUselessPeer",value:function(){var e=this,t=this._connected,r=this._subed,n=t.size-this.tp2p.config.maxConnectedPC;if(0<n){var i=[],o=[];t.forEach(function(t,n){if(!r.has(n)&&n!==e._sub){if(!t.usableDelay)return o.push(t),!1;i.push(t)}}),n>o.length&&i.length&&(i.sort(function(e,t){return e.score-t.score}),o.concat(i.slice(o.length-n))),o.forEach(function(t){e._kickPeer(t.remoteId)&&e._reportData[a.ReportField.PEER_KICK_WORST]++})}}},{key:"_kickPeer",value:function(e){return!(!this._connected.has(e)||this._subed.has(e)||(this._deletePC(e),0))}},{key:"_canConnect",value:function(){var e=this.tp2p.config,t=e.maxConnectedPC,r=e.maxConnecting,n=e.maxSubscribePCUsefulCount,i=this._connected.filter("usableDelay").length;return!(this._connected.size>=t&&n<=i||this._connecting.size>=r)}},{key:"_canbeSubscribed",value:function(e){var t=e.from,r=this._subed,n=this.initiator,i=n.localPeerId,a=n.xStreamId,o=this.tp2p.config,s=o.maxSubscribedPC,l=o.maxSubLevel,c=!1;if(r.has(t))return!1;r.size<s&&(c=!0,this._managerStreamId===a)&&(l<=this._getCurSubLevel(i)&&(c=!1));return c}},{key:"_getCurSubLevel",value:function(e){var t=this._subTreeInfo.tree;return t[e]?t[e].parent?1+this._getCurSubLevel(t[e].parent):1:0}},{key:"sendMessage",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];if(e){var n=new c.default;n.event=t,n.from=e.localId,n.tree=r,n.startId=this.stateMgr.getLastSubStreamId(this._managerStreamId),e.send(n.encode())}}},{key:"onSubscribe",value:function(e){var t=e.from,r=this._connected.get(t);this._canbeSubscribed(e)?(this.sendMessage(r,l.SubscribeEvent.SUBSCRIBE_SUCC),this._subed.add(t),this.dataChannelManager.addSub(t,r.webrtcPeerConnection._dataChannel),this.tp2p.trigger(u.default.SUBSCRIBE_FILL,{from:t,startSliceId:e.startId})):(this.sendMessage(r,l.SubscribeEvent.SUBSCRIBE_FAIL),this._reportData[a.ReportField.PEER_REFUSE]++)}},{key:"onUnSubscribe",value:function(e){var t=e.from,r=this._subed;r.has(t)&&(r.delete(t),this.dataChannelManager.deleteSub(t))}},{key:"onSubscribeSucc",value:function(e){var t=e.from,r=this._connected.get(this._sub);r&&this.sendMessage(r,l.SubscribeEvent.UNSUBSCRIBE),this._reportData[a.ReportField.SUB_SUCC]++,this._sub=t,this.p2pMonitor.resetStatistics(this._managerStreamId)}},{key:"onSubscribeFail",value:function(e){var t=e.from;this._kickPeer(t)&&this._reportData[a.ReportField.PEER_KICK_SUB_FAIL]++}},{key:"onSubscribeTree",value:function(e){var t=this,r=e.tree,n=void 0===r?{}:r;Object.keys(n).forEach(function(e){if(t.initiator.localPeerId!==e){var r=n[e];r.timestamp=Date.now(),t._subTreeInfo.tree[e]=r}})}},{key:"onSubMessage",value:function(e){var t=new c.default;switch(t.decode(e),t.event){case l.SubscribeEvent.SUBSCRIBE:this.onSubscribe(t);break;case l.SubscribeEvent.UNSUBSCRIBE:this.onUnSubscribe(t);break;case l.SubscribeEvent.SUBSCRIBE_FAIL:this.onSubscribeFail(t);break;case l.SubscribeEvent.SUBSCRIBE_SUCC:this.onSubscribeSucc(t);break;case l.SubscribeEvent.SUBSCRIBE_TREE:this.onSubscribeTree(t)}}},{key:"onPeerConnectionState",value:function(e){switch(e.type){case l.PeerConnectionState.REPORT:var t=e.originData.duration;a.Level.DivideLevels(t,this._dcSendDuration,this._reportData[a.ReportField.DC_SEND_DURATION]);break;case l.PeerConnectionState.ERROR:break;case l.PeerConnectionState.FAIL:var r=this._sub;this._deletePC(e.remoteId),"initHeartTimeout"===e.reason?this._reportData[a.ReportField.INIT_PC_TIMEOUT]+=1:"heartTimeout"===e.reason?this._reportData[a.ReportField.KEEP_PC_TIMEOUT]+=1:"dataChannelError"===e.reason?this._reportData[a.ReportField.DC_ERR]+=1:"dataChannelClose"===e.reason&&(this._reportData[a.ReportField.DC_CLOSE]+=1),this._sub||e.remoteId!==r||this._pickUsefulSubPC();break;case l.PeerConnectionState.OPEN:this._reportData[a.ReportField.CONN_SUCC]++,this._markPCConnected(e.remoteId);break;case l.PeerConnectionState.ICE:}}},{key:"_initReporterData",value:function(){this._reportData={};var e=this._reportData;e[a.ReportField.SUB_TRY]=0,e[a.ReportField.SUB_SUCC]=0,e[a.ReportField.PEER_REFUSE]=0,e[a.ReportField.PEER_KICK_WORST]=0,e[a.ReportField.PEER_KICK_SUB_FAIL]=0,e[a.ReportField.LACK_OF_PEER]=0,e[a.ReportField.P2P_OUT_STREAMS]=0,e[a.ReportField.USEFUL_STREAMS]=0,e[a.ReportField.AVAILABLE_STREAMS]=0,e[a.ReportField.PEER_NUM]=0,e[a.ReportField.CONN_TRY]=0,e[a.ReportField.CONN_SUCC]=0,e[a.ReportField.DC_SEND_DURATION]=a.Level.GenLevels(this._dcSendLevelCount),e[a.ReportField.CREATE_PC_ERROR]=0,e[a.ReportField.CONN_TRY_TOTAL]=this._connTryTotal,e[a.ReportField.CONN_SUCC_TOTAL]=this._connSuccTotal,e[a.ReportField.INIT_PC_TIMEOUT]=0,e[a.ReportField.KEEP_PC_TIMEOUT]=0,e[a.ReportField.REFUSE_OFFER]=0,e[a.ReportField.DC_ERR]=0,e[a.ReportField.DC_CLOSE]=0,e[a.ReportField.STOP_OFFER]=0}},{key:"reportData",get:function(){this._connSuccTotal=this._reportData[a.ReportField.CONN_SUCC_TOTAL]+=this._reportData[a.ReportField.CONN_SUCC],this._connTryTotal=this._reportData[a.ReportField.CONN_TRY_TOTAL]+=this._reportData[a.ReportField.CONN_TRY],this._reportData[a.ReportField.AVAILABLE_STREAMS]=0<this._connected.size?1:0,this._reportData[a.ReportField.USEFUL_STREAMS]=this._sub?1:0,this._reportData[a.ReportField.P2P_OUT_STREAMS]=this._subed.size,this._reportData[a.ReportField.PEER_NUM]=this._connected.size,this._reportData[a.ReportField.CHANGE_SUB]=0;var e=this._reportData;return this._initReporterData(),e}}]),e}();r.default=p},{19:19,27:27,54:54,60:60,63:63,68:68,77:77}],63:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.map=new Map}return n(e,[{key:"destroy",value:function(){this.clear()}},{key:"clear",value:function(){this.map.forEach(function(e){e.destroy()}),this.map.clear()}},{key:"add",value:function(e,t){this.map.set(e,t)}},{key:"has",value:function(e){return this.map.has(e)}},{key:"get",value:function(e){return this.map.get(e)}},{key:"deletes",value:function(e){var t=this.map.get(e);return!!t&&(t.destroy(),this.map.delete(e),!0)}},{key:"remove",value:function(e){var t=this.map.get(e);return this.map.delete(e),t}},{key:"filter",value:function(e){var t=[];return this.map.forEach(function(r){r[e]&&t.push(r)}),t}},{key:"getOne",value:function(){return this.map.values().next().value}},{key:"forEach",value:function(e){this.map.forEach(e)}},{key:"size",get:function(){return this.map.size}}]),e}();r.default=i},{}],64:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=r.DataType={UINT8:1,UINT16:2,UINT32:4,CUSTOM:5},a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.len=0,this.content=[],this.decodeType=[],this.uri=0}return n(e,[{key:"push",value:function(e,t,r){this.content.push([e,t,r]),this.len+=r,e===i.CUSTOM&&(this.len+=4)}},{key:"encode",value:function(){var e=void 0,t=void 0,r=void 0,n=0,a=new ArrayBuffer(this.len),o=new DataView(a),s=new Uint8Array(a);return this.content.forEach(function(a){switch(e=a[0],t=a[1],r=a[2],e){case i.UINT8:o.setUint8(n,t),n+=1;break;case i.UINT16:o.setUint16(n,t),n+=2;break;case i.UINT32:o.setUint32(n,t),n+=4;break;case i.CUSTOM:o.setUint32(n,r),n+=4,s.set(t,n),n+=r}}),this.content=[],this.len=0,a}},{key:"pushDecodeType",value:function(e){this.decodeType.push(e)}},{key:"decode",value:function(e){var t=void 0,r=0,n=0,a=[],o=new DataView(e),s=new Uint8Array(e);return this.decodeType.forEach(function(e){switch(e){case i.UINT8:t=o.getUint8(n),n+=1;break;case i.UINT16:t=o.getUint16(n),n+=2;break;case i.UINT32:t=o.getUint32(n),n+=4;break;case i.CUSTOM:r=o.getUint32(n),n+=4,t=s.slice(n,r+n),n+=r}a.push(t)}),this.decodeType=[],a}}]),e}();r.default=a},{}],65:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in i)return i.value;var o=i.get;return void 0!==o?o.call(n):void 0},o=e(64),s=(n=o)&&n.__esModule?n:{default:n},c=e(54),u=function(e){function t(){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.uri=c.Uri.AV,e.seq=0,e.sliceId=0,e.tagTime=0,e.index=0,e.totalCount=0,e.usage=c.PieceUsage.NORMAL,e.data=void 0,e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s.default),i(t,[{key:"encode",value:function(){return this.push(o.DataType.UINT8,this.uri,1),this.push(o.DataType.UINT32,this.seq,4),this.push(o.DataType.UINT32,this.sliceId,4),this.push(o.DataType.UINT32,this.tagTime,4),this.push(o.DataType.UINT8,this.index,1),this.push(o.DataType.UINT8,this.totalCount,1),this.push(o.DataType.UINT8,this.usage,1),this.push(o.DataType.CUSTOM,this.data,this.data.length),a(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"encode",this).call(this)}},{key:"decode",value:function(e){this.pushDecodeType(o.DataType.UINT8),this.pushDecodeType(o.DataType.UINT32),this.pushDecodeType(o.DataType.UINT32),this.pushDecodeType(o.DataType.UINT32),this.pushDecodeType(o.DataType.UINT8),this.pushDecodeType(o.DataType.UINT8),this.pushDecodeType(o.DataType.UINT8),this.pushDecodeType(o.DataType.CUSTOM);var r=a(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"decode",this).call(this,e);this.uri=r[0],this.seq=r[1],this.sliceId=r[2],this.tagTime=r[3],this.index=r[4],this.totalCount=r[5],this.usage=r[6],this.data=r[7]}}]),t}();r.default=u},{54:54,64:64}],66:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in i)return i.value;var o=i.get;return void 0!==o?o.call(n):void 0},o=e(64),s=(n=o)&&n.__esModule?n:{default:n},c=e(54),u=function(e){function t(){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.uri=c.Uri.PING,e.receiveCnt=0,e.sendCnt=0,e.lastSliceId=0,e.minSliceId=0,e.maxContinuousId=0,e.sendTime=0,e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s.default),i(t,[{key:"encode",value:function(){return this._cal(),this.push(o.DataType.UINT8,this.uri,1),this.push(o.DataType.UINT8,this.receiveCnt,1),this.push(o.DataType.UINT8,this.sendCnt,1),this.push(o.DataType.UINT16,this.lastSliceId,2),this.push(o.DataType.UINT32,this.minSliceId,4),this.push(o.DataType.UINT16,this.maxContinuousId,2),this.push(o.DataType.UINT32,this.sendTime,4),a(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"encode",this).call(this)}},{key:"decode",value:function(e){this.pushDecodeType(o.DataType.UINT8),this.pushDecodeType(o.DataType.UINT8),this.pushDecodeType(o.DataType.UINT8),this.pushDecodeType(o.DataType.UINT16),this.pushDecodeType(o.DataType.UINT32),this.pushDecodeType(o.DataType.UINT16),this.pushDecodeType(o.DataType.UINT32);var r=a(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"decode",this).call(this,e);this.uri=r[0],this.receiveCnt=r[1],this.sendCnt=r[2],this.lastSliceId=r[3],this.minSliceId=r[4],this.maxContinuousId=r[5],this.sendTime=r[6],this._reCal()}},{key:"_cal",value:function(){this.lastSliceId=this.lastSliceId-this.minSliceId,this.maxContinuousId=this.maxContinuousId-this.minSliceId}},{key:"_reCal",value:function(){this.lastSliceId=this.lastSliceId+this.minSliceId,this.maxContinuousId=this.maxContinuousId+this.minSliceId}}]),t}();r.default=u},{54:54,64:64}],67:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in i)return i.value;var o=i.get;return void 0!==o?o.call(n):void 0},o=e(64),s=(n=o)&&n.__esModule?n:{default:n},c=e(54),u=function(e){function t(){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.uri=c.Uri.PONG,e.lastSliceId=0,e.minSliceId=0,e.maxContinuousId=0,e.lastPingTime=0,e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s.default),i(t,[{key:"encode",value:function(){return this._cal(),this.push(o.DataType.UINT8,this.uri,1),this.push(o.DataType.UINT16,this.lastSliceId,2),this.push(o.DataType.UINT32,this.minSliceId,4),this.push(o.DataType.UINT16,this.maxContinuousId,2),this.push(o.DataType.UINT32,this.lastPingTime,4),a(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"encode",this).call(this)}},{key:"decode",value:function(e){this.pushDecodeType(o.DataType.UINT8),this.pushDecodeType(o.DataType.UINT16),this.pushDecodeType(o.DataType.UINT32),this.pushDecodeType(o.DataType.UINT16),this.pushDecodeType(o.DataType.UINT32);var r=a(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"decode",this).call(this,e);this.uri=r[0],this.lastSliceId=r[1],this.minSliceId=r[2],this.maxContinuousId=r[3],this.lastPingTime=r[4],this._reCal()}},{key:"_cal",value:function(){this.lastSliceId=this.lastSliceId-this.minSliceId,this.maxContinuousId=this.maxContinuousId-this.minSliceId}},{key:"_reCal",value:function(){this.lastSliceId=this.lastSliceId+this.minSliceId,this.maxContinuousId=this.maxContinuousId+this.minSliceId}}]),t}();r.default=u},{54:54,64:64}],68:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in i)return i.value;var o=i.get;return void 0!==o?o.call(n):void 0},a=e(64),o=u(a),s=e(54),c=u(e(81));function u(e){return e&&e.__esModule?e:{default:e}}var d=function(e){function t(){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.uri=s.Uri.SUB,e.event=0,e.startId=0,e.from="",e.tree=[],e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o.default),n(t,[{key:"encode",value:function(){this.push(a.DataType.UINT8,this.uri,1),this.push(a.DataType.UINT8,this.event,1),this.push(a.DataType.UINT32,this.startId,4);var e=c.default.str2ab(this.from),r=new Uint8Array(e);this.push(a.DataType.CUSTOM,r,r.length);var n=c.default.str2ab(JSON.stringify(this.tree)),o=new Uint8Array(n);return this.push(a.DataType.CUSTOM,o,o.length),i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"encode",this).call(this)}},{key:"decode",value:function(e){this.pushDecodeType(a.DataType.UINT8),this.pushDecodeType(a.DataType.UINT8),this.pushDecodeType(a.DataType.UINT32),this.pushDecodeType(a.DataType.CUSTOM),this.pushDecodeType(a.DataType.CUSTOM);var r=i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"decode",this).call(this,e);this.uri=r[0],this.event=r[1],this.startId=r[2];var n=r[3];this.from=c.default.ab2str(n.buffer);var o=r[4];this.tree=JSON.parse(c.default.ab2str(o.buffer))}}]),t}();r.default=d},{54:54,64:64,81:81}],69:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in i)return i.value;var o=i.get;return void 0!==o?o.call(n):void 0},o=e(64),s=(n=o)&&n.__esModule?n:{default:n},c=e(54),u=function(e){function t(){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.uri=c.Uri.P2P_FILL_REQ,e.fillSliceId=0,e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s.default),i(t,[{key:"encode",value:function(){return this.push(o.DataType.UINT8,this.uri,1),this.push(o.DataType.UINT32,this.fillSliceId,4),a(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"encode",this).call(this)}},{key:"decode",value:function(e){this.pushDecodeType(o.DataType.UINT8),this.pushDecodeType(o.DataType.UINT32);var r=a(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"decode",this).call(this,e);this.uri=r[0],this.fillSliceId=r[1]}}]),t}();r.default=u},{54:54,64:64}],70:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n,i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in i)return i.value;var o=i.get;return void 0!==o?o.call(n):void 0},o=e(64),s=(n=o)&&n.__esModule?n:{default:n},c=e(54),u=function(e){function t(){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.uri=c.Uri.P2P_FILL_RES,e.fillSliceId=0,e.findSlice=0,e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s.default),i(t,[{key:"encode",value:function(){return this.push(o.DataType.UINT8,this.uri,1),this.push(o.DataType.UINT32,this.fillSliceId,4),this.push(o.DataType.UINT8,this.findSlice,1),a(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"encode",this).call(this)}},{key:"decode",value:function(e){this.pushDecodeType(o.DataType.UINT8),this.pushDecodeType(o.DataType.UINT32),this.pushDecodeType(o.DataType.UINT8);var r=a(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"decode",this).call(this,e);this.uri=r[0],this.fillSliceId=r[1],this.findSlice=r[2]}}]),t}();r.default=u},{54:54,64:64}],71:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="RatioCalcu",this.frameRate=t.frameRate,this.sampleDuration=t.sampleDuration,this.pcdnStreams=t.pcdnStreams,this.samples=new Map,this.startTime=Math.floor(Date.now()/1e3),this.init()}return n(e,[{key:"init",value:function(){for(var e=0;e<this.sampleDuration;e++)this.samples[e]=0}},{key:"sample",value:function(e){var t=Math.floor(Date.now()/1e3);if(e)if(this.samples.has(t)){var r=this.samples.get(t)+1;this.samples.set(t,r)}else this.samples.set(t,1)}},{key:"totalUseful",get:function(){var e=0;return this.samples.forEach(function(t){e+=t}),e}},{key:"ratio",get:function(){var e=this;if(Date.now()-this.startTime<1e3*this.sampleDuration)return 1;var t=Math.floor(Date.now()/1e3)-this.sampleDuration;return this.samples.forEach(function(r,n){n<=t&&e.samples.delete(n)}),this.totalUseful/(this.sampleDuration*this.frameRate/this.pcdnStreams)}}]),e}();r.default=i},{}],72:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=l(e(65)),a=l(e(19)),o=e(77),s=e(54);function l(e){return e&&e.__esModule?e:{default:e}}var c=function(){function e(t,r,n,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="SliceManager";var a=(this.tp2p=r).config;this.storage=t.storage,this.storageMgr=t.storageMgr,this.stateMgr=t.stateMgr,this.p2pMonitor=i,this.dataChannelManager=n,this._chunkSize=a.DCChunkSize,this._disableTrigger=a.disableTrigger,this._init(),this._initReporterData(),this.tp2p.registerReportCallback(this.TAG,this.reportCallback.bind(this))}return n(e,[{key:"_init",value:function(){this.cache=new Map,this._clearCacheTimer=setInterval(this.clearCache.bind(this),1e4)}},{key:"destroy",value:function(){this.cache.clear(),this._clearCacheTimer&&(clearInterval(this._clearCacheTimer),this._clearCacheTimer=null)}},{key:"receiveSlice",value:function(e,t,r){var n=this.dataChannelManager.subsSize;if(n){var i=this.fragmentedData(t,this._chunkSize),a=this.packetPiece(e,r,i);this._reportData[o.ReportField.P2P_SEND_BYTES]+=t.length*n,this.sendToPeer(a)}}},{key:"receiveFillSlice",value:function(e,t,r,n,i){var a=this.fragmentedData(r,this._chunkSize),s=this.packetPiece(t,n,a,i);this._reportData[o.ReportField.P2P_SEND_BYTES]+=r.length,this.dataChannelManager.sendToPeer(e,s)}},{key:"fragmentedData",value:function(e,t){for(var r=e.length,n=Math.ceil(r/t),i=[],a=0;a<n;a++){var o=a*t,s=Math.min(o+t,r),l=e.slice(o,s);i.push(l)}return i}},{key:"packetPiece",value:function(e,t,r){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:s.PieceUsage.NORMAL,a=[],o=r.length;return r.forEach(function(r,s){var l=new i.default;l.sliceId=e,l.tagTime=t,l.index=s,l.totalCount=o,l.usage=n,l.data=r,a.push(l.encode())}),a}},{key:"sendToPeer",value:function(e){this.dataChannelManager.sendToAllSub(e)}},{key:"receivePiece",value:function(e){var t=new i.default;t.decode(e);var r=t.sliceId,n=t.seq,a=t.tagTime,o=t.usage;if(this.addPiece(t)){var l=this.mergePiece(t);o===s.PieceUsage.NORMAL?this.writeNormalSlice(r,l,a):o!==s.PieceUsage.FILL&&o!==s.PieceUsage.PUSH||this.writeFillSlice(r,l,a,o)}this.p2pMonitor.plrSample(r,n)}},{key:"addPiece",value:function(e){var t=e.sliceId,r=e.index,n=e.totalCount,i=e.data;this._reportData[o.ReportField.P2P_DOWNLOAD_BYTES]+=i.length;var a=this.cache.get(t);return a?(a[r]=i,a[n]+=1,a[n+1]+=i.length):((a=[]).length=n+2,a[n]=1,a[n+1]=i.length,a[r]=i,this.cache.set(t,a)),a[n]===n}},{key:"mergePiece",value:function(e){for(var t=e.sliceId,r=e.totalCount,n=this.cache.get(t),i=new Uint8Array(n[r+1]),a=0,o=0;o<r;o++)i.set(n[o],a),a+=n[o].length;return this.cache.delete(t),i}},{key:"storeSlice",value:function(e,t,r){var n=!this.storage.has(e)&&e>=this.stateMgr.nextWriteId;return n&&(this.stateMgr.setSubStreamId(e),this.storageMgr.cleanStorage(),this.storage.set(e,{payload:t,tagTime:r}),this._reportData[o.ReportField.P2P_DOWNLOAD_USEFUL_BYTES]+=t.length,this.tp2p.flow.PRB+=t.length*(this.tp2p.config.bpFix||1)),n}},{key:"writeNormalSlice",value:function(e,t,r){var n=this.storeSlice(e,t,r);this.p2pMonitor.sample(e,n),n&&(this.tp2p.config.enableWriteAll&&this.tp2p&&this.tp2p.initiator&&this.tp2p.initiator.writer&&this.tp2p.initiator.writer.onFoundSlice(),this._disableTrigger?this.stateMgr.onP2PLoaded({sliceId:e,payload:t,tagTime:r}):this.tp2p.trigger(a.default.P2P_LOADED,{sliceId:e,payload:t,tagTime:r}))}},{key:"writeFillSlice",value:function(e,t,r,n){this.storeSlice(e,t,r)&&this.tp2p.trigger(a.default.P2P_FILL_SUCCESS,{sliceId:e,length:t.length,usage:n})}},{key:"clearCache",value:function(){if(this.cache.size){var e=this.stateMgr.nextWriteId-1,t=this.cache.keys(),r=!0,n=!1,i=void 0;try{for(var a,o=t[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;s<e&&this.cache.delete(s)}}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}}}},{key:"_initReporterData",value:function(){this._reportData={};var e=this._reportData;e[o.ReportField.P2P_SEND_BYTES]=0,e[o.ReportField.P2P_DOWNLOAD_BYTES]=0,e[o.ReportField.P2P_BYTES]=0,e[o.ReportField.P2P_DOWNLOAD_USEFUL_BYTES]=0}},{key:"reportCallback",value:function(){this._reportData[o.ReportField.P2P_BYTES]=this._reportData[o.ReportField.P2P_DOWNLOAD_USEFUL_BYTES];var e=this._reportData;return this._initReporterData(),e}}]),e}();r.default=c},{19:19,54:54,65:65,77:77}],73:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.map=new Map}return n(e,[{key:"destroy",value:function(){this.map=null}},{key:"has",value:function(e){return this.map.has(e)}},{key:"get",value:function(e){return this.map.get(e)}},{key:"set",value:function(e,t){this.map.set(e,t)}},{key:"delete",value:function(e){if(1<arguments.length&&void 0!==arguments[1]&&arguments[1]){var t=this.map.keys(),r=!0,n=!1,i=void 0;try{for(var a,o=t[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;s<=e&&this.map.delete(s)}}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}}else this.map.delete(e)}},{key:"clear",value:function(){this.map.clear()}},{key:"size",get:function(){return this.map.size}}]),e}();r.default=i},{}],74:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.length=t||0,this.array=[],this.offset=0}return n(e,[{key:"push",value:function(e){this.array.push(e),this.length+=e.length}},{key:"shift",value:function(e){if(this.array.length<1)return new Uint8Array(0);if(this.offset+e===this.array[0].length){var t=this.array[0].slice(this.offset,this.offset+e);return this.offset=0,this.array.shift(),this.length-=e,t}if(this.offset+e<this.array[0].length){var r=this.array[0].slice(this.offset,this.offset+e);return this.offset+=e,this.length-=e,r}for(var n=new Uint8Array(e),i=0;0<this.array.length&&0<e;){if(this.offset+e<this.array[0].length){var a=this.array[0].slice(this.offset,this.offset+e);n.set(a,i),this.offset+=e,this.length-=e,e=0;break}var o=this.array[0].length-this.offset;n.set(this.array[0].slice(this.offset,this.array[0].length),i),this.array.shift(),this.offset=0,i+=o,this.length-=o,e-=o}return n}},{key:"clear",value:function(){this.array=[],this.length=0,this.offset=0}},{key:"shiftBuffer",value:function(){0<this.array.length&&(this.length-=this.array[0].length,this.array.shift(),this.offset=0)}},{key:"toInt",value:function(e,t){for(var r=0,n=this.offset+e;n<this.offset+t+e;)n<this.array[0].length?r=256*r+this.array[0][n]:this.array[1]&&(r=256*r+this.array[1][n-this.array[0].length]),n++;return r}}]),e}();r.default=i},{}],75:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.tp2p=r,this.storage=t.storage,this.stateMgr=t.stateMgr,this._minId=0}return n(e,[{key:"destroy",value:function(){this.tp2p=null,this.stateMgr=null,this.storage=null}},{key:"cleanStorage",value:function(){var e=this.tp2p.config.uselessSliceCount,t=this.stateMgr.nextWriteId-1-e;0<t&&(this.storage.delete(t,!0),this._minId=t+1)}},{key:"missingSliceNum",value:function(e,t){for(var r=0,n=e;n<t;n++)this.storage.has(n)||(r+=1);return r}},{key:"minSliceId",get:function(){for(var e=this.stateMgr.nextWriteId;this._minId<e;){if(this.storage.has(this._minId))return this._minId;this._minId+=1}return this._minId}},{key:"maxContinuousId",get:function(){for(var e=this.stateMgr.nextWriteId-1,t=e;this.storage.has(t);)t+=1;return e===t?e:t-1}}]),e}();r.default=i},{}],76:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=d(e(19)),a=d(e(18)),o=e(9),s=d(e(84)),c=d(e(83)),u=e(77);function d(e){return e&&e.__esModule?e:{default:e}}var p=function(e){function t(e,r){!function(e,r){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":l(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r,i.default.FLV_HEAD_LOADED,i.default.WRITE_SKIP,i.default.FOUND_SLICE,i.default.STOP_WRITE_SKIP));return n.TAG="PCDNWriter",n.tp2p=r,n._writerHeader=!1,n._nextWriteId=0,n.storage=e.storage,n.stateMgr=e.stateMgr,n.frameRater=new s.default,n.flvParser=new c.default,n.sampleFrameRate=!0,n._skipRetryTimes=0,n._confirmLossSkipTs=0,n._confirmLossCheckDelay=0,n._confirmLossSkipId=-1,n._beginId=0,n._lastWriteId=0,n._writeHandler=n.writeSlice.bind(n),n._initReporterData(),n.tp2p.registerReportCallback(n.TAG,n.reportCallback.bind(n)),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":l(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.default),n(t,[{key:"destroy",value:function(){this.onStopping(),this.storage=null}},{key:"clearTimer",value:function(){this._writerTimer&&(clearInterval(this._writerTimer),this._writerTimer=null),this._sampleTimer&&(clearInterval(this._sampleTimer),this._sampleTimer=null),this._checkSkipTimer&&(clearTimeout(this._checkSkipTimer),this._checkSkipTimer=null)}},{key:"startTimer",value:function(){var e=this;this._writerTimer||(this._writerTimer=setInterval(this._writeHandler,200)),this._sampleTimer||(this._sampleTimer=setTimeout(function(){e.sampleFrameRate=!0},100))}},{key:"onStarting",value:function(){}},{key:"onStopping",value:function(){this.clearTimer()}},{key:"onFlvHeadLoaded",value:function(e){var t=e.startSliceId,r=e.payload;this._writerHeader||(this.writeToPlayer(r.buffer),this._writerHeader=!0,this.startTimer(),this._beginId=t),this.nextWriteId<t&&(this.nextWriteId=t),this.stateMgr.baseTime=Date.now(),this.stateMgr.baseId=this.nextWriteId,this.writeSlice()}},{key:"onFoundSlice",value:function(e){var t=e.sliceId;this.stateMgr.loadingMain&&t&&this.nextWriteId<t&&(this.nextWriteId=t),this.writeSlice()}},{key:"writeSlice",value:function(){this._writeControl()&&this._writeSlice()}},{key:"_writeControl",value:function(){return this._startControl()&&this._stuckControl()}},{key:"_startControl",value:function(){if(this.stateMgr.loadingMain){var e=this.tp2p.config.startPlayWaitSliceLen;if(0<e){var t=this.stateMgr,r=t.baseId,n=t.maxSliceId,i=r+e;if(this.nextWriteId>=i)return!0;if(e<=n-r+1)for(var a=0,o=r;o<=n;o++)if(this.storage.has(o)&&e<=++a)return!0;return!1}}return!0}},{key:"_stuckControl",value:function(){if(!this.tp2p.config.enableStuckWaitBuffer)return!0;var e=!this.stateMgr.stuck||this._delayCheck()&&this._bufferCheck();return this.stateMgr.stuck&&e&&(this._reportData[u.ReportField.RESUME_PLAY_SUCC]+=1),e}},{key:"_delayCheck",value:function(){return this.stateMgr.realDelay>=this.tp2p.config.resumePlayDelay}},{key:"_bufferCheck",value:function(){var e=this.nextWriteId;if(!e)return!0;var t=this.storage.get(e);if(!t)return!1;for(var r=t.tagTime,n=e,i=this.tp2p.config.resumePlayBuffer;this.storage.has(n);){if(this.storage.get(n).tagTime-r>=1e3*i||n-e>=i*this.stateMgr.frameRate)return!0;n+=1}return!1}},{key:"_writeSlice",value:function(){var e=this;if(this._writerHeader)for(var t=0,r=this.storage,n=function(){if(!e.stateMgr.loadingMain){var t=e._isConfirmLoss(e.nextWriteId);!1!==t&&(e.nextWriteId=t)}return e.nextWriteId},i=void 0;i=r.get(n());){this.nextWriteId===this._confirmLossSkipId&&(this._reportData[u.ReportField.CL_SKIP_SUC]++,this._confirmLossSkipId=-1),this._lastWriteId&&1<this.nextWriteId-this._lastWriteId&&(this._reportData[u.ReportField.LOSS_COUNT]+=this.nextWriteId-this._lastWriteId),this._lastWriteId&&this._lastWriteId>=this.nextWriteId&&(this._reportData[u.ReportField.REWRITE_COUNT]+=1),this._lastWriteId=this.nextWriteId;var a=i.payload.buffer.slice(0);this.writeToPlayer(a),this.sampleFrameRate&&10<(t=this.frameRater.sample(i.tagTime))&&t<70&&(this.stateMgr.frameRate=t,this.sampleFrameRate=!1),this.nextWriteId+=1}}},{key:"writeToPlayer",value:function(e){this.tp2p.trigger(i.default.STATE_CHANGE,{code:o.ComCode.RECEIVE_BUFFER,payload:e})}},{key:"onWriteSkip",value:function(e){var t=e.retry;if(this.stateMgr.playStart){var r=this.nextWriteId,n=this._findKeyFrame(r,r+30*this.stateMgr.frameRate);if(!1!==n)return t&&(this.stateMgr.playSkipSucc=!0,this._skipRetryTimes=0),void(this.nextWriteId=n);t&&this._retrySkip()}}},{key:"_findKeyFrame",value:function(e,t){for(var r=this.storage,n=this.flvParser;e<=t;){if(r.has(e)){var i=r.get(e);if(n.containKeyFrame(i.payload.buffer))return e}e++}return!1}},{key:"_retrySkip",value:function(){var e=this;this._checkSkipTimer||this._skipRetryTimes!==this.tp2p.config.maxSkipRetryTimes&&(this._checkSkipTimer=setTimeout(function(){e._checkSkipTimer=null,e._skipRetryTimes+=1,e._reportData[u.ReportField.SKIP_RETRY_TIMES]+=1,e.onWriteSkip({retry:!0})},2e3))}},{key:"onStopWriteSkip",value:function(){this._checkSkipTimer&&(clearTimeout(this._checkSkipTimer),this._checkSkipTimer=null)}},{key:"_isConfirmLoss",value:function(e){var t=this.stateMgr,r=this.tp2p.config.confirmLossEnable,n=!1;if(!t.loadingMain&&r&&t.confirmLoss.has(e)){var i=Date.now(),a=e;i-this._confirmLossSkipTs>=this._confirmLossCheckDelay&&!1!==(n=this._findKeyFrame(e,Math.min(e+30*t.frameRate,t.maxSliceId)))&&(t.confirmLossSkipSliceId=e,this._confirmLossSkipId=n,this._confirmLossSkipTs=i,this._confirmLossCheckDelay=(n-e)*t.frameRate*1e3,a="("+a+", "+n+")",this._reportData[u.ReportField.CL_SKIP_COUNT]++,this._reportData[u.ReportField.CL_SKIP_BUFFERS]=this.tp2p.bufferLength),~this._reportData[u.ReportField.CL_SLICE_IDS].indexOf(a)||this._reportData[u.ReportField.CL_SLICE_IDS].push(a)}return n}},{key:"reportCallback",value:function(){var e=this._reportData,t=this.stateMgr.maxSliceId;e[u.ReportField.DIFF_MAX_WRITE]=t-this.nextWriteId;var r=this.stateMgr.baseId+Math.floor((Date.now()-this.stateMgr.baseTime)/1e3)*this.stateMgr.frameRate;e[u.ReportField.DIFF_MAX_BASE]=t-r;for(var n=[],i=[],a=0;a<this.stateMgr.baseSub;a++){var o=t-this.stateMgr.getMaxSubStreamId(a);n.push(o),e[u.ReportField.DIFF_MAX_SUB]["s"+a]=o;var s=this.stateMgr.getMaxSubStreamId(a)-this.stateMgr.getLastSubStreamId(a);i.push(s),e[u.ReportField.DIFF_SUB_CON]["s"+a]=s}e[u.ReportField.DIFF_MAX_SUB_AVG]=n.reduce(function(e,t){return e+t})/this.stateMgr.baseSub,e[u.ReportField.DIFF_SUB_CON_AVG]=i.reduce(function(e,t){return e+t})/this.stateMgr.baseSub;var l=e[u.ReportField.CL_SLICE_IDS];return delete e[u.ReportField.CL_SLICE_IDS],l.length&&(e[u.ReportField.CL_SLICE_IDS]=l.join("-")),e[u.ReportField.WRITE_COUNT]=this.nextWriteId-this._beginId,e[u.ReportField.RESUME_PLAY_SUCC]||delete e[u.ReportField.RESUME_PLAY_SUCC],e[u.ReportField.REWRITE_COUNT]||delete e[u.ReportField.REWRITE_COUNT],this._initReporterData(),e}},{key:"_initReporterData",value:function(){this._beginId=this.nextWriteId,this._reportData={};var e=this._reportData;e[u.ReportField.SKIP_RETRY_TIMES]=0,e[u.ReportField.DIFF_MAX_SUB]={},e[u.ReportField.DIFF_SUB_CON]={},e[u.ReportField.DIFF_MAX_SUB_AVG]=0,e[u.ReportField.DIFF_SUB_CON_AVG]=0,e[u.ReportField.CL_SLICE_IDS]=[],e[u.ReportField.CL_SKIP_COUNT]=0,e[u.ReportField.CL_SKIP_SUC]=0,e[u.ReportField.CL_SKIP_BUFFERS]=0,e[u.ReportField.WRITE_COUNT]=0,e[u.ReportField.LOSS_COUNT]=0,e[u.ReportField.RESUME_PLAY_SUCC]=0,e[u.ReportField.REWRITE_COUNT]=0}},{key:"nextWriteId",set:function(e){1<e-this._nextWriteId&&this.stateMgr.resetSubMaxCon(),this._nextWriteId=e,this.stateMgr.nextWriteId=this._nextWriteId},get:function(){return this._nextWriteId}}]),t}();r.default=p},{18:18,19:19,77:77,83:83,84:84,9:9}],77:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();r.ReportField={STREAM_ID:"stream_id",STR_APPID:"str_appid",REQUEST:"request",STUCK_COUNT:"stuck_count",CDN_BYTES:"cdn_bytes",P2P_BYTES:"p2p_bytes",STR_USER_ID:"str_user_id",STR_PLAY_ID:"str_play_id",ROOMID:"roomid",USER_AGENT:"user_agent",REFERER:"referer",LOG_VERSION:"log_version",CONF_VERSION:"conf_version",SERVICE:"service",APPID:"appid",BIZID:"bizid",MODULE_ID:"module_id",COMMAND:"command",DATA_TIME:"data_time",DATA_TYPE:"data_type",PLATFORM:"platform",VERSION:"version",VIDEO_TYPE:"video_type",CHANNEL:"channel",PARTNER:"partner",PAGE_VISIBILITY:"page_visibility",ARCH:"arch",LOAD_VISIBLE:"page_visible",PLAY_VISIBLE:"play_visible",CURRENT_TIME:"cur_time",TOTAL_PLAY_TIME:"totalplay_t",PLAY_TIME:"play_time",CURRENT_PLAYED_DURATION:"cur_play_duration",UUID:"uuid",CODE:"code",EVENT_CODE:"event_code",SRC_TYPE:"src_type",LIFE:"life",HOST:"host",STR_VIDEO_TYPE:"str_video_type",URL:"url",PLAY_START:"play_start",CONF_OK_TIME:"confok_t",CONF_DURATION:"confduration",CONF_ERROR:"conf_error",CONF_TIMEOUT:"conf_timeout",CONF_FAIL:"conf_fail",LOAD_OK_TIME:"loadok_t",METADATA_TIME:"metadata_t",LOADEDDATA_TIME:"loadeddata_t",FIRST_DOWNLOAD_TIME:"first_dw_t",RES_OK:"res_ok_t",PLAY_STUCK_SHORT:"play_stuck_short",PLAY_STUCK_HIGH_BUFFER:"play_stuck_high_buffer",PLAY_STUCK_TIRED:"play_stuck_tired",PLAY_STUCK_INIT:"play_stuck_init",INIT_STUCK_TIME:"init_stuck_time",PLAY_STUCK_MAIN:"play_stuck_main",MAIN_STUCK_TIME:"main_stuck_time",PLAY_SKIP:"play_skip",PLAY_DELAY:"play_delay",STUCK_ID:"stuck_pieceid",WAIT_PLAY:"wait_play",WAIT_BUFFER_LEN:"wait_buffer_len",CDN_ERROR_ID:"cdn_errorid",IS_FIRST_PIECE_DOWNLOAD:"has_first_piece",STUCK_DURATION:"stuck_duration",FASTFORWARD_COUNT:"fastforward_count",SLOWDOWN_COUNT:"slowdown_count",REAL_FASTFORWARD:"real_fastforward",REAL_SLOWDOWN:"real_slowdown",CLEAR_FASTFORWARD:"clear_fastforward",CDN_DOWNLOAD_BYTES:"cdn_download_bytes",CDN_DOWNLOAD_USEFUL_BYTES:"cdn_download_useful_bytes",P2P_DOWNLOAD_BYTES:"p2p_download_bytes",P2P_DOWNLOAD_USEFUL_BYTES:"p2p_download_useful_bytes",P2P_FROM_SHARE_BYTES:"p2p_from_share_bytes",P2P_SEND_BYTES:"p2p_send_bytes",DATA_DELAY:"data_delay",BUFFER_LENGTH:"buffer_length",SYNC:"sync",SYNC_BACK:"sync_back",CDN_PIECE_ID:"cdn_piece_id",PLAY_ID:"play_id",LATEST_PIECE_ID:"latest_piece_id",APPEND_PIECE_ID:"append_id",CUR_CDN_ID:"cur_cdn_id",CDN_REQUEST:"cdn_request",CDN_SUCCESS:"cdn_success",CDN_RETRY:"cdn_retry",CDN_FAIL:"cdn_fail",CDN_404:"cdn_404",CDN_TIMEOUT:"cdn_timeout",CDN_DURATION:"cdn_duration",CDN_BACKUP_REQUEST:"cdn_backup_request",CDN_BACKUP_REQUEST_SUCC:"cdn_backup_request_succ",REFUSE_XPIECE:"refuse_xpiece",REFUSE_BACKUP:"refuse_backup",CDN_ABORT_MAIN:"cdn_abort_main",CDN_ABORT_BAK:"cdn_abort_bak",SUB_TRY:"sub_try",SUB_TRY_PLR:"sub_try_plr",SUB_SUCC:"sub_succ",SUB_TREE_LEVEL:"sub_tree_level",UNSUB:"unsub",PEER_REFUSE:"peer_refuse",PEER_KICK_WORST:"peer_kick_worst",PEER_KICK_SUB_FAIL:"peer_kick_sub_fail",WEBRTC_ICE_CONNECT_STATE:"webrtc_ice_connect_state",LACK_OF_PEER:"lack_of_peer",USEFUL_STREAMS:"useful_streams",AVAILABLE_STREAMS:"available_streams",P2P_OUT_STREAMS:"p2p_out_streams",PEER_NUM:"peer_num",CONNECTED:"connected",DC_SEND_DURATION:"dc_send_duration",MY_STREAM_ID:"stream_id",INIT_PC_TIMEOUT:"init_pc_timeout",KEEP_PC_TIMEOUT:"keep_pc_timeout",DC_ERR:"dc_err",DC_CLOSE:"dc_close",TYPE_ERROR_BLOB:"type_error_blob",CONN_TRY:"conn_try",CONN_TRY_TOTAL:"conn_try_total",CONN_SUCC:"conn_succ",CONN_SUCC_TOTAL:"conn_succ_total",T_PEER:"t_peers",CREATE_PC_ERROR:"create_pc_error",REFUSE_OFFER:"refuse_offer",STOP_OFFER:"stop_offer",LOCAL_STREAM_SHARE:"local_stream_share",STUN_IP:"stun",CHANGE_SUB:"change_sub",STOPPING_P2P:"stop_p2p",START_P2P:"start_p2p",PLAY_ORIGIN:"play_origin",ABNORMAL_REQUEST:"abnormal_request",EXIT_REASON:"exit_reason",EXIT_DESTROY:"destroy",EXIT_CLOSE_TAB:"close",EXIT_ROLLBACK:"rollback",ROLLBACK_REASON:"rollback_reason",ROLLBACK_STUCK:"rb_stuck",ROLLBACK_CDN_ERR:"rb_cdn_err",ROLLBACK_SPLIT_STARTING:"rb_conf_ret8",ROLLBACK_NONEXISTENT:"rb_conf_403",ROLLBACK_CONF_ERROR:"rb_conf_error",ROLLBACK_CONF_TIMEOUT:"rb_conf_timeout",ROLLBACK_CONF_CONFIG:"rb_conf_config",ROLLBACK_EMPTY_BUFFER:"rb_empty_buf",ROLLBACK_NOT_ENOUGH_SPLIT:"rb_lack_m4s",ROLLBACK_APPEND_EXCEPTION:"rb_append_except",ROLLBACK_STUCK_CODE:"rb_stuck_code",BROWSER_NAME:"browser_name",BROWSER_MAJOR:"browser_major",BROWSER_VERSION:"browser_version",MEMORY_USAGE:"memory_usage",FULL_SCREEN:"full_screen",OPEN_VISIBLE:"open_visible",METADATA:"metadata",VIDEO_DATA_RATE:"videodatarate",ROLLBACK_STREAM_END:"rb_stream_end",ROLLBACK_STREAM_404:"rb_stream_404",ROLLBACK_STREAM_403:"rb_stream_403",ROLLBACK_NETWORK_ERR:"rb_net_err",ROLLBACK_STREAM_UNKNOWN_ERR:"rb_stream_un_err",ROLLBACK_ZTC_FAIL:"rb_ztc_fail",ROLLBACK_STREAM_TIMEOUT:"rb_stream_timeout",ROLLBACK_SLICE_NOT_FOUND:"rb_no_slice",ROLLBACK_READ_ERR:"rb_read_err",FILL_REQ:"fill_req",FILL_SLICE:"fill_slice",FILL_FULL_QUE:"fill_full_que",FILL_REQ_404:"fill_req_404",FILL_REQ_TIMEOUT:"fill_req_timeout",FILL_TIMEOUT_OK:"fill_timeout_ok",FILL_REQ_OK:"fill_req_ok",FILL_SLICE_OK:"fill_slice_ok",FILL_404_ID:"fill_404_id",FILL_TIMEOUT_ID:"fill_timeout_id",FILL_GT_SUB:"fill_gt_sub",FILL_DURATION:"fill_dura",FILL_BYTES:"fill_bytes",FILL_BAK_REQ:"fill_bak_req",FILL_BAK_OK:"fill_bak_ok",FILL_BAK_404:"fill_bak_404",FILL_BAK_TIMEOUT:"fill_bak_timeout",FILL_FORCE:"fill_force",EARLY_COUNT:"early_cnt",MISS_COUNT:"miss_cnt",EXPIRE_COUNT:"expire_cnt",FILL_TRY_P:"fill_try_p",FILL_REQ_P:"fill_req_p",FILL_OK_P:"fill_ok_p",FILL_NO_PEER_MISS:"fill_no_peer_miss",FILL_MISS_P:"fill_miss_p",FILL_EMPTY_P:"fill_empty_p",FILL_TIMEOUT_P:"fill_timeout_p",FILL_P_S_BYTES:"fill_p_s_bytes",FILL_P_R_BYTES:"fill_p_r_bytes",FILL_P_U_BYTES:"fill_p_u_bytes",PUSH_REQ:"push_req",PUSH_OK:"push_ok",PUSH_MISS:"push_miss",PUSH_S_BYTES:"push_s_bytes",PUSH_U_BYTES:"push_u_bytes",PLAY_SKIP_SUCC:"play_skip_succ",P2P_EN_SUB:"p2p_en_sub",P2P_DIS_SUB:"p2p_dis_sub",SKIP_RETRY_TIMES:"skip_retry_times",FRAME_RATE:"frame_rate",NOT_FOUND_COUNT:"cnt_404",FORBIDDEN_COUNT:"cnt_403",NETWORK_ERROR_COUNT:"cnt_net_err",FINISHED_COUNT:"cnt_done",UNKNOWN_ERROR_COUNT:"cnt_unknown",TIMEOUT_COUNT:"cnt_timeout",READ_ERROR_COUNT:"cnt_read_err",STREAM_STATE:"stream_state",LOAD_SUB_COUNT:"load_sub_cnt",ERR_SLICE_FRAME_COUNT:"err_slice_cnt",ERR_MAIN_NOT_CON:"err_main_not_con",STUCK_ID_PCDN:"stuck_id_pcdn",SUB_MAX_ID:"sub_max_id",DIFF_MAX_BASE:"diff_max_base",DIFF_MAX_WRITE:"diff_max_write",DIFF_MAX_SUB:"diff_max_sub",DIFF_SUB_CON:"diff_sub_con",DIFF_SUB_CON_AVG:"diff_sub_con_avg",DIFF_MAX_SUB_AVG:"diff_max_sub_avg",SUB_CONTINUOUS_ID:"sub_continuous_id",STUCK_TRIGGER_RELOAD_COUNT:"trigger_reload_cnt",STUCK_RELOAD_COUNT:"reload_cnt",STUCK_RELOAD_RECOVER:" stuck_reload_recover",CUR_WRITE_ID:"cur_write_id",WRITE_COUNT:"write_cnt",LOSS_COUNT:"loss_cnt",REWRITE_COUNT:"rewrite_cnt",ZTC_ADDRESS:"ztc_address",ZTC_BAK:"ztc_bak",RESUME_PLAY_SUCC:"resume_play_succ",LOADING_PAGE_VISIBILITY:"page_visible_load",SSM_PULL_STREAM:"ssm_pull_stream",STUCK_TOTAL:"stuck_total",STUCK_FROM_MAIN:"stuck_from_main",STUCK_FROM_SUB:"stuck_from_sub",STUCK_FROM_CL:"stuck_from_cl",STUCK_FIRST_BUFFER_LEN:"stuck_first_buffer_len",STUCK_ALL_BUFFER_LEN:"stuck_all_buffer_len",CL_SLICE_IDS:"cl_slice_ids",CL_SKIP_COUNT:"cl_skip_count",CL_SKIP_SUC:"cl_skip_suc",CL_SKIP_BUFFERS:"cl_skip_buffers",DIFF_SUB_MAX_TO_PLAY:"diff_sub_max_to_play",DIFF_SUB_CON_TO_PLAY:"diff_sub_con_to_play",DIFF_SUB_MAX_TO_IDLE:"diff_sub_max_to_idle",DIFF_MAX_TO_SUB_MAX:"diff_max_to_sub_max",DIFF_MAX_TO_PLAY:"diff_max_to_play",DIFF_MAX_TO_IDLE:"diff_max_to_idle"},r.ReportCode={PHASE_DATA:"000",PLAY_START:"101",LOAD_OK:"102",ROLLBACK:"103",CONF_OK:"104",END_OF_STREAM:"105"},r.Level=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,null,[{key:"GenLevels",value:function(e){for(var t={},r=0;r<e;r++)t["level"+r]=0;return t["level-1"]=0,t}},{key:"DivideLevels",value:function(e,t,r){var n=t.length;if("number"!=typeof e)throw Error("level分级传入的数值需为 number 类型");if(t[n-1]!==1/0)throw Error("level分级传入的levelInterval最后一个值必须为Infinity!");for(var i=void 0,a=0;a<n-1;a++)if(e>=t[a]&&e<t[a+1]){i="level"+a;break}i||(i="level-1"),r[i]+=1}}]),e}()},{}],78:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.reset()}return n(e,[{key:"reset",value:function(){this._cdnBytes=0,this._p2pReceiveBytes=0,this._p2pSendBytes=0}},{key:"CBS",get:function(){return Math.floor(this._cdnBytes)},set:function(e){this._cdnBytes=e}},{key:"PRB",get:function(){return Math.floor(this._p2pReceiveBytes)},set:function(e){this._p2pReceiveBytes=e}},{key:"PSB",get:function(){return this._p2pSendBytes},set:function(e){this._p2pSendBytes=e}}]),e}();r.default=i},{}],79:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=S(e(88));e(23);var a=e(17),o=e(10),s=S(e(6)),l=S(e(19)),c=e(9),u=e(86),d=S(e(13)),p=S(e(11)),f=S(e(12)),h=e(77),_=S(e(47)),v=S(e(78)),m=S(e(80)),y=S(e(7)),g=S(e(82)),b=S(e(16));function S(e){return e&&e.__esModule?e:{default:e}}i.default.install();var T=function(){function e(){var t=this,r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};!function(t,r){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this),this.TAG="TP2P",this.config={},Object.assign(this.config,r);var n=e.DefaultConfig,i=new y.default(window.navigator.userAgent);for(var a in n)a in this.config||(this.config[a]=n[a]);this.config.browser=i.getBrowser(),this.config.randomPlayId=Date.now()+"-"+Math.floor(Math.random()*(Math.floor(999999999)-Math.ceil(1)))+Math.ceil(1),this.config.loadTime=Date.now(),(0,u.enableLogs)(r.debug),u.logger.log("初始化p2p"),this.status={rollbackReason:"",openVisible:"unset",closeReason:"",isFirstPieceDownloaded:!1};var o=this.observer=new s.default;o.trigger=function(e){for(var t=arguments.length,r=Array(1<t?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];o.emit.apply(o,[e,e].concat(r))},o.off=function(e){for(var t=arguments.length,r=Array(1<t?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];o.removeListener.apply(o,[e].concat(r))},this.on=o.on.bind(o),this.off=o.off.bind(o),this.trigger=o.trigger.bind(o),this.listen=function(e,r){var n=[];Object.keys(c.ComEvent).forEach(function(e){n.push(c.ComEvent[e])}),-1<n.indexOf(e)&&t.on(e,r)};var l=this.reporterLoader=new d.default(this),h=this.reporterController=new f.default(this),m=this.errorController=new p.default(this);this.lazyStartComponents=[h],this.coreComponents=[h,l,m],this.config.arch="pcdn";var g=_.default;this.initiator=new g(this,this._startLazyComponents.bind(this)),this.flow=new v.default}return n(e,null,[{key:"isSupported",value:function(){return g.default.supportMSEH264Playback()&&(g.default.supportFetch()&&g.default.supportReadableStream()||g.default.supportMozXhr())&&e.supportP2P()}},{key:"supportP2P",value:function(){return g.default.supportWebSocket()&&g.default.supportDataType()&&g.default.supportObjectURL()&&g.default.supportRTCPeerConnection()&&g.default.supportDataChannel()}},{key:"version",get:function(){return"1.7.14"}},{key:"Events",get:function(){return l.default}},{key:"ComEvents",get:function(){return c.ComEvent}},{key:"ComCodes",get:function(){return c.ComCode}},{key:"RollbackReason",get:function(){return c.RollbackReasons}},{key:"ErrorTypes",get:function(){return a.ErrorTypes}},{key:"ErrorDetails",get:function(){return a.ErrorDetails}},{key:"DefaultConfig",get:function(){return e.defaultConfig?e.defaultConfig:o.tp2pDefaultConfig},set:function(t){e.defaultConfig=t}}]),n(e,[{key:"destroy",value:function(){u.logger.log("destroy"),this.coreComponents.forEach(function(e){e.destroy()}),this.initiator.destroy(),this.lazyStartComponents=null,this.observer.removeAllListeners(),this.media=null,this._player=null}},{key:"loadSource",value:function(e){this.config.loadTime=Date.now(),this._registerConfig(e),this._initPlay()}},{key:"_registerConfig",value:function(e){var t=this.config,r=b.default.checkConfig(this,e);if(r.error)throw Error(r.error);r.warn&&u.logger.warn(r.warn),r.log&&u.logger.log(r.log);var n=b.default.Url(e.src,t.domain);Object.assign(t,n),this._registerMediaElement(e.videoId)}},{key:"_registerMediaElement",value:function(e){this.media=document.getElementById(e),this.media&&(u.logger.log("检测到 video 标签: ",e),this.initiator.setMediaElement(this.media))}},{key:"_initPlay",value:function(){this._reportPlayStart(),this.initiator.load()}},{key:"_reportPlayStart",value:function(){var e={i:{}};e[h.ReportField.CODE]=h.ReportCode.PLAY_START,e.i[h.ReportField.REQUEST]=1,e.i[h.ReportField.URL]=this.config.originalUrl,e.i[h.ReportField.LOAD_VISIBLE]=g.default.pageVisibility().pageVisible,this.trigger(l.default.REPORT_ONCE,e)}},{key:"_startLazyComponents",value:function(){this.lazyStartComponents.forEach(function(e){e.onStarting()})}},{key:"_stopLazyComponents",value:function(){this.lazyStartComponents.forEach(function(e){e.onStopping()})}},{key:"registerReportCallback",value:function(e,t){this.reporterController.registerModule(e,t)}},{key:"setMediaElement",value:function(e){if(u.logger.log("外部传入media element, id",e.id),!e)throw new Error("Needs video element here");var t=this.media;this.media=e,this.initiator.setMediaElement(this.media,t)}},{key:"getStatistics",value:function(){var e={cdnBytes:this.flow.CBS,p2pReceiveBytes:this.flow.PRB,p2pSendBytes:this.flow.PSB};return this.flow.reset(),"h5.huya.com"!==this.config.domain&&delete e.p2pSendBytes,e}},{key:"player",get:function(){return this._player},set:function(e){this._player=e}},{key:"rollback",get:function(){return this._rollback},set:function(e){this._rollback=e}},{key:"supportLoader",get:function(){return e.isSupported()&&!1!==this._supportLoader},set:function(e){this._supportLoader=e}},{key:"bufferLength",get:function(){var e=this.media;if(!e)return 0;var t=e.currentTime;return m.default.bufferInfo(e,t,0).len}}]),e}();r.default=T},{10:10,11:11,12:12,13:13,16:16,17:17,19:19,23:23,47:47,6:6,7:7,77:77,78:78,80:80,82:82,86:86,88:88,9:9}],80:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});r.default={isBuffered:function(e,t){try{if(e)for(var r=e.buffered,n=0;n<r.length;n++)if(t>=r.start(n)&&t<=r.end(n))return!0}catch(e){}return!1},bufferInfo:function(e,t,r){try{if(e){var n=e.buffered,i=[],a=void 0;for(a=0;a<n.length;a++)i.push({start:n.start(a),end:n.end(a)});return this.bufferedInfo(i,t,r)}}catch(e){}return{len:0,start:t,end:t,nextStart:void 0}},bufferedInfo:function(e,t,r){var n=[],i=void 0,a=void 0,o=void 0,s=void 0,l=void 0;for(e.sort(function(e,t){return e.start-t.start||t.end-e.end}),l=0;l<e.length;l++){var c=n.length;if(c){var u=n[c-1].end;e[l].start-u<r?e[l].end>u&&(n[c-1].end=e[l].end):n.push(e[l])}else n.push(e[l])}for(i=l=0,a=o=t;l<n.length;l++){var d=n[l].start,p=n[l].end;if(d<=t+r&&t<p)a=d,i=(o=p)-t;else if(t+r<d){s=d;break}}return{len:i,start:a,end:o,nextStart:s}}}},{}],81:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,null,[{key:"ab2str",value:function(e){return String.fromCharCode.apply(null,new Uint8Array(e))}},{key:"str2ab",value:function(e){for(var t=new ArrayBuffer(e.length),r=new Uint8Array(t),n=0,i=e.length;n<i;n++)r[n]=e.charCodeAt(n);return t}}]),e}();r.default=i},{}],82:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,null,[{key:"supportMSEH264Playback",value:function(){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}},{key:"supportDataType",value:function(){return"undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array&&"undefined"!=typeof DataView}},{key:"supportWebSocket",value:function(){return"WebSocket"in window||"MozWebSocket"in window}},{key:"supportRTCPeerConnection",value:function(){return!!window.RTCPeerConnection||!!(window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection||window.oRTCPeerConnection)}},{key:"supportDataChannel",value:function(){var e=window.RTCPeerConnection||window.msRTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;return function(){var t=!1;try{var r=new e(null);t="createDataChannel"in r,r.close(),r=null}catch(t){}return t}()}},{key:"supportObjectURL",value:function(){return"URL"in window&&"createObjectURL"in URL}},{key:"supportFetch",value:function(){return"fetch"in window}},{key:"supportReadableStream",value:function(){return"ReadableStream"in window}},{key:"supportMozXhr",value:function(){try{var e=new XMLHttpRequest;return e.open("GET","https://example.com",!0),(e.responseType="moz-chunked-arraybuffer")===e.responseType}catch(e){return!1}}},{key:"pageVisibility",value:function(){var e={hidden:"",visibilityChange:"",pageVisible:"",support:!0};return void 0!==document.hidden?(e.hidden="hidden",e.visibilityChange="visibilitychange"):void 0!==document.msHidden?(e.hidden="msHidden",e.visibilityChange="msvisibilitychange"):void 0!==document.webkitHidden?(e.hidden="webkitHidden",e.visibilityChange="webkitvisibilitychange"):e.support=!1,e.pageVisible=e.support?window.document[e.hidden]?"hidden":"visible":"notSupport",e}},{key:"memory",value:function(){var e="";if(performance&&performance.memory){var t=performance.memory;e=t.jsHeapSizeLimit+" | "+t.totalJSHeapSize+" | "+t.usedJSHeapSize}return e}},{key:"isFullScreen",value:function(){return!!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement)}}]),e}();r.default=i},{}],83:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="FlvParse"}return n(e,[{key:"_parseTag",value:function(e){for(var t=0,r=e.byteLength;t<r;){var n=new DataView(e,t);if(r<t+11+4)break;var i=n.getUint8(0),a=16777215&n.getUint32(0);if(t+11+a+4>e.byteLength)break;if(8===i||9===i||18===i){if(!this._containKeyFrame&&9===i&&(this._containKeyFrame=1==(n.getUint8(11)>>>4&15),this._containKeyFrame))return;t+=11+a+4}else t+=11+a+4}}},{key:"containKeyFrame",value:function(e){this._containKeyFrame=!1,this._parseTag(e);var t=this._containKeyFrame;return this._containKeyFrame=!1,t}}]),e}();r.default=i},{}],84:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.startTime=0,this.counter=0}return n(e,[{key:"sample",value:function(e){if(0===this.startTime)this.startTime=e;else{if(3e3<e-this.startTime)return parseInt(this.counter/3);this.counter+=1}return-1}}]),e}();r.default=i},{}],85:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,null,[{key:"generateCid",value:function(e){var t,r=void 0,n=void 0,i=void 0;return t=/^[a-zA-Z0-9-_]{5,40}$/.test(e)?(r=e,!1):(i=e,r=(n=e.split("?")[0].split("/"))[n.length-1],!0),{cid:r,isUrl:t,originalUrl:i}}},{key:"UUID",value:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}},{key:"myUUID",value:function(){if(window.localStorage){var t=void 0,r=parseInt(localStorage.getItem("loadTimes")||0),n=localStorage.getItem("myUUID");return n?t=n:(t=e.UUID(),localStorage.setItem("myUUID",t)),36!==t.length&&(t=e.UUID(),localStorage.setItem("myUUID",t)),localStorage.setItem("loadTimes",r+1),{UUID:t,loadTimes:r+1}}return{UUID:e.UUID(),loadTimes:-1}}}]),e}();r.default=i},{}],86:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==l(Symbol.iterator)?function(e){return void 0===e?"undefined":l(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":l(e)};function i(){}var a={trace:i,debug:i,log:i,warn:i,info:i,error:i},o=a;r.enableLogs=function(e){if(!0===e||"object"===(void 0===e?"undefined":n(e))){!function(e){for(var t=arguments.length,r=Array(1<t?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];r.forEach(function(t){var r,n;o[t]=e[t]?e[t].bind(e):(r=t,(n=self.console[r])?function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];t[0]&&(t[0]="[ QVBP2P "+r+"] > "+t[0]),n.apply(self.console,t)}:i)})}(e,"debug","log","info","warn","error");try{o.log()}catch(e){o=a}}else o=a},r.logger=o},{}],87:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._delay=t.checkDelay,this._allowLength=t.cacheLength,this.reset()}return n(e,[{key:"reset",value:function(){this._seqList=[],this._checkPoint=0,this._lastLossPoint=0,this._lossInterval=[]}},{key:"calculate",value:function(e){if(isNaN(e))return 0;var t=this._seqList,r=this._lossInterval;t.length>=this._allowLength&&t.shift(),t.push(e);for(var n=this._checkPoint,i=Math.max(0,e-this._delay);n<i;n++)if(!~t.indexOf(n)){var a=n-this._lastLossPoint-1;this._lastLossPoint=n,0<a&&(9<=r.length&&r.shift(),r.push(a))}if(this._checkPoint=n,!r.length)return 0;var o=[1,1,1,1,.8,.6,.4,.2],s=0,l=0,c=0;for(n=0,i=r.length;n<i;n++)n<i-1&&(s+=r[n]*o[n],c+=o[n]),1<=n&&(l+=r[n]*o[n-1]);return c/Math.max(s,l)}}]),e}();r.default=i},{}],88:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,null,[{key:"install",value:function(){Object.assign=Object.assign||function(e){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),r=1;r<arguments.length;r++){var n=arguments[r];if(null!=n)for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])}return t}}}]),e}();i.install(),r.default=i},{}],89:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,null,[{key:"getLogTime",value:function(){var e=new Date;return e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+"."+e.getMilliseconds()}},{key:"timestamp",value:function(){return Date.now()}}]),e}();r.default=i},{}],90:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,null,[{key:"TransformProtocol",value:function(e){var t=e.split("//");return document.location.protocol+"//"+t[1]}},{key:"GetRoomIdFromUrl",value:function(e){var t=e.match(/\/(\d+)(?=r)/);return t?t[1]:""}}]),e}();r.default=i},{}],91:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.alpha_=t,this.estimate_=r}return n(e,[{key:"sample",value:function(e){this.estimate_?this.estimate_=e*(1-this.alpha_)+this.alpha_*this.estimate_:this.estimate_=e}},{key:"getEstimate",value:function(){return this.estimate_}}]),e}();r.default=i},{}],92:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,null,[{key:"encrypt",value:function(e){for(var t=new ArrayBuffer(e.length),r=new Uint8Array(t),n=[99,117,105],i=0;i<e.length;i++)r[i]=e.codePointAt(i)^n[i%n.length];return r}},{key:"decrypt",value:function(e){for(var t="",r=[99,117,105],n=0;n<e.length;n++){var i=e[n].codePointAt(0)^r[n%r.length];t+=String.fromCodePoint(i)}return JSON.parse(t)}}]),e}();r.default=i},{}],93:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="XhrLoader"+.5*Date.now(),t&&t.xhrSetup&&(this.xhrSetup=t.xhrSetup)}return n(e,[{key:"destroy",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];this._abort=!0,this._outerAbort=e,this.abort(),this.loader=null}},{key:"abort",value:function(){var e=this.loader;e&&e.abort(),window.clearTimeout(this.requestTimeout),this.requestTimeout=null,window.clearTimeout(this.retryTimeout),this.retryTimeout=null}},{key:"load",value:function(e,t,r){this.context=e,this.config=t,this.callbacks=r,this.stats={trequest:Date.now(),retry:0},this.retryDelay=t.retryDelay,this.loadInternal()}},{key:"loadInternal",value:function(){var e=void 0,t=this.context,r=this.config;e="undefined"!=typeof XDomainRequest?this.loader=new XDomainRequest:this.loader=new XMLHttpRequest;var n=this.stats;n.tfirst=0,n.loaded=0;var i=this.xhrSetup,a=t.method;a||(a="GET");try{if(i)try{i(e,t.url)}catch(n){e.open(a,t.url,!r.sync),i(e,t.url)}e.readyState||e.open(a,t.url,!r.sync)}catch(r){return void this.callbacks.onError({code:e.status,text:r.message},n,t,e)}t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),t.headers&&t.headers.forEach(function(t){e.setRequestHeader(t.header,t.value)}),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.onerror=this.onerror.bind(this),t.responseType&&(e.responseType=t.responseType),this.requestTimeout=window.setTimeout(this.loadtimeout.bind(this),this.config.timeout,e),n.tsend=Date.now(),"POST"===a?e.send(t.data):e.send()}},{key:"readystatechange",value:function(e){var t=e.currentTarget,r=t.readyState,n=this.stats,i=this.context,a=this.config,o=t.status;if(!this._outerAbort&&2<=r)if(0===n.tfirst&&(n.tfirst=Math.max(Date.now(),n.trequest)),4===r)if(this.requestTimeout&&(window.clearTimeout(this.requestTimeout),this.requestTimeout=null),200<=o&&o<300){n.tload=Math.max(n.tfirst,Date.now());var s,l=void 0;s="arraybuffer"===i.responseType?(l=t.response).byteLength:(l=t.responseText).length,n.loaded=n.total=s,n.loadeds=parseInt(s*(this.context.bFix||1));var c={url:t.responseURL,data:l};this.callbacks.onSuccess(c,n,i,t)}else{if(this.callbacks.onLoadMonitor){var u={code:o,retry:n.retry};this.callbacks.onLoadMonitor(u,i)}n.retry>=a.maxRetry?this.callbacks.onError({code:o,text:t.statusText},n,i,t):(this.destroy(!1),this.retryTimeout=window.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,a.maxRetryDelay),n.retry++)}else this.config.stream&&(this.requestTimeout&&(window.clearTimeout(this.requestTimeout),this.requestTimeout=null),200===o&&2===r&&this.callbacks.onHeadLoaded&&this.callbacks.onHeadLoaded())}},{key:"loadtimeout",value:function(e){var t=this.stats,r=this.context,n=this.config,i=t.retry>=n.maxRetry;t.reachMaxRetry=i,this.callbacks.onTimeout(t,r,{readyState:e.readyState})||i||(this.destroy(!1),this.loadInternal(),t.retry+=1)}},{key:"loadprogress",value:function(e){if(!this._outerAbort){var t=e.target.response,r=this.callbacks.onProgress;r&&r(t)}}},{key:"onerror",value:function(){this.callbacks.onLoadError&&this.callbacks.onLoadError()}}]),e}();r.default=i},{}]},{},[22])(22)},"object"==l(t)&&void 0!==e?e.exports=s():(i=[],void 0===(a="function"==typeof(n=s)?n.apply(t,i):n)||(e.exports=a))}).call(t,r(12))}});
//# sourceMappingURL=http://fedci.dz11.com:4567/live_player/online/sourcemaps/2_5fd1e37.js.map
//# sourceMappingURL=2_5fd1e37.js.map