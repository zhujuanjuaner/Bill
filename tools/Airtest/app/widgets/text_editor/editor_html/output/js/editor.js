function confirmDialog(e,t,r,i){e.openConfirm?e.openConfirm(t,i):confirm(r)&&i[0]()}var editor=CodeMirror(document.body),doReplaceConfirm="<div class='confirmInsertDiv'> Poco mode has changed. Do you want to insert poco init code at the current cursor position? <a class='dialogBtn'>Yes</a> <a class='dialogBtn'>No</a> </div>";$(function(){function e(e,t,r){editor.doc.markText(e,t,{className:"imgEditor",replacedWith:r,readonly:!0})}function t(e){function t(e){return e.replace(/#\s{0,1}/,"")}function r(e,t){"undefined"==typeof t&&(t=0);var r=e.search(/\S|$/);return r>t&&t>=0?" ".repeat(t)+"# "+e.substring(t):r>0?" ".repeat(r)+"# "+e.substring(r):"# "+e}for(var i=[],n=0,o=[],d=editor.getCursor(!0),a=editor.getCursor(!1),l=void 0,c=d.line;c<=a.line;c++){var s=e.getLine(c).search(/\S|$/);"undefined"==typeof l?l=s:l>s&&s>=0&&(l=s)}for(var c=d.line;c<=a.line;c++){var g=e.getLine(c),u=$.trim(g);u.length>0&&"#"===u[0]?(i.push(t(g)),n+=1):i.push(r(g,l)),o.push(r(g,l))}e.replaceRange("\n",{line:d.line,ch:0},{line:a.line+1,ch:0}),e.setCursor({line:d.line,ch:0}),e.addTextWithImage(n==i.length||0==n?i.join("\n"):o.join("\n")),e.setCursor({line:d.line,ch:0})}CodeMirror.registerHelper("hint","python",CodeMirror.pythonHint),editor.on("keyup",function(e,t){if(editor.removeLineError(),!e.state.completionActive&&13!=t.keyCode&&27!=t.keyCode){var r=e.getDoc().getCursor(),i=e.getDoc().getLine(r.line),n=/((touch|swipe)\(Template\(.*\)\))(,\s*.*)*\)/g,o=n.exec(i);o&&!e.state.completionActive&&13!=t.keyCode&&27!=t.keyCode?o[2]&&r.ch>o.index+o[1].length&&r.ch<o.index+o[0].length&&e.showHint({hint:CodeMirror.hint.airtest,completeSingle:!1}):e.showHint({hint:CodeMirror.hint.poco,completeSingle:!1})}}),editor.removeLineError=function(){globalVariable.running_failed&&(editor.getDoc().removeLineClass(globalVariable.active_line,"background","line-error"),globalVariable.running_failed=!1)},editor.addText=function(e,t,r){editor.removeLineError(),t&&(e+="\n"),r||(r=editor.getCursor()),editor.doc.replaceRange(e,r,r),editor.setCursor({line:r.line+1,ch:0}),editor.focus()},editor.addTextWithImage=function(t,r,i){var n=editor.getCursor();editor.addText(t,r,i);for(var o=/Template\(([\u4e00-\u9fa5\w\s\+\:\/\\\._-]*\.png)(.*?[\)|\]]){0,1}\)/g,d=o.exec(t),a=new Array;null!==d&&d.length>1;){var l=document.createElement("img");l.setAttribute("class","imgClass"),a.push(l),l.setAttribute("src",d[1]),l.setAttribute("alt",d[1]),l.setAttribute("title",d[1]);var c=editor.findPosH(n,d.index,"char"),s=d[0].length,g=editor.findPosH(c,s,"char");!function(t,r,i){setTimeout(function(){e(t,r,i)},1)}(c,g,l),d=o.exec(t)}},editor.addTextWithLink=function(e,t,r){var i=editor.getCursor();editor.addText(e,t,r);for(var n=/\[([\u4e00-\u9fa5\w\s]*)\]\((http.*)\)/g,o=n.exec(e);null!==o&&o.length>1;){var d=document.createElement("a"),a=document.createTextNode(o[1]);d.setAttribute("href",o[2]),d.setAttribute("class","helpinfo"),d.appendChild(a),d.onclick=function(){return event.preventDefault(),qtbridge.openLink($(this).attr("href")),!1};var l=editor.findPosH(i,o.index,"char"),c=o[0].length,s=editor.findPosH(l,c,"char");editor.doc.markText(l,s,{className:"link",replacedWith:d}),o=n.exec(e)}},editor.on("paste",function(e,t){var r=t.clipboardData.getData("Text");-1!==r.indexOf("Template")&&(t.preventDefault(),qtbridge.paste(r))}),editor.on("change",function(e){var t=e.getDoc().getValue();qtbridge.content=t}),editor.addKeyMap({Tab:function(e){if(e.somethingSelected()){var t=editor.getSelection("\n");if(t.length>0&&(t.indexOf("\n")>-1||t.length===e.getLine(e.getCursor().line).length))return void e.indentSelection("add")}e.execCommand(e.options.indentWithTabs?"insertTab":"insertSoftTab")},"Shift-Tab":function(e){e.indentSelection("subtract")},"Ctrl-/":t,"Cmd-/":t}),CodeMirror.defineSimpleMode("consolelog",{start:[{regex:/\[\w+\]|\<\w+\>/,token:"type"},{regex:/"(?:[^\\]|\\.)*?(?:"|$)/,token:"string"},{regex:/\[(\d|\:)+\]/,token:"variable-2"},{regex:/(?:Traceback|(\w+)Error)\b/,token:"error"},{regex:/\b(?:def|var|return|if|for|while|else|do|this|python|exec|not)\b/,token:"keyword"},{regex:/0x[a-f\d]+|[-+]?(?:\.\d+|\d+\.?\d*)(?:e[-+]?\d+)?/i,token:"number"},{regex:/>>>/,token:"atom"},{regex:/\sin\b/,token:"keyword"},{regex:/\s*\w+\s*(?=\:)/,token:"keyword"},{regex:/[\u4e00-\u9fa5]+(?=\:)/,token:"variable-3"}]}),"undefined"!=typeof qt&&new QWebChannel(qt.webChannelTransport,function(e){window.qtbridge=e.objects.qtbridge,init_editor_options(editor,qtbridge.mode,qtbridge.menuLang);var t=qtbridge.fontSize;$("body").css("fontSize",t),editor.refresh(),init_editor_bridge(qtbridge.mode),qtbridge.registrationFinished()}),editor.on("dblclick",function(e,t){if(t.target){var r=$(t.target);if("imgClass"===r.attr("class")){var i=e.coordsChar({left:t.clientX,top:t.clientY}),n=e.getLine(i.line),o={line:i.line,ch:0},d={line:i.line,ch:n.length};qtbridge.modify_img(n,o,d)}}})});